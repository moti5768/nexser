<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="description" content="nexser beta version">
    <link rel="preload" as="style" href="nexser_style/nexser.css" onload="this.rel='stylesheet'">
    <title class="nexser_title">nexser beta version 1.9</title>
    <script src="nexser_scripts/error.js" defer></script>
</head>

<body>
    <div id="nex" class="nexser_group">
        <div id="prompt">
            <p>[<span class="nexser_title_text"></span>]</p>
            <div id="output"></div>
            <div id="input-container">
                <span id="prefix">&lt;user&gt;</span>
                <input autocomplete="off" type="text" id="command_input" class="name focus" name="prompt_text"
                    placeholder="command">
            </div>

            <div class="code_group"
                style="display: none; position: relative; top: 20px; left: 5px; width: 98%; height: 45vh;">
                <code>
                    <textarea id="code_html" class="white_text resize_none" style="display: none;">
                        &lt;!DOCTYPE html&gt;
&lt;html lang=&quot;ja&quot;&gt;

&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;
  &lt;meta name=&quot;description&quot; content=&quot;spreadsheet beta&quot;&gt;
  &lt;link rel=&quot;stylesheet&quot; href=&quot;spreadsheet.css&quot;&gt;
  &lt;title&gt;Excelライクスプレッドシート - 数式＆フォーマット機能付き&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;!-- ツールバー全体をまとめるコンテナ --&gt;
  &lt;div id=&quot;toolbar-container&quot;&gt;

    &lt;!-- 上段：フォーマット操作ボタン、カラーパレット、関数ボタン、セル結合ボタンなどを同一行にまとめる --&gt;
    &lt;div id=&quot;controls-row&quot;&gt;

      &lt;span class=&quot;button&quot; onclick=&quot;undo()&quot;&gt;&amp;nbsp;↺&amp;nbsp;&lt;/span&gt;
      &lt;span class=&quot;button&quot; onclick=&quot;redo()&quot;&gt;&amp;nbsp;↻&amp;nbsp;&lt;/span&gt;
      &lt;span class=&quot;button&quot; onclick=&quot;saveSpreadsheetData()&quot;&gt;保存&lt;/span&gt;
      &lt;span class=&quot;button&quot; onclick=&quot;loadSpreadsheetData()&quot;&gt;読み込む&lt;/span&gt;
      &lt;span class=&quot;button&quot; onclick=&quot;copySelectedCells()&quot;&gt;コピー&lt;/span&gt;
      &lt;span class=&quot;button&quot; onclick=&quot;pasteClipboardData()&quot;&gt;貼り付け&lt;/span&gt;
      &lt;span class=&quot;button&quot; onclick=&quot;printPage()&quot;&gt;印刷&lt;/span&gt;


      &lt;span class=&quot;button&quot; onclick=&quot;changePageSize(&#039;A4&#039;)&quot;&gt;A4&lt;/span&gt;
      &lt;span class=&quot;button&quot; onclick=&quot;changePageSize(&#039;A3&#039;)&quot;&gt;A3&lt;/span&gt;
      &lt;span class=&quot;button&quot; onclick=&quot;changePageSize(&#039;B5&#039;)&quot;&gt;B5&lt;/span&gt;
      &lt;span class=&quot;button&quot; onclick=&quot;changePageSize(&#039;B4&#039;)&quot;&gt;B4&lt;/span&gt;
      &lt;br&gt;


      &lt;!-- フォーマットツールバー --&gt;
      &lt;div id=&quot;format-toolbar&quot; style=&quot;display: flex;&quot;&gt;
        &lt;div id=&quot;text-alignment-buttons&quot;&gt;
          &lt;span class=&quot;button&quot; style=&quot;font-size: 16px;&quot; data-align=&quot;left&quot;&gt;=&amp;nbsp;&amp;nbsp;&lt;/span&gt;
          &lt;span class=&quot;button&quot; style=&quot;font-size: 16px;&quot; data-align=&quot;center&quot;&gt;&amp;nbsp;=&amp;nbsp;&lt;/span&gt;
          &lt;span class=&quot;button&quot; style=&quot;font-size: 16px;&quot; data-align=&quot;right&quot;&gt;&amp;nbsp;&amp;nbsp;=&lt;/span&gt;
        &lt;/div&gt;
        &lt;label&gt;
          &lt;select id=&quot;font-size&quot; class=&quot;button&quot; style=&quot;outline: none;&quot;&gt;
            &lt;option value=&quot;8px&quot;&gt;8&lt;/option&gt;
            &lt;option value=&quot;9px&quot;&gt;9&lt;/option&gt;
            &lt;option value=&quot;10px&quot;&gt;10&lt;/option&gt;
            &lt;option value=&quot;11px&quot;&gt;11&lt;/option&gt;
            &lt;option value=&quot;12px&quot;&gt;12&lt;/option&gt;
            &lt;option value=&quot;14px&quot;&gt;14&lt;/option&gt;
            &lt;option value=&quot;16px&quot; selected&gt;16&lt;/option&gt;
            &lt;option value=&quot;18px&quot;&gt;18&lt;/option&gt;
            &lt;option value=&quot;20px&quot;&gt;20&lt;/option&gt;
            &lt;option value=&quot;24px&quot;&gt;24&lt;/option&gt;
            &lt;option value=&quot;26px&quot;&gt;26&lt;/option&gt;
            &lt;option value=&quot;28px&quot;&gt;28&lt;/option&gt;
            &lt;option value=&quot;36px&quot;&gt;36&lt;/option&gt;
            &lt;option value=&quot;48px&quot;&gt;48&lt;/option&gt;
            &lt;option value=&quot;72px&quot;&gt;72&lt;/option&gt;
            &lt;option value=&quot;96px&quot;&gt;96&lt;/option&gt;
            &lt;option value=&quot;120px&quot;&gt;120&lt;/option&gt;
            &lt;option value=&quot;144px&quot;&gt;144&lt;/option&gt;
          &lt;/select&gt;
        &lt;/label&gt;
        &lt;span class=&quot;button&quot; id=&quot;toggle-bold&quot;&gt;&amp;nbsp;B&amp;nbsp;&lt;/span&gt;
        &lt;span class=&quot;button&quot; id=&quot;toggle-italic&quot; style=&quot;font-style: italic; font-weight: bold;&quot;&gt;&amp;nbsp;i&amp;nbsp;&lt;/span&gt;
        &lt;span class=&quot;button&quot; id=&quot;toggle-underline&quot;&gt;&amp;nbsp;&lt;span style=&quot;text-decoration: underline;&quot;&gt;U&lt;/span&gt;&amp;nbsp;&lt;/span&gt;
        &lt;span class=&quot;button&quot; id=&quot;toggle-textshadow&quot;&gt;&amp;nbsp;&lt;span
            style=&quot;text-shadow: 3px 3px black;&quot;&gt;A&lt;/span&gt;&amp;nbsp;&lt;/span&gt;
        &lt;span class=&quot;button&quot; id=&quot;vertical-align-top&quot;&gt;上揃え&lt;/span&gt;
        &lt;span class=&quot;button&quot; id=&quot;vertical-align-middle&quot;&gt;中央揃え&lt;/span&gt;
        &lt;span class=&quot;button&quot; id=&quot;vertical-align-bottom&quot;&gt;下揃え&lt;/span&gt;
        &lt;!-- 新規追加: 文字折り返し切替ボタン --&gt;
        &lt;span class=&quot;button&quot; id=&quot;toggle-text-wrap&quot;&gt;折り返し切替&lt;/span&gt;

        &lt;div class=&quot;pulldown_menu_parent&quot;&gt;
          &lt;span class=&quot;button pulldown_btn&quot;&gt;&amp;nbsp;枠線のプロパティ&amp;nbsp;&lt;/span&gt;
          &lt;ul class=&quot;pulldown_menu&quot;&gt;
            &lt;span class=&quot;button&quot; id=&quot;btnTopBorder&quot; onclick=&quot;applyTopBorder()&quot;&gt;上掛線&lt;/span&gt;
            &lt;span class=&quot;button&quot; id=&quot;btnBottomBorder&quot; onclick=&quot;applyBottomBorder()&quot;&gt;下掛線&lt;/span&gt;
            &lt;span class=&quot;button&quot; id=&quot;btnLeftBorder&quot; onclick=&quot;applyLeftBorder()&quot;&gt;左掛線&lt;/span&gt;
            &lt;span class=&quot;button&quot; id=&quot;btnRightBorder&quot; onclick=&quot;applyRightBorder()&quot;&gt;右掛線&lt;/span&gt;
            &lt;span class=&quot;button&quot; id=&quot;apply-outer-border&quot; onclick=&quot;applyOuterBorder()&quot;&gt;外枠&lt;/span&gt;
            &lt;span class=&quot;button&quot; id=&quot;apply-outer-border-bold&quot; onclick=&quot;applyOuterBorder_bold()&quot;&gt;太い外枠&lt;/span&gt;
            &lt;span class=&quot;button&quot; id=&quot;apply-cell-border&quot; onclick=&quot;applyCellBorder()&quot;&gt;セル枠&lt;/span&gt;
            &lt;span class=&quot;button&quot; id=&quot;remove-all-borders&quot; onclick=&quot;removeAllBorders()&quot;&gt;枠線解除&lt;/span&gt;
          &lt;/ul&gt;
        &lt;/div&gt;

        &lt;span class=&quot;button&quot; id=&quot;merge-cells&quot;&gt;セル結合&lt;/span&gt;
        &lt;span class=&quot;button&quot; id=&quot;unmerge-cells&quot;&gt;結合解除&lt;/span&gt;
      &lt;/div&gt;

      &lt;!-- テキスト色パレット --&gt;
      &lt;div id=&quot;text-color-palette&quot; class=&quot;pulldown_menu_parent&quot;&gt;
        &lt;span class=&quot;button pulldown_btn&quot;&gt;&amp;nbsp;A&amp;nbsp;&lt;/span&gt;
        &lt;ul class=&quot;pulldown_menu&quot;&gt;
          &lt;!-- スウォッチだけを囲むコンテナ --&gt;
          &lt;div class=&quot;swatch-container&quot;&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#000000&quot; style=&quot;background-color: #000000;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#FF0000&quot; style=&quot;background-color: #FF0000;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#00FF00&quot; style=&quot;background-color: #00FF00;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#0000FF&quot; style=&quot;background-color: #0000FF;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#FFFF00&quot; style=&quot;background-color: #FFFF00;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#FF00FF&quot; style=&quot;background-color: #FF00FF;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#00FFFF&quot; style=&quot;background-color: #00FFFF;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#808080&quot; style=&quot;background-color: #808080;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#800000&quot; style=&quot;background-color: #800000;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#008000&quot; style=&quot;background-color: #008000;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#000080&quot; style=&quot;background-color: #000080;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#808000&quot; style=&quot;background-color: #808000;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#800080&quot; style=&quot;background-color: #800080;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#008080&quot; style=&quot;background-color: #008080;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#C0C0C0&quot; style=&quot;background-color: #C0C0C0;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#ffffff&quot; style=&quot;background-color: #ffffff;&quot;&gt;&lt;/div&gt;
          &lt;/div&gt;
          &lt;!-- 「塗りつぶしなし」ボタン --&gt;
          &lt;div class=&quot;color-swatch button&quot; data-color=&quot;none&quot; style=&quot;height: 30px;&quot;&gt;塗りつぶしなし&lt;/div&gt;
          &lt;!-- 自由色ピッカー --&gt;
          &lt;div id=&quot;text-color-picker&quot; style=&quot;font-size: medium;&quot;&gt;
            &lt;label&gt;詳細: &lt;input type=&quot;color&quot; class=&quot;button&quot; id=&quot;text-color-custom&quot;&gt;&lt;/label&gt;
          &lt;/div&gt;
        &lt;/ul&gt;
      &lt;/div&gt;

      &lt;!-- セル背景色パレット --&gt;
      &lt;div id=&quot;cell-color-palette&quot; class=&quot;pulldown_menu_parent&quot;&gt;
        &lt;span class=&quot;button pulldown_btn&quot; style=&quot;background-color: black; color: whitesmoke;&quot;&gt;&amp;nbsp;A&amp;nbsp;&lt;/span&gt;
        &lt;ul class=&quot;pulldown_menu&quot;&gt;
          &lt;!-- スウォッチだけを囲むコンテナ --&gt;
          &lt;div class=&quot;swatch-container&quot;&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#000000&quot; style=&quot;background-color: #000000;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#FF0000&quot; style=&quot;background-color: #FF0000;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#00FF00&quot; style=&quot;background-color: #00FF00;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#0000FF&quot; style=&quot;background-color: #0000FF;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#FFFF00&quot; style=&quot;background-color: #FFFF00;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#FF00FF&quot; style=&quot;background-color: #FF00FF;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#00FFFF&quot; style=&quot;background-color: #00FFFF;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#808080&quot; style=&quot;background-color: #808080;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#800000&quot; style=&quot;background-color: #800000;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#008000&quot; style=&quot;background-color: #008000;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#000080&quot; style=&quot;background-color: #000080;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#808000&quot; style=&quot;background-color: #808000;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#800080&quot; style=&quot;background-color: #800080;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#008080&quot; style=&quot;background-color: #008080;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#C0C0C0&quot; style=&quot;background-color: #C0C0C0;&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;color-swatch&quot; data-color=&quot;#ffffff&quot; style=&quot;background-color: #ffffff;&quot;&gt;&lt;/div&gt;
          &lt;/div&gt;
          &lt;!-- 「塗りつぶしなし」ボタン --&gt;
          &lt;div class=&quot;color-swatch button&quot; data-color=&quot;none&quot; style=&quot;height: 30px;&quot;&gt;塗りつぶしなし&lt;/div&gt;
          &lt;!-- 自由色ピッカー --&gt;
          &lt;div id=&quot;cell-color-picker&quot; style=&quot;font-size: medium;&quot;&gt;
            &lt;label&gt;詳細: &lt;input type=&quot;color&quot; class=&quot;button&quot; id=&quot;cell-color-custom&quot;&gt;&lt;/label&gt;
          &lt;/div&gt;
        &lt;/ul&gt;
      &lt;/div&gt;

    &lt;/div&gt; &lt;!-- end #controls-row --&gt;

    &lt;!-- 関数ボタン群（Excel風グループ分け・関数名そのまま） --&gt;
    &lt;div style=&quot;display:flex; flex-wrap:wrap; gap:15px;&quot;&gt;

      &lt;!-- 数値系 --&gt;
      &lt;div class=&quot;pulldown_menu_parent&quot;&gt;
        &lt;span class=&quot;button pulldown_btn&quot;&gt;数学・統計 ▼&lt;/span&gt;
        &lt;ul class=&quot;pulldown_menu&quot;&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=SUM()&#039;)&quot;&gt;SUM&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=AVERAGE()&#039;)&quot;&gt;AVERAGE&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=MIN()&#039;)&quot;&gt;MIN&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=MAX()&#039;)&quot;&gt;MAX&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=COUNT()&#039;)&quot;&gt;COUNT&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=PRODUCT()&#039;)&quot;&gt;PRODUCT&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=ADD()&#039;)&quot;&gt;ADD&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=SUBTRACT()&#039;)&quot;&gt;SUBTRACT&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=DIVIDE()&#039;)&quot;&gt;DIVIDE&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=POWER()&#039;)&quot;&gt;POWER&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=SQRT()&#039;)&quot;&gt;SQRT&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=MOD()&#039;)&quot;&gt;MOD&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/div&gt;

      &lt;!-- 条件付き集計系 --&gt;
      &lt;div class=&quot;pulldown_menu_parent&quot;&gt;
        &lt;span class=&quot;button pulldown_btn&quot;&gt;条件付き集計 ▼&lt;/span&gt;
        &lt;ul class=&quot;pulldown_menu&quot;&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=SUMIF()&#039;)&quot;&gt;SUMIF&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=AVERAGEIF()&#039;)&quot;&gt;AVERAGEIF&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=COUNTIF()&#039;)&quot;&gt;COUNTIF&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/div&gt;

      &lt;!-- 文字列系 --&gt;
      &lt;div class=&quot;pulldown_menu_parent&quot;&gt;
        &lt;span class=&quot;button pulldown_btn&quot;&gt;文字列 ▼&lt;/span&gt;
        &lt;ul class=&quot;pulldown_menu&quot;&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=CONCAT()&#039;)&quot;&gt;CONCAT&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=UPPER()&#039;)&quot;&gt;UPPER&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=LOWER()&#039;)&quot;&gt;LOWER&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=LEFT()&#039;)&quot;&gt;LEFT&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=RIGHT()&#039;)&quot;&gt;RIGHT&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=MID()&#039;)&quot;&gt;MID&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=TRIM()&#039;)&quot;&gt;TRIM&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=LEN()&#039;)&quot;&gt;LEN&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=FIND()&#039;)&quot;&gt;FIND&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=REPLACE()&#039;)&quot;&gt;REPLACE&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/div&gt;

      &lt;!-- 論理系 --&gt;
      &lt;div class=&quot;pulldown_menu_parent&quot;&gt;
        &lt;span class=&quot;button pulldown_btn&quot;&gt;論理 ▼&lt;/span&gt;
        &lt;ul class=&quot;pulldown_menu&quot;&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=IF()&#039;)&quot;&gt;IF&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=AND()&#039;)&quot;&gt;AND&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=OR()&#039;)&quot;&gt;OR&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=NOT()&#039;)&quot;&gt;NOT&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/div&gt;

      &lt;!-- 参照系 --&gt;
      &lt;div class=&quot;pulldown_menu_parent&quot;&gt;
        &lt;span class=&quot;button pulldown_btn&quot;&gt;参照 ▼&lt;/span&gt;
        &lt;ul class=&quot;pulldown_menu&quot;&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=INDEX()&#039;)&quot;&gt;INDEX&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=MATCH()&#039;)&quot;&gt;MATCH&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=VLOOKUP()&#039;)&quot;&gt;VLOOKUP&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/div&gt;

      &lt;!-- 日付系 --&gt;
      &lt;div class=&quot;pulldown_menu_parent&quot;&gt;
        &lt;span class=&quot;button pulldown_btn&quot;&gt;日付 ▼&lt;/span&gt;
        &lt;ul class=&quot;pulldown_menu&quot;&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=DATE(2025,4,26)&#039;)&quot;&gt;DATE&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=TODAY()&#039;)&quot;&gt;TODAY&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=NOW()&#039;)&quot;&gt;NOW&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=YEAR(TODAY())&#039;)&quot;&gt;YEAR&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=MONTH(TODAY())&#039;)&quot;&gt;MONTH&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=DAY(TODAY())&#039;)&quot;&gt;DAY&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=HOUR(NOW())&#039;)&quot;&gt;HOUR&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=MINUTE(NOW())&#039;)&quot;&gt;MINUTE&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=SECOND(NOW())&#039;)&quot;&gt;SECOND&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=WEEKDAY(TODAY())&#039;)&quot;&gt;WEEKDAY&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=EDATE(TODAY(),1)&#039;)&quot;&gt;EDATE&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=DATEDIF(DATE(2025,1,1), DATE(2025,4,26), \&#039;D\&#039;)&#039;)&quot;&gt;DATEDIF&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=TIME(15,30,0)&#039;)&quot;&gt;TIME&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=TIMEVALUE(\&#039;14:30\&#039;)&#039;)&quot;&gt;TIMEVALUE&lt;/li&gt;
          &lt;li class=&quot;button&quot; onclick=&quot;applyFormula(&#039;=DATEVALUE(\&#039;1/2\&#039;)&#039;)&quot;&gt;DATEVALUE&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/div&gt;
    &lt;/div&gt;

  &lt;/div&gt;
  &lt;!-- 下段：数式バー --&gt;
  &lt;div id=&quot;formula-bar-container&quot;&gt;
    &lt;span class=&quot;border&quot; id=&quot;selected-cells-display&quot;
      style=&quot;margin-right: 8px; font-weight: bold; width: 125px; height: 28px; text-align: center; padding: 2px; background-color: whitesmoke;&quot;&gt;&lt;/span&gt;
    &lt;span class=&quot;button mark_btn cross&quot; style=&quot;margin-right: 5px;&quot; onclick=&quot;revertSelectedCellsText()&quot;&gt;&lt;/span&gt;
    &lt;span class=&quot;button mark_btn checkmark&quot; style=&quot;margin-right: 5px;&quot;&gt;&lt;/span&gt;
    &lt;input type=&quot;text&quot; id=&quot;formula-bar&quot; class=&quot;border&quot; style=&quot;margin-right: 2.5px;&quot; placeholder=&quot;数式または値を入力&quot;
      autocomplete=&quot;off&quot; /&gt;
  &lt;/div&gt;
  &lt;/div&gt;

  &lt;!-- スプレッドシート本体 --&gt;
  &lt;!-- 外側はスクロールバー用（固定サイズ、スタイルはそのまま） --&gt;
  &lt;div id=&quot;spreadsheet-container&quot; class=&quot;scroll-container&quot;&gt;
    &lt;!-- 内側の拡大縮小対象 --&gt;
    &lt;div id=&quot;spreadsheet-content&quot;&gt;
      &lt;table id=&quot;spreadsheet&quot;&gt;
        &lt;thead&gt;
          &lt;tr&gt;
            &lt;th id=&quot;corner&quot; class=&quot;button&quot;
              style=&quot;position: sticky; left: 0; z-index: 12; cursor: cell; width: 80px; font-size: large;&quot;&gt;
              allselect
            &lt;/th&gt;
          &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;
          &lt;!-- 適宜テーブルの内容を追加 --&gt;
        &lt;/tbody&gt;
      &lt;/table&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;!-- 拡大率調整バー --&gt;
  &lt;div id=&quot;zoom-toolbar&quot;&gt;
    &lt;label for=&quot;zoom-slider&quot; class=&quot;border&quot;&gt;拡大率:&lt;/label&gt;
    &lt;input type=&quot;range&quot; id=&quot;zoom-slider&quot; min=&quot;20&quot; max=&quot;200&quot; value=&quot;100&quot; step=&quot;5&quot; style=&quot;margin: 0 10px;&quot;&gt;
    &lt;span id=&quot;zoom-display&quot;&gt;100%&lt;/span&gt;
    &lt;span class=&quot;border&quot; style=&quot;margin-left: 20px;&quot;&gt;&amp;nbsp;状態:&amp;emsp;&lt;span id=&quot;loadingstate&quot;&gt;読み込み中...&lt;/span&gt;&amp;emsp;&lt;/span&gt;
    &lt;!-- プログレスバーのコンテナ --&gt;
    &lt;div id=&quot;loading-progress-container&quot;
      style=&quot;display:inline-block; vertical-align:middle; width:200px; height:20px; border:1px solid #ccc; background:#f0f0f0; margin-left:10px;&quot;&gt;
      &lt;!-- プログレスバー（初期状態は 0%） --&gt;
      &lt;div id=&quot;loading-progress-bar&quot; style=&quot;height:100%; width:0%; background:#4caf50;&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;&lt;span&gt;&amp;emsp;&lt;/span&gt;

    &lt;div id=&quot;localStorageTotal&quot;&gt;&lt;/div&gt;&lt;span&gt;&amp;emsp;&lt;/span&gt;
    &lt;div id=&quot;localStorageUsed&quot;&gt;&lt;/div&gt;&lt;span&gt;&amp;emsp;&lt;/span&gt;
    &lt;div id=&quot;localStorageRemaining&quot;&gt;&lt;/div&gt;&lt;span&gt;&amp;emsp;&lt;/span&gt;
    &lt;span class=&quot;border&quot;&gt;用紙サイズ：&amp;nbsp;&lt;span id=&quot;selectedSize&quot;&gt;A4&lt;/span&gt;&lt;/span&gt;

  &lt;/div&gt;
  &lt;script src=&quot;spreadsheet.js&quot; defer&gt;&lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
                </textarea>
                </code>

                <code>
                    <textarea id="code_script" class="white_text resize_none" style="display: none;">
                        /* リセット */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* html, body の高さを100%に設定 */
html,
body {
    height: 100%;
    touch-action: manipulation;
}

/* ボディ自体を縦方向のFlexコンテナに設定 */
body {
    display: flex;
    flex-direction: column;
}

/* ----- ツールバー全体 ----- */
/* ツールバー全体をまとめるコンテナ（HTML側でラップする必要あり） */
#toolbar-container {
    display: flex;
    flex-shrink: 0;
    flex-direction: column;
    padding: 2.5px;
    font-family: &#039;游ゴシック&#039;, &#039;Yu Gothic&#039;, &#039;Calibri&#039;, sans-serif;
    background-color: #C3C7CB;
}

/* ----- 上段：ボタン類＆カラーパレットを同じ一列に ----- */
/* このコンテナは、ボタンやパレットを横に並べる */
#controls-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 2.5px;
}

/* フォーマットツールバー（ボタン群）のスタイル */
#format-toolbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 5px;
}

#format-toolbar label {
    margin-right: 10px;
    font-size: 14px;
}

/* スウォッチコンテナ：横8個のグリッド */
.swatch-container {
    display: grid;
    grid-template-columns: repeat(8, 25px);
    gap: 3px;
    padding: 5px;
}

/* 通常スウォッチ */
.color-swatch:not(.button) {
    width: 25px;
    height: 25px;
    cursor: pointer;
    border: solid 1px;
    border-color: #eee #333 #333 #eee;
    box-sizing: border-box;
}

/* 「塗りつぶしなし」ボタン */
.color-swatch.button {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 5px;
}

/* 自由色ピッカー */
/* 自由色ピッカーを横並びに */
#text-color-picker label,
#cell-color-picker label {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    margin-top: 5px;
    /* 「詳細:」とボタンの間の隙間 */
}

/* ----- 下段：数式バー ----- */
#formula-bar-container {
    display: flex;
    width: 100%;
    font-family: &#039;游ゴシック&#039;, &#039;Yu Gothic&#039;, &#039;Calibri&#039;, sans-serif;
    background-color: #C3C7CB;
}

#formula-bar {
    width: 100%;
    height: 30px;
    font-size: 16px;
    padding: 5px;
    outline: none;
}

/* ----- 以下、既存のスプレッドシート関連スタイル ----- */

/* スプレッドシートコンテナ */
#spreadsheet-container {
    flex-grow: 1;
    width: 100%;
    border: 1px solid #ccc;
    background-color: #fff;
    overflow: auto;
    font-family: &#039;游ゴシック&#039;, &#039;Yu Gothic&#039;, &#039;Calibri&#039;, sans-serif;
}

/* テーブル全体 */
#spreadsheet {
    border-collapse: collapse;
    width: 100%;
    table-layout: fixed;
}

#spreadsheet th,
#spreadsheet td {
    width: 140px;
    height: 40px;
    padding: 0px;
    text-align: left;
    overflow: visible;
    white-space: nowrap;
    position: relative;
}

#spreadsheet td {
    cursor: cell;
    border: 1px solid #ccc;
}

#spreadsheet td.borderss {
    border: 0.1px solid black;
}

#spreadsheet td[style*=&quot;background-color&quot;]:not(.borderss) {
    border: none;
}

#spreadsheet thead th {
    font-weight: bold;
    position: sticky;
    top: 0;
    z-index: 11;
    outline: solid 2px dimgray;
}

#spreadsheet thead th:first-child {
    left: 0;
    z-index: 2;
}

#spreadsheet tbody th {
    position: sticky;
    left: 0;
    z-index: 11;
    outline: solid 2px dimgray;
}

#spreadsheet td:focus {
    outline: 2px solid #4a90e2;
}

/* 選択状態のオーバーレイ */
#spreadsheet td.selected::after {
    content: &quot;&quot;;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: steelblue;
    opacity: 0.5;
    pointer-events: none;
    z-index: 3;
}

#spreadsheet td.selected.transparent::after {
    background-color: transparent;
}

td[contenteditable=&quot;true&quot;] {
    white-space: normal;
    overflow: visible;
    text-overflow: clip;
}

#spreadsheet td[contenteditable=&quot;true&quot;].selected::after {
    opacity: 0;
}

#spreadsheet td[contenteditable=&quot;true&quot;] {
    cursor: text;
}

/* 行番号と列番号のカーソル */
th.row_number {
    cursor: e-resize;
}

th.col_number {
    cursor: s-resize;
}

td.calc-range {
    background-color: #ccffff;
}

/* ヘッダーの相対位置設定（ハンドル配置用） */
th.row_number,
th.col_number {
    position: relative;
}

/* 行番号用ハンドル */
.row-resize-handle {
    position: absolute;
    height: 5px;
    left: 0;
    right: 0;
    bottom: 0;
    cursor: ns-resize;
    background: transparent;
}

/* 列番号用ハンドル */
.col-resize-handle {
    position: absolute;
    width: 5px;
    top: 0;
    bottom: 0;
    right: 0;
    cursor: ew-resize;
    background: transparent;
}

/* フィルハンドル */
.fill-handle {
    position: absolute;
    width: 10px;
    height: 10px;
    background-color: steelblue;
    bottom: 0;
    right: 0;
    transform: translate(50%, 50%);
    cursor: crosshair;
    z-index: 1;
}

/* フィルドラッグ中のハイライト */
td.fill-selected {
    outline: 3.5px blue dashed;
}

td.selected:has(.fill-handle) {
    outline: 3.5px steelblue solid;
}

#spreadsheet td {
    white-space: pre;
    /* テキスト内の改行文字(\n)はそのまま表示（自動折り返しは行わない） */
}

.merge-highlight {
    outline: 3.5px dashed red;
}


/* pulldown_menu */
.pulldown_menu_parent {
    display: flex;
    flex-direction: column;
    gap: 2.5px;
    align-items: center;
    text-align: center;
}

.pulldown_menu {
    display: none;
    flex-direction: column;
    position: absolute;
    margin-top: 30px;
    margin-left: 60px;
    border: 1.5px solid;
    border-color: #eee #333 #333 #eee;
    padding: 5px;
    font-size: x-small;
    z-index: 20;
    background-color: #C3C7CB;
    max-height: 500px;
    overflow: auto;
}

.pulldown_menu .button {
    display: block;
}

.pulldown_menu&gt;div,
.pulldown_menu&gt;button {
    width: 100%;
}

button,
.button {
    border: solid 1px dimgray;
    color: black;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    list-style: none;
    color: black;
    background-color: #C3C7CB;
    border: 1.8px solid #808080;
    border-color: #fff #808080 #808080 #fff;
    box-shadow: 0.5px 0.5px black;
    font-weight: bold;
    font-size: small;
}

button:active,
.button.pressed {
    background-color: darkgray;
    border: 1.5px solid;
    border-color: #7a7a7a #fff #fff #7a7a7a;
    box-shadow: 0.5px 0.5px 0 #000 inset;
    transform: translate(0.6px, 0.6px);
}

.border {
    border: 1.5px solid;
    border-color: #333 #eee #eee #333;
}


.mark_btn {
    position: relative;
    box-sizing: border-box;
    width: 28px;
    height: 28px;
    align-items: center;
}

.cross::before,
.cross::after {
    content: &quot;&quot;;
    position: absolute;
    left: 10px;
    top: 4px;
    height: 18px;
    width: 2.5px;
    background-color: red;
    transform-origin: center;
}

.cross::before {
    transform: rotate(45deg);
}

.cross::after {
    transform: rotate(-45deg);
}

.pressed.cross::before,
.pressed.cross::after {
    margin-top: 1.25px;
    margin-left: 1.25px;
}


.checkmark::after {
    content: &quot;&quot;;
    position: absolute;
    left: 7px;
    top: 3px;
    width: 5px;
    height: 14px;
    border: solid forestgreen;
    border-width: 0 3px 3px 0;
    transform: rotate(45deg);
}

#zoom-toolbar {
    padding: 10px;
    display: flex;
    align-items: center;
    background-color: #C3C7CB;
}





#zoom-slider {
    appearance: none;
    height: 8px;
    background: #ddd;
    border: 1.5px solid;
    border-color: #eee #333 #333 #eee;
    height: 10px;
}

#zoom-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: silver;
    border: 1.5px solid;
    border-color: #eee #333 #333 #eee;
}

#zoom-slider::-moz-range-thumb {
    width: 15px;
    height: 15px;
    background: silver;
    border: 1.5px solid;
    border-color: #eee #333 #333 #eee;
}

/* 外側のスクロールコンテナ：スクロールバーやそのデザインを保持 */
.scroll-container {
    padding: 0;
    box-sizing: border-box;
}

#spreadsheet-content {
    /* transform, width の変更を高速に反映させるため */
    will-change: transform, width;
    /* transition を外す（不要なアニメーションが原因の場合もあるため） */
    transition: none;
    transform-origin: top left;
    /* 初期は親の幅に合わせて */
    width: 100%;
}

::-webkit-scrollbar {
    display: block;
    width: 15px;
}

::-webkit-scrollbar-track {
    background-image: radial-gradient(#CCCCCC 1.5px, #ffffff 1.5px);
    background-size: 4px 4px;
}

::-webkit-scrollbar-thumb {
    background: silver;
    border: 1.5px solid;
    border-color: #eee #333 #333 #eee;
}

::-webkit-scrollbar-button {
    background: silver;
    border: 1.5px solid;
    border-color: #eee #333 #333 #eee;
}

::-webkit-scrollbar-corner {
    background: silver;
}

body::-webkit-scrollbar {
    display: none;
}

@media print {

    @page {
        margin: 0mm;
    }

    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    /* ページ内の全要素を非表示にする */

    #toolbar-container,
    #formula-bar-container,
    #zoom-toolbar {
        display: none;
    }

    #spreadsheet td {
        border: none;
    }

    /* 印刷したいエリアとその子要素だけ表示 */
    #tbody * {
        visibility: visible;
    }

    tr&gt;td {
        visibility: visible;
        opacity: 1;
        z-index: 99999;
    }

    .row_number {
        display: none;
    }

    thead {
        display: none;
    }

    .selected::after {
        visibility: hidden;
    }

    td.fill-selected {
        opacity: 0;
    }

    td.selected:has(.fill-handle) {
        opacity: 0;
    }

    /* 印刷するエリアを画面の左上に配置 */
    #spreadsheet {
        position: absolute;
        left: 0;
        top: 0;
    }

}
                </textarea>
                </code>

                <code>
                    <textarea id="code_script2" class="white_text resize_none" style="display: none;">
                        let supportsPassive = false;
try {
    const opts = { passive: false, get passive() { supportsPassive = true; return false; } };
    window.addEventListener(&quot;testPassive&quot;, null, opts);
    window.removeEventListener(&quot;testPassive&quot;, null, opts);
} catch (e) { }

document.addEventListener(&#039;wheel&#039;, function (e) {
    if (e.ctrlKey) {
        e.preventDefault();
    }
}, { passive: false });
document.addEventListener(&#039;touchmove&#039;, function (e) {
    if (e.touches.length &gt; 1) {
        e.preventDefault();
    }
}, { passive: false });

let currentPressedButton = null;

// ボタン上でマウスダウンがあった場合
document.addEventListener(&quot;mousedown&quot;, (e) =&gt; {
    const btn = e.target.closest(&quot;.button&quot;);
    if (btn) {
        btn.classList.add(&quot;pressed&quot;);
        currentPressedButton = btn; // 現在操作中のボタンを記録
    }
});

// ボタン上または画面上のどこかでマウスアップがあった場合
document.addEventListener(&quot;mouseup&quot;, () =&gt; {
    if (currentPressedButton) {
        currentPressedButton.classList.remove(&quot;pressed&quot;);
        currentPressedButton = null;
    }
});

// カーソル移動でボタン上かどうかをチェック
document.addEventListener(&quot;mousemove&quot;, (e) =&gt; {
    if (currentPressedButton) {
        const rect = currentPressedButton.getBoundingClientRect();
        // カーソルがボタン領域外にあるかチェック
        if (e.clientX &lt; rect.left || e.clientX &gt; rect.right ||
            e.clientY &lt; rect.top || e.clientY &gt; rect.bottom) {
            // たとえマウスは押されていても、カーソルが外れたら pressed を除去
            currentPressedButton.classList.remove(&quot;pressed&quot;);
        } else {
            // カーソルがボタン内に戻り、なおかつマウスボタンが押されている場合は pressed を復元
            if (e.buttons) {
                currentPressedButton.classList.add(&quot;pressed&quot;);
            }
        }
    }
});

function printPage() {
    window.print();
}
// 動的に@pageルールのサイズを変更する関数
function changePageSize(sizeValue) {
    let styleTag = document.getElementById(&quot;dynamicPageStyle&quot;);
    if (!styleTag) {
        styleTag = document.createElement(&quot;style&quot;);
        styleTag.id = &quot;dynamicPageStyle&quot;;
        document.head.appendChild(styleTag);
    }
    // sizeValue は &quot;A4&quot;, &quot;A3&quot;, &quot;B5&quot;, &quot;B4&quot; などを指定可能
    styleTag.textContent = &#039;@page { size: &#039; + sizeValue + &#039;; margin: 1cm; }&#039;;
    // ユーザーに選択中のサイズを分かりやすく表示する例
    document.getElementById(&quot;selectedSize&quot;).textContent = sizeValue;
}

// =======================
// Block 1: 設定関連
// =======================
const INITIAL_ROWS = 80;
const ROW_BATCH = 10;
const INITIAL_COLUMNS = 80;  // 初期列数
const COLUMN_BATCH = 10;

const container = document.getElementById(&quot;spreadsheet-container&quot;);
const spreadsheetContent = document.getElementById(&quot;spreadsheet-content&quot;);
const table = document.getElementById(&quot;spreadsheet&quot;);
const theadRow = table.querySelector(&quot;thead tr&quot;);
const tbody = table.querySelector(&quot;tbody&quot;);
const formulaBarInput = document.getElementById(&quot;formula-bar&quot;);
const loadingstate = document.getElementById(&quot;loadingstate&quot;);

let currentColumns = 0; // 現在の列数 (0-index)
let rowCount = 1;       // 次に生成する行番号 (1-index)
let activeCell = null;  // 現在選択中（または編集中）のセル
// =======================
// Block 2: 範囲選択用の変数
// =======================
let isSelecting = false;
let selectionStart = null;
let selectionEnd = null;
// =======================
// Block 3: ヘルパー関数群
// =======================

// 3-1. 0-index の列番号を Excel 風のアルファベット (A, B, &hellip;) に変換
function getColumnName(index) {
    let dividend = index + 1;
    let columnName = &#039;&#039;;
    while (dividend &gt; 0) {
        let modulo = (dividend - 1) % 26;
        columnName = String.fromCharCode(65 + modulo) + columnName;
        dividend = Math.floor((dividend - modulo) / 26);
    }
    return columnName;
}

// 3-2. 指定セルから「A1」形式の参照文字列を返す
function getCellReference(cell) {
    if (!cell || !cell.dataset) return &quot;&quot;;
    const row = cell.dataset.row;
    const col = parseInt(cell.dataset.col, 10);
    return getColumnName(col) + row;
}

// 3-3. 座標 (row, col) からセル参照を返す（rowは1-index, colは0-index）
function getCellReferenceByCoord(row, col) {
    return getColumnName(col) + row;
}

// 3-4. 現在、数式編集中かどうかを判定
function isInFormulaEdit() {
    if (document.activeElement === formulaBarInput &amp;&amp; formulaBarInput.value.trim().startsWith(&quot;=&quot;))
        return true;
    if (activeCell &amp;&amp; activeCell.isContentEditable &amp;&amp; activeCell.textContent.trim().startsWith(&quot;=&quot;))
        return true;
    return false;
}

// 3-5. 現在編集中のフィールドにセル参照文字列を「カーソル位置を保持して」挿入
function insertCellReference(ref) {
    if (!ref) return;
    const input = formulaBarInput;
    if (document.activeElement === input) {
        // 現在のカーソル位置
        const start = input.selectionStart;
        const end = input.selectionEnd;
        // カーソル位置に挿入
        input.value = input.value.slice(0, start) + ref + input.value.slice(end);
        // 挿入後カーソルを ref の末尾に移動
        const newPos = start + ref.length;
        input.setSelectionRange(newPos, newPos);
        input.focus();
    } else if (activeCell &amp;&amp; activeCell.isContentEditable) {
        document.execCommand(&#039;insertText&#039;, false, ref);
    } else if (activeCell) {
        activeCell.textContent += ref;
    }
}

// =======================
// Block 4: 行／列生成 および セル作成
// =======================

function initializeColumns(count) {
    loadColumns(count);
}

// ------------------------------------------------------
// 最適化版 loadColumns 関数
// ・新規のヘッダーセル（&lt;th&gt;）を生成して一括追加
// ・既存の tbody 内各行に対し、新規列分のセル（&lt;td&gt;）を一括追加
// ------------------------------------------------------
const COLUMN_BATCH_SIZE = 30, ROW_BATCH_SIZE = 30;
function loadColumns(count, batchSize = COLUMN_BATCH_SIZE, callback) {
    let s = currentColumns, e = s + count;
    (function batchAdd(start) {
        let end = Math.min(start + batchSize, e);
        const headerFrag = document.createDocumentFragment();
        for (let c = start; c &lt; end; c++) {
            const th = document.createElement(&#039;th&#039;);
            th.className = &quot;col_number button&quot;;
            th.textContent = getColumnName(c);
            headerFrag.appendChild(th);
        }
        theadRow.appendChild(headerFrag);
        for (const row of tbody.rows) {
            const r = row.cells[0].textContent, frag = document.createDocumentFragment();
            for (let c = start; c &lt; end; c++) {
                const td = document.createElement(&#039;td&#039;);
                td.contentEditable = &quot;false&quot;;
                td.dataset.row = r;
                td.dataset.col = c;
                frag.appendChild(td);
            }
            row.appendChild(frag);
        }
        currentColumns = end;
        if (end &lt; e) setTimeout(() =&gt; batchAdd(end), 0);
        else if (callback) callback();
    })(s);
}
// ------------------------------------------------------
// 最適化版 loadRows 関数
// ・新規の行（&lt;tr&gt;）を、行番号セル &lt;th&gt; と各 &lt;td&gt; を HTML 文字列で組み立て、一括で tbody に挿入
// ------------------------------------------------------
function loadRows(count, batchSize = ROW_BATCH_SIZE, callback) {
    let added = 0;
    (function batchAdd() {
        const batch = Math.min(batchSize, count - added);
        if (!batch) return callback &amp;&amp; callback();
        const frag = document.createDocumentFragment();
        for (let i = 0; i &lt; batch; i++, rowCount++) {
            const tr = document.createElement(&#039;tr&#039;);
            const th = document.createElement(&#039;th&#039;);
            th.className = &quot;row_number button&quot;;
            th.textContent = rowCount;
            tr.appendChild(th);
            for (let c = 0; c &lt; currentColumns; c++) {
                const td = document.createElement(&#039;td&#039;);
                td.contentEditable = &quot;false&quot;;
                td.dataset.row = rowCount;
                td.dataset.col = c;
                tr.appendChild(td);
            }
            frag.appendChild(tr);
        }
        tbody.appendChild(frag);
        added += batch;
        if (added &lt; count) setTimeout(batchAdd, 0);
        else if (callback) callback();
    })();
}
// ------------------------------------------------------
// 最適化されたセル生成用関数：HTML文字列を出力
// 各セルに対して contentEditable=&quot;false&quot; と、 
// data 属性で行番号（row）と列番号（col）を指定
// ------------------------------------------------------
const createCellHTML = (r, c) =&gt; `&lt;td contenteditable=&quot;false&quot; data-row=&quot;${r}&quot; data-col=&quot;${c}&quot;&gt;&lt;/td&gt;`;

// 以下、イベントデリゲーションを用いた処理例
// ここではテーブル全体に対してイベントを一括で設定します
const spreadsheetElem = document.getElementById(&quot;spreadsheet&quot;);

// クリックイベントのデリゲーション
spreadsheetElem.addEventListener(&quot;click&quot;, function (e) {
    // もしクリック対象の上位に&lt;td&gt;があれば取得する
    const cell = e.target.closest(&quot;td&quot;);
    if (cell &amp;&amp; spreadsheetElem.contains(cell)) {
        handleCellClick(e);
    }
});

// ダブルクリックイベントのデリゲーション
spreadsheetElem.addEventListener(&quot;dblclick&quot;, function (e) {
    const cell = e.target.closest(&quot;td&quot;);
    if (cell &amp;&amp; spreadsheetElem.contains(cell)) {
        handleCellDblClick(e);
        updateFillHandle();
    }
});

// マウスダウンイベントのデリゲーション
spreadsheetElem.addEventListener(&quot;mousedown&quot;, function (e) {
    const cell = e.target.closest(&quot;td&quot;);
    if (cell &amp;&amp; spreadsheetElem.contains(cell)) {
        handleCellMouseDown(e);
    }
});

// キーダウンイベントのデリゲーション
spreadsheetElem.addEventListener(&quot;keydown&quot;, function (e) {
    // キーボードイベントはフォーカスが当たっている要素でしか発生しないので、ここでは
    // 適切にフォーカスが移るようにしておく必要があります
    const cell = e.target.closest(&quot;td&quot;);
    if (cell &amp;&amp; spreadsheetElem.contains(cell)) {
        handleCellKeyDown(e);
    }
});

// 「blur」はバブルしないため、代わりに focusout イベントを使う
spreadsheetElem.addEventListener(&quot;focusout&quot;, function (e) {
    const cell = e.target.closest(&quot;td&quot;);
    if (cell &amp;&amp; spreadsheetElem.contains(cell)) {
        handleCellBlur(e);
    }
});

// =======================
// Block 5: セル編集／イベント処理
// =======================

let caretTimer = null;  // グローバル変数として、タイマーIDを保持

function revertSelectedCellsText() {
    const selectedCells = document.querySelectorAll(&quot;td.selected&quot;);
    let formulaForBar = &quot;&quot;;
    selectedCells.forEach(cell =&gt; {
        // 保存済みのデータがある場合に復元する
        if (cell.dataset.originalText) {
            // もし元の数式も保存しているなら、そちらを復元する
            if (cell.dataset.originalFormula) {
                cell.dataset.formula = cell.dataset.originalFormula;
                cell.innerHTML = cell.dataset.originalFormula;
                formulaForBar = cell.dataset.originalFormula;
            } else {
                cell.innerHTML = cell.dataset.originalText;
                // 数式属性があれば解除。もしくはそのままでもよい
                delete cell.dataset.formula;
                formulaForBar = cell.textContent.trim();
            }
        }
    });
    // 数式バーの更新
    if (formulaForBar) {
        formulaBarInput.value = formulaForBar;
    }
    clearCalculationRangeHighlights();
    updateAllFormulas();
}

function handleCellDblClick(e, skipFocus = false) {
    const cell = e.target;
    cell.contentEditable = &quot;true&quot;;
    // ダブルクリックで編集モードに入ったことを示すフラグをセットする
    cell.dataset.editBy = &quot;dblclick&quot;;
    // もともとの内容を保存
    cell.dataset.originalText = cell.innerHTML;
    // 数式が設定されている場合は、完全な数式（例：&quot;=SUM(N4:N16)&quot;）も保存しておく
    if (cell.dataset.formula) {
        cell.dataset.originalFormula = cell.dataset.formula;
        // 編集時はセル内に数式を表示する（または必要なら値に置き換える）
        cell.textContent = cell.dataset.formula;
        highlightCalculationRange(cell.dataset.formula);
    }
    if (!skipFocus) {
        cell.focus();
        setTimeout(() =&gt; {
            setCaretToEnd(cell);
        }, 0);
    }
    activeCell = cell;
    formulaBarInput.value = cell.dataset.formula ? cell.dataset.formula : cell.textContent;
}

function handleCellBlur(e) {
    const cell = e.target;
    // textContent で取得すれば、挿入された &quot;\n&quot; がそのまま残ります
    const newText = cell.textContent.trim();
    if (newText.startsWith(&quot;=&quot;)) {
        // 数式の場合は数式情報を保持し、評価結果をセット
        cell.dataset.formula = newText;
        cell.textContent = evaluateFormula(newText);
    } else {
        // 日付形式（例：&quot;1/2&quot; や &quot;1/2/2020&quot;）の場合の自動変換
        if (isDateFormat(newText)) {
            const parts = newText.split(&quot;/&quot;);
            let date;
            if (parts.length === 2) {
                const currentYear = new Date().getFullYear();
                date = new Date(currentYear, parseInt(parts[0], 10) - 1, parseInt(parts[1], 10));
            } else if (parts.length === 3) {
                date = new Date(parseInt(parts[2], 10), parseInt(parts[0], 10) - 1, parseInt(parts[1], 10));
            }
            if (date &amp;&amp; !isNaN(date.getTime())) {
                cell.dataset.valueType = &quot;date&quot;;
                cell.dataset.dateValue = date.getTime();  // タイムスタンプを保存
                cell.textContent = formatDate(date);        // formatDate はテキストを返すものとします
            } else {
                cell.textContent = newText;
            }
        } else {
            // 数式でも日付形式でもない場合は、既存の数式情報を削除しそのまま表示
            if (cell.dataset.formula) {
                delete cell.dataset.formula;
            }
            cell.textContent = newText;
        }
        updateAllFormulas();
    }
    // 編集モード解除
    cell.contentEditable = &quot;false&quot;;
    delete cell.dataset.editBy;
    clearCalculationRangeHighlights();
    updateAllFormulas();
}

function handleF2Key(e) {
    let targetCell = activeCell;
    if (!targetCell) {
        const selectedCells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
        if (selectedCells.length &gt; 0) {
            targetCell = selectedCells[0];
        }
    }
    if (targetCell) {
        // F2 でも、ダブルクリックと同様の処理を実行し、フラグを設定する
        targetCell.dataset.editBy = &quot;F2&quot;;
        handleCellDblClick({ target: targetCell });
    }
    e.preventDefault();
}

// === 日本語入力中制御用 ===
let isComposing = false;
document.addEventListener(&quot;compositionstart&quot;, () =&gt; isComposing = true);
document.addEventListener(&quot;compositionend&quot;, () =&gt; isComposing = false);

function handleCellKeyDown(e) {
    // &larr;追加: 日本語変換中はEnterを無視しない
    if (isComposing) return;

    if (e.key === &quot;Enter&quot; &amp;&amp; e.target.isContentEditable) {
        if (e.altKey) {
            e.preventDefault();
            document.execCommand(&#039;insertText&#039;, false, &quot;\n&quot;);
            return;
        }
        e.preventDefault();
        const row = parseInt(e.target.dataset.row, 10);
        const col = parseInt(e.target.dataset.col, 10);
        e.target.blur();
        setTimeout(() =&gt; {
            navigateToCell(row + 1, col, e);
        }, 0);
    }
}

// ※ 自身のセル（数式セルの場合）をクリックした場合は、セル参照挿入せずにデフォルト動作（caret操作）を許容する
function handleCellClick(e) {
    if (activeCell &amp;&amp; activeCell === e.target) {
        return; // 同じセルなら何もせず、通常の caret 操作を許す
    }
    if (activeCell &amp;&amp; activeCell !== e.target &amp;&amp; activeCell.isContentEditable) {
        const currentText = activeCell.textContent.trim();
        if (!currentText.startsWith(&quot;=&quot;)) {
            activeCell.blur();
        }
    }
    if (isInFormulaEdit()) {
        const ref = getCellReference(e.target);
        // 自セルクリックした場合は挿入しない
        if (!(activeCell &amp;&amp; activeCell === e.target)) {
            insertCellReference(ref);
        }
    } else {
        activeCell = e.target;
        formulaBarInput.value = activeCell.dataset.formula ? activeCell.dataset.formula : activeCell.textContent;
    }
}

function navigateToCell(row, col, event) {
    if (col &lt; 0) return;
    // 列が足りなければ列を追加
    if (col &gt;= currentColumns) {
        loadColumns(col - currentColumns + 1);
    }
    // 行が足りなければ行を追加
    if (row &gt;= rowCount) {
        loadRows(row - rowCount + 1);
    }
    const targetCell = getCell(row, col);
    if (targetCell) {
        event.preventDefault();
        // すべてのセルから selected クラスを除去
        const allCells = document.querySelectorAll(&quot;#spreadsheet tbody td&quot;);
        allCells.forEach(cell =&gt; cell.classList.remove(&quot;selected&quot;));
        // 移動先のセルをフォーカスし、selected クラスを追加
        targetCell.focus();
        activeCell = targetCell;
        activeCell.classList.add(&quot;selected&quot;);
        // 数式バーも更新
        formulaBarInput.value = activeCell.dataset.formula ? activeCell.dataset.formula : activeCell.textContent;
    }
}

/**
 * 指定された行番号と列番号に対応するセル (td 要素) を取得する
 * ※ tbody 内の各行では、cells[0] が行番号セルなので、実データは cells[col+1]
 * @param {number} row - 1始まりの行番号
 * @param {number} col - 0始まりの列番号
 * @returns {HTMLElement|null} 対象セルが存在すればその要素、なければ null
 */
function getCell(row, col) {
    if (col &gt;= currentColumns) loadColumns(col - currentColumns + 1);
    if (row &gt; rowCount) loadRows(row - rowCount);
    const r = row - 1;
    if (r &lt; 0 || r &gt;= tbody.rows.length) return null;
    const cells = tbody.rows[r].cells;
    if (col &lt; 0 || col + 1 &gt;= cells.length) return null; // cells[col+1] の存在チェック
    return cells[col + 1];
}

// =======================
// Block 6: 数式評価および自動再計算
// =======================

/*********************
* 数式で利用できるグローバル関数群（ほぼExcel互換版）
*********************/

// -----------------------
// ヘルパー関数
// -----------------------
function flattenArray(arr) {
    return arr.reduce((acc, val) =&gt; acc.concat(Array.isArray(val) ? flattenArray(val) : val), []);
}

// -----------------------
// 数値系関数
// -----------------------
function SUM() {
    const flat = flattenArray(Array.from(arguments));
    return flat.map(Number).filter(v =&gt; !isNaN(v)).reduce((a, b) =&gt; a + b, 0);
}

function AVERAGE() {
    const flat = flattenArray(Array.from(arguments));
    const nums = flat.map(Number).filter(v =&gt; !isNaN(v));
    if (nums.length === 0) return &quot;#DIV/0!&quot;;
    return nums.reduce((a, b) =&gt; a + b, 0) / nums.length;
}

function MIN() {
    const flat = flattenArray(Array.from(arguments)).map(Number).filter(v =&gt; !isNaN(v));
    return Math.min(...flat);
}

function MAX() {
    const flat = flattenArray(Array.from(arguments)).map(Number).filter(v =&gt; !isNaN(v));
    return Math.max(...flat);
}

function COUNT() {
    const flat = flattenArray(Array.from(arguments));
    return flat.filter(x =&gt; !isNaN(Number(x))).length;
}

function PRODUCT() {
    const flat = flattenArray(Array.from(arguments));
    return flat.reduce((acc, v) =&gt; acc * Number(v), 1);
}

function ADD(a, b) { return Number(a) + Number(b); }
function SUBTRACT(a, b) { return Number(a) - Number(b); }
function DIVIDE(a, b) { return Number(b) !== 0 ? Number(a) / Number(b) : &quot;#DIV/0!&quot;; }
function POWER(a, b) { return Math.pow(Number(a), Number(b)); }
function SQRT(a) { return Math.sqrt(Number(a)); }
function MOD(a, b) { return Number(a) % Number(b); }

// -----------------------
// 条件付き集計系
// -----------------------
function SUMIF(range, condition) {
    const arr = flattenArray(range);
    const condFunc = new Function(&quot;v&quot;, &quot;return v &quot; + condition);
    return arr.filter(v =&gt; condFunc(v)).reduce((a, b) =&gt; a + Number(b || 0), 0);
}

function AVERAGEIF(range, condition) {
    const arr = flattenArray(range);
    const condFunc = new Function(&quot;v&quot;, &quot;return v &quot; + condition);
    const filtered = arr.filter(v =&gt; condFunc(v));
    if (filtered.length === 0) return &quot;#DIV/0!&quot;;
    return filtered.reduce((a, b) =&gt; a + Number(b || 0), 0) / filtered.length;
}

function COUNTIF(range, condition) {
    const arr = flattenArray(range);
    const condFunc = new Function(&quot;v&quot;, &quot;return v &quot; + condition);
    return arr.filter(v =&gt; condFunc(v)).length;
}

// -----------------------
// 文字列系
// -----------------------
function CONCAT() { return Array.from(arguments).join(&quot;&quot;); }
function UPPER(text) { return String(text).toUpperCase(); }
function LOWER(text) { return String(text).toLowerCase(); }
function LEFT(text, count) { return String(text).substring(0, Number(count)); }
function RIGHT(text, count) { return String(text).slice(-Number(count)); }
function MID(text, start, count) { return String(text).substr(Number(start) - 1, Number(count)); }
function TRIM(text) { return String(text).trim(); }
function LEN(text) { return String(text).length; }
function FIND(findText, withinText) { return String(withinText).indexOf(String(findText)) + 1; }
function REPLACE(text, start, count, newText) {
    const before = String(text).substring(0, Number(start) - 1);
    const after = String(text).substring(Number(start) - 1 + Number(count));
    return before + newText + after;
}

// -----------------------
// 論理系
// -----------------------
function IF(condition, trueValue, falseValue) {
    if (typeof condition === &quot;string&quot;) {
        condition = condition.trim().toUpperCase() === &quot;TRUE&quot;;
    }
    return condition ? trueValue : falseValue;
}
function AND() {
    return Array.from(arguments).every(v =&gt; Boolean(v));
}
function OR() {
    return Array.from(arguments).some(v =&gt; Boolean(v));
}
function NOT(value) {
    return !Boolean(value);
}

// -----------------------
// 参照系（配列対応）
// -----------------------
function INDEX(array, row, col = 0) {
    if (!Array.isArray(array)) return array;
    const r = row - 1;
    if (Array.isArray(array[0])) {
        const c = col - 1;
        return (array[r] &amp;&amp; array[r][c] != null) ? array[r][c] : 0;
    }
    return array[r] != null ? array[r] : 0;
}

function MATCH(lookupValue, array, matchType = 0) {
    const flat = flattenArray(array);
    if (matchType === 0) { // 完全一致
        return flat.findIndex(v =&gt; v == lookupValue) + 1 || &quot;#N/A&quot;;
    } else if (matchType === 1) { // 小さい方で最大
        let idx = -1;
        flat.forEach((v, i) =&gt; { if (v &lt;= lookupValue) idx = i; });
        return idx + 1 || &quot;#N/A&quot;;
    } else if (matchType === -1) { // 大きい方で最小
        let idx = -1;
        flat.forEach((v, i) =&gt; { if (v &gt;= lookupValue &amp;&amp; idx === -1) idx = i; });
        return idx + 1 || &quot;#N/A&quot;;
    }
}

function VLOOKUP(lookupValue, tableArray, colIndex, rangeLookup = true) {
    for (let row of tableArray) {
        if (!Array.isArray(row)) continue;
        if (rangeLookup) {
            if (row[0] &lt;= lookupValue) return row[colIndex - 1] != null ? row[colIndex - 1] : &quot;#N/A&quot;;
        } else {
            if (row[0] == lookupValue) return row[colIndex - 1] != null ? row[colIndex - 1] : &quot;#N/A&quot;;
        }
    }
    return &quot;#N/A&quot;;
}

// -----------------------
// 日付系
// -----------------------
function DATE(year, month, day) { return new Date(year, month - 1, day); }
function TODAY() { const now = new Date(); return new Date(now.getFullYear(), now.getMonth(), now.getDate()); }
function NOW() { return new Date(); }
function YEAR(dateInput) { return new Date(dateInput).getFullYear(); }
function MONTH(dateInput) { return new Date(dateInput).getMonth() + 1; }
function DAY(dateInput) { return new Date(dateInput).getDate(); }
function HOUR(dateInput) { return new Date(dateInput).getHours(); }
function MINUTE(dateInput) { return new Date(dateInput).getMinutes(); }
function SECOND(dateInput) { return new Date(dateInput).getSeconds(); }
function WEEKDAY(dateInput) { return new Date(dateInput).getDay() + 1; }
function EDATE(dateInput, months) { const date = new Date(dateInput); date.setMonth(date.getMonth() + Number(months)); return date; }
function DATEDIF(startDate, endDate, unit) {
    const d1 = new Date(startDate); const d2 = new Date(endDate); const diff = d2.getTime() - d1.getTime();
    switch (String(unit).toLowerCase()) {
        case &quot;d&quot;: case &quot;day&quot;: return diff / (1000 * 60 * 60 * 24);
        case &quot;m&quot;: case &quot;month&quot;: return diff / (1000 * 60 * 60 * 24 * 30.436875);
        case &quot;y&quot;: case &quot;year&quot;: return diff / (1000 * 60 * 60 * 24 * 365.2425);
        default: return diff;
    }
}
function TIME(hour, minute, second) {
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, second);
}
function TIMEVALUE(timeStr) {
    const parts = timeStr.split(&quot;:&quot;);
    if (parts.length === 2 || parts.length === 3) {
        const h = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10);
        const s = parts.length === 3 ? parseInt(parts[2], 10) : 0;
        return (h * 3600 + m * 60 + s) / 86400;
    }
    return &quot;#VALUE!&quot;;
}
function DATEVALUE(dateString) {
    const parts = dateString.split(&quot;/&quot;);
    if (parts.length === 2) {
        const now = new Date();
        return new Date(now.getFullYear(), parseInt(parts[0], 10) - 1, parseInt(parts[1], 10)).getTime();
    } else if (parts.length === 3) {
        return new Date(parseInt(parts[2], 10), parseInt(parts[0], 10) - 1, parseInt(parts[1], 10)).getTime();
    }
    return &quot;#VALUE!&quot;;
}
function isDateFormat(str) { return /^\d{1,2}\/\d{1,2}(\/\d{2,4})?$/.test(str); }
function formatDate(date) { const y = date.getFullYear(), m = (date.getMonth() + 1).toString().padStart(2, &#039;0&#039;), d = date.getDate().toString().padStart(2, &#039;0&#039;); return `${y}/${m}/${d}`; }


/*********************
 * 数式の評価エンジン
 *********************/

// ───── 数式評価関数 ─────
// セル内のテキストが数式の場合は再評価して数値リテラルとして返すヘルパー関数
function getCellEvaluatedValue(cell, visited = new Set()) {
    const content = cell.textContent.trim();
    if (content.charAt(0) === &quot;=&quot;) {
        const evaluated = evaluateFormula(content, visited);
        const num = Number(evaluated);
        return isNaN(num) ? evaluated : num;
    } else {
        return parseFloat(content);
    }
}

// ────────── 前処理関数 ──────────
// IF 関数の条件部（第1引数）の中の単独の &quot;=&quot; を &quot;==&quot; に変換する
function preprocessIFFormula(expr) {
    // expr は先頭の &quot;=&quot; を除いた後の文字列、例: &quot;IF(A1 = B1, &#039;〇&#039;, &#039;&#039;)&quot;
    // ここでは IF( の直後から最初のカンマまでを条件部とみなす
    let pos = 3; // &quot;IF(&quot; の後ろから開始
    let parenCount = 0;
    let inQuote = false;
    let conditionPart = &quot;&quot;;
    for (; pos &lt; expr.length; pos++) {
        let ch = expr[pos];
        if (ch === &#039;&quot;&#039;) {
            inQuote = !inQuote;
        } else if (!inQuote) {
            if (ch === &#039;(&#039;) {
                parenCount++;
            } else if (ch === &#039;)&#039;) {
                if (parenCount &gt; 0) {
                    parenCount--;
                }
            } else if (ch === &#039;,&#039; &amp;&amp; parenCount === 0) {
                break; // 条件部の終わり
            }
        }
        conditionPart += ch;
    }
    let newCondition = conditionPart.replace(/(?&lt;![&lt;&gt;=!])=(?![=&quot;=])/g, &quot;==&quot;);
    // 結果の式を再構築: &quot;IF(&quot; + 修正済みの条件 + その後の部分
    let newExpr = &quot;IF(&quot; + newCondition + expr.substring(pos);
    return newExpr;
}

/**
 * 数式（文字列）が &quot;=&quot; から始まっている場合の評価関数
 * ・範囲参照 (例: &quot;A1:B3&quot;) &rarr; 範囲内セルの数値の合計に置換
 * ・単一セル参照 (例: &quot;A10&quot;) &rarr; そのセルの内容（数値）があれば置換、なければ 0
 * ・評価には eval を利用（グローバルに定義された関数が呼ばれる）
 */
// ---------------------------------------------
// 1. 正規表現のプリコンパイル
// ---------------------------------------------
const RANGE_REF_REGEX = /([A-Z]+\d+:[A-Z]+\d+)/g; // 例：&quot;A1:B2&quot;
const SINGLE_REF_REGEX = /([A-Z]+)(\d+)/g;         // 例：&quot;A1&quot;, &quot;B10&quot;, etc.

// ---------------------------------------------
// 2. 列変換のキャッシュ用 Map
// ---------------------------------------------
const colCache = new Map();
function columnLettersToIndex(letters) {
    // すでにキャッシュされているなら即返す
    if (colCache.has(letters)) {
        return colCache.get(letters);
    }
    let index = 0;
    for (let i = 0; i &lt; letters.length; i++) {
        index = index * 26 + (letters.charCodeAt(i) - 64);
    }
    // 0始まりにする
    let result = index - 1;
    colCache.set(letters, result);
    return result;
}

// ---------------------------------------------
// 3. 数式評価関数
// ---------------------------------------------
function evaluateFormula(formula, visited = new Set()) {
    if (!formula) return formula;
    if (formula === &quot;=&quot;) return &quot;=&quot;;
    if (formula[0] !== &quot;=&quot;) return formula;

    let expr = formula.substring(1).trim();
    if (!expr) return &quot;=&quot;;

    // 循環参照チェック (セル単位で管理)
    const cellKey = formula;
    if (visited.has(cellKey)) return &quot;#CIRCULAR!&quot;;
    visited.add(cellKey);

    try {
        if (/^IF\(/i.test(expr)) {
            expr = preprocessIFFormula(expr);
        }

        // 範囲参照置換 &rarr; 配列に変換
        expr = expr.replace(RANGE_REF_REGEX, match =&gt; {
            const [startRef, endRef] = match.split(&quot;:&quot;);
            if (!startRef || !endRef) return &quot;[]&quot;;

            const startMatch = startRef.match(/([A-Z]+)(\d+)/);
            const endMatch = endRef.match(/([A-Z]+)(\d+)/);
            if (!startMatch || !endMatch) return &quot;[]&quot;;

            const startCol = columnLettersToIndex(startMatch[1]);
            const startRow = parseInt(startMatch[2], 10);
            const endCol = columnLettersToIndex(endMatch[1]);
            const endRow = parseInt(endMatch[2], 10);

            const values = [];
            for (let r = startRow; r &lt;= endRow; r++) {
                for (let c = startCol; c &lt;= endCol; c++) {
                    const cell = getCell(r, c);
                    if (cell) {
                        const val = getCellEvaluatedValue(cell, visited);
                        values.push(val &amp;&amp; !isNaN(val) ? Number(val) : 0);
                    }
                }
            }
            return `[${values.join(&quot;,&quot;)}]`;
        });

        // 単一セル参照置換
        expr = expr.replace(SINGLE_REF_REGEX, (_, colLetters, rowStr) =&gt; {
            const colIndex = columnLettersToIndex(colLetters);
            const rowNumber = parseInt(rowStr, 10);
            const cell = getCell(rowNumber, colIndex);
            if (cell) {
                const val = getCellEvaluatedValue(cell, visited);
                return val &amp;&amp; !isNaN(val) ? Number(val) : 0;
            }
            return 0;
        });

        const result = eval(expr);
        return typeof result === &quot;function&quot; ? &quot;&quot; : result;

    } catch (e) {
        return &quot;Error: &quot; + e.message;
    } finally {
        visited.delete(cellKey);
    }
}

function updateAllFormulas() {
    const formulaCells = Array.from(document.querySelectorAll(&quot;#spreadsheet tbody td[data-formula]&quot;));
    const batchSize = 100;
    let index = 0;
    function updateBatch() {
        const batch = formulaCells.slice(index, index + batchSize);
        batch.forEach(cell =&gt; {
            // 編集中セルと数式バー編集中は更新しない
            if (document.activeElement === cell || document.activeElement === formulaBarInput) return;
            cell.textContent = evaluateFormula(cell.dataset.formula);
        });
        index += batchSize;
        if (index &lt; formulaCells.length) requestAnimationFrame(updateBatch);
    }
    updateBatch();
}

// =======================
// Block 7: 範囲選択機能および数式への反映
// =======================

function handleCellMouseDown(e) {
    // もし対象が既に編集モードなら、何もしない（ネイティブなキャレット配置を許容）
    if (e.target &amp;&amp; e.target.isContentEditable) {
        return;
    }
    // 通常の選択処理（例：選択の開始、activeCell の更新など）
    if (e.button !== 0) return;
    isSelecting = true;
    clearSelection();
    selectionStart = {
        row: parseInt(e.target.dataset.row, 10),
        col: parseInt(e.target.dataset.col, 10)
    };
    selectionEnd = { ...selectionStart };
    updateSelection();
    e.preventDefault();
    if (document.activeElement === formulaBarInput) {
        return;
    }
    if (isSelecting === true) {
        const cell = e.target;
        formulaBarInput.value = cell.dataset.formula ? cell.dataset.formula : cell.textContent;
    }
    if (document.activeElement === formulaBarInput) {
        return;
    }
    const currentText = activeCell.textContent.trim();
    if (currentText.startsWith(&quot;=&quot;)) {
        return;
    }
    activeCell = e.target;
    removeMergedCellsHighlight();
}

container.addEventListener(&quot;mousemove&quot;, function (e) {
    if (!isSelecting) return;
    if (e.target &amp;&amp; e.target.tagName &amp;&amp; e.target.tagName.toLowerCase() === &quot;td&quot;) {
        selectionEnd = {
            row: parseInt(e.target.dataset.row, 10),
            col: parseInt(e.target.dataset.col, 10)
        };
        updateSelection();
    }
});

function updateSelection() {
    if (!selectionStart || !selectionEnd) return;
    const minRow = Math.min(selectionStart.row, selectionEnd.row),
        maxRow = Math.max(selectionStart.row, selectionEnd.row),
        minCol = Math.min(selectionStart.col, selectionEnd.col),
        maxCol = Math.max(selectionStart.col, selectionEnd.col);
    const cells = document.querySelectorAll(&quot;#spreadsheet tbody td&quot;);
    if (isInFormulaEdit()) {
        clearCalculationRangeHighlights();
        const rangeRef = (minRow === maxRow &amp;&amp; minCol === maxCol)
            ? getCellReferenceByCoord(minRow, minCol)
            : getCellReferenceByCoord(minRow, minCol) + &quot;:&quot; + getCellReferenceByCoord(maxRow, maxCol);
        highlightCalculationRange(rangeRef);
        cells.forEach(cell =&gt; cell.classList.contains(&quot;selected&quot;) &amp;&amp; cell.classList.remove(&quot;selected&quot;));
        if (activeCell &amp;&amp; !activeCell.classList.contains(&quot;selected&quot;)) activeCell.classList.add(&quot;selected&quot;);
    } else {
        let anySelected = false;
        cells.forEach(cell =&gt; {
            const r = +cell.dataset.row, c = +cell.dataset.col;
            const shouldSelect = r &gt;= minRow &amp;&amp; r &lt;= maxRow &amp;&amp; c &gt;= minCol &amp;&amp; c &lt;= maxCol;
            const isSelected = cell.classList.contains(&quot;selected&quot;);

            if (shouldSelect !== isSelected) cell.classList[shouldSelect ? &quot;add&quot; : &quot;remove&quot;](&quot;selected&quot;);
            if (shouldSelect) anySelected = true;
        });
        if (activeCell) activeCell.contentEditable = anySelected ? &quot;false&quot; : &quot;true&quot;;
    }
}

function clearSelection() {
    const cells = document.querySelectorAll(&quot;#spreadsheet tbody td&quot;);
    cells.forEach(cell =&gt; cell.classList.remove(&quot;selected&quot;));
    cells.forEach(cell =&gt; cell.classList.remove(&quot;transparent&quot;));
}

document.addEventListener(&quot;mouseup&quot;, function (e) {
    if (isSelecting) {
        isSelecting = false;
        if (selectionStart &amp;&amp; selectionEnd) {
            if (selectionStart.row !== selectionEnd.row || selectionStart.col !== selectionEnd.col) {
                if (isInFormulaEdit()) {
                    const minRow = Math.min(selectionStart.row, selectionEnd.row);
                    const maxRow = Math.max(selectionStart.row, selectionEnd.row);
                    const minCol = Math.min(selectionStart.col, selectionEnd.col);
                    const maxCol = Math.max(selectionStart.col, selectionEnd.col);
                    let rangeRef = &quot;&quot;;
                    if (minRow === maxRow &amp;&amp; minCol === maxCol) {
                        rangeRef = getCellReferenceByCoord(minRow, minCol);
                    } else {
                        rangeRef = getCellReferenceByCoord(minRow, minCol) + &quot;:&quot; + getCellReferenceByCoord(maxRow, maxCol);
                    }
                    insertCellReference(rangeRef);
                }
            }
        }
        // 選択状態はそのまま保持する
    }
});

// =======================
// Block 8: 数式バーのイベント処理 および 複数セルへの反映
// =======================

function applyValueToCells(value) {
    // 数式編集中の場合は activeCell のみ更新
    if (isInFormulaEdit()) {
        if (activeCell) {
            if (value.startsWith(&quot;=&quot;)) {
                activeCell.dataset.formula = value;
                activeCell.textContent = evaluateFormula(value);
            } else {
                activeCell.textContent = value;
                delete activeCell.dataset.formula;
            }
        }
    } else {
        // 数式編集中でない場合は、selected クラスが付いたセルを対象に更新
        let targetCells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
        if (!targetCells || targetCells.length === 0) {
            if (activeCell) targetCells = [activeCell];
        }
        targetCells.forEach(cell =&gt; {
            if (value.startsWith(&quot;=&quot;)) {
                cell.dataset.formula = value;
                cell.textContent = evaluateFormula(value);
            } else {
                cell.textContent = value;
                delete cell.dataset.formula;
            }
        });
    }
    updateAllFormulas();
}

formulaBarInput.addEventListener(&quot;keydown&quot;, function (e) {
    if (e.key === &quot;Enter&quot;) {
        const value = formulaBarInput.value.trim();
        applyValueToCells(value);
        formulaBarInput.blur();
        e.preventDefault();
        activeCell.contentEditable = &quot;false&quot;;
    }
});

formulaBarInput.addEventListener(&quot;blur&quot;, function (e) {
    if (activeCell) {
        const value = formulaBarInput.value.trim();
        applyValueToCells(value);
    }
});
// =======================
// Block 9: スクロール時の動的行／列追加（安全・軽量版）
// =======================
let scrollPending = false;
let isLoadingRows = false;
let isLoadingCols = false;
container.addEventListener(&quot;scroll&quot;, () =&gt; {
    if (scrollPending) return;
    scrollPending = true;
    requestAnimationFrame(() =&gt; {
        scrollPending = false;
        // --- 端までスクロールで追加 ---
        if (!isLoadingRows &amp;&amp; container.scrollTop + container.clientHeight &gt;= container.scrollHeight - 50) {
            isLoadingRows = true;
            loadRows(ROW_BATCH, undefined, () =&gt; (isLoadingRows = false));
        }
        if (!isLoadingCols &amp;&amp; container.scrollLeft + container.clientWidth &gt;= container.scrollWidth - 50) {
            isLoadingCols = true;
            loadColumns(COLUMN_BATCH, undefined, () =&gt; (isLoadingCols = false));
        }
        // --- 可視範囲の再評価（1回だけ）---
        computeVisibleColumns();
        markInitialRowVisibility();
    });
});

// =======================
// Block 10: フォーマットツールバーのイベント処理
// =======================

// 10-1. Text Alignment
// 10-1. Text Alignment (ボタン版)
const textAlignmentButtons = document.querySelectorAll(&#039;#text-alignment-buttons .button&#039;);

textAlignmentButtons.forEach(button =&gt; {
    button.addEventListener(&quot;click&quot;, function () {
        // すべてのボタンから選択状態を解除
        textAlignmentButtons.forEach(btn =&gt; btn.classList.remove(&quot;selected&quot;));
        // クリックされたボタンに選択状態クラスを付与
        this.classList.add(&quot;selected&quot;);
        const value = this.getAttribute(&quot;data-align&quot;);
        if (activeCell) {
            const cells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
            if (cells.length &gt; 0) {
                cells.forEach(cell =&gt; cell.style.textAlign = value);
            } else {
                activeCell.style.textAlign = value;
            }
        }
    });
});

// 10-2. Font Size
let fontSizeSelect = document.getElementById(&quot;font-size&quot;);
fontSizeSelect.addEventListener(&quot;change&quot;, function (e) {
    if (activeCell) {
        let cells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
        if (cells.length &gt; 0) {
            cells.forEach(cell =&gt; cell.style.fontSize = fontSizeSelect.value);
        } else {
            activeCell.style.fontSize = fontSizeSelect.value;
        }
    }
});

// 10-3. Bold Toggle
let toggleBoldButton = document.getElementById(&quot;toggle-bold&quot;);
toggleBoldButton.addEventListener(&quot;click&quot;, function (e) {
    if (activeCell) {
        let cells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
        if (cells.length &gt; 0) {
            cells.forEach(cell =&gt; {
                cell.style.fontWeight = (cell.style.fontWeight === &quot;bold&quot;) ? &quot;normal&quot; : &quot;bold&quot;;
            });
        } else {
            activeCell.style.fontWeight = (activeCell.style.fontWeight === &quot;bold&quot;) ? &quot;normal&quot; : &quot;bold&quot;;
        }
    }
});

let toggleBoldButton2 = document.getElementById(&quot;toggle-italic&quot;);
toggleBoldButton2.addEventListener(&quot;click&quot;, function (e) {
    if (activeCell) {
        let cells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
        if (cells.length &gt; 0) {
            cells.forEach(cell =&gt; {
                cell.style.fontStyle = (cell.style.fontStyle === &quot;italic&quot;) ? &quot;normal&quot; : &quot;italic&quot;;
            });
        } else {
            activeCell.style.fontStyle = (activeCell.style.fontStyle === &quot;italic&quot;) ? &quot;normal&quot; : &quot;italic&quot;;
        }
    }
});

let toggleUnderlineButton = document.getElementById(&quot;toggle-underline&quot;);
toggleUnderlineButton.addEventListener(&quot;click&quot;, function (e) {
    if (activeCell) {
        let cells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
        if (cells.length &gt; 0) {
            const allUnderlined = Array.from(cells).every(cell =&gt; cell.style.textDecoration === &quot;underline&quot;);
            const newDecoration = allUnderlined ? &quot;none&quot; : &quot;underline&quot;;
            cells.forEach(cell =&gt; {
                cell.style.textDecoration = newDecoration;
            });
        } else {
            activeCell.style.textDecoration = (activeCell.style.textDecoration === &quot;underline&quot;) ? &quot;none&quot; : &quot;underline&quot;;
        }
    }
});


let toggletextshadowButton = document.getElementById(&quot;toggle-textshadow&quot;);
toggletextshadowButton.addEventListener(&quot;click&quot;, function (e) {
    if (activeCell) {
        let cells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
        if (cells.length &gt; 0) {
            const alltextshadow = Array.from(cells).every(cell =&gt; cell.style.textShadow === &quot;black 3px 3px&quot;);
            const newDecoration = alltextshadow ? &quot;&quot; : &quot;black 3px 3px&quot;;
            cells.forEach(cell =&gt; {
                cell.style.textShadow = newDecoration;
            });
        } else {
            activeCell.style.textShadow = (activeCell.style.textShadow === &quot;black 3px 3px&quot;) ? &quot;&quot; : &quot;black 3px 3px&quot;;
        }
    }
});

// 10-4. Text Color palette (固定カラー)
let textColorSwatches = document.querySelectorAll(&quot;#text-color-palette .color-swatch&quot;);
textColorSwatches.forEach(swatch =&gt; {
    swatch.addEventListener(&quot;click&quot;, function (e) {
        let color = swatch.dataset.color;
        let cells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
        if (cells.length &gt; 0) {
            cells.forEach(cell =&gt; {
                cell.style.color = (color === &quot;none&quot;) ? &quot;&quot; : color;
            });
        } else if (activeCell) {
            activeCell.style.color = (color === &quot;none&quot;) ? &quot;&quot; : color;
        }
    });
});

// 10-5. Custom Text Color picker
let textColorCustom = document.getElementById(&quot;text-color-custom&quot;);
textColorCustom.addEventListener(&quot;input&quot;, function (e) {
    let color = textColorCustom.value;
    let cells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
    if (cells.length &gt; 0) {
        cells.forEach(cell =&gt; {
            cell.style.color = color;
        });
    } else if (activeCell) {
        activeCell.style.color = color;
    }
});

// 10-6. Cell Background Color palette (固定カラー)
// ※ 背景色パレットの色は、テキストカラーと同じ濃さの色を使用する
let cellColorSwatches = document.querySelectorAll(&quot;#cell-color-palette .color-swatch&quot;);
cellColorSwatches.forEach(swatch =&gt; {
    swatch.addEventListener(&quot;click&quot;, function (e) {
        let color = swatch.dataset.color;
        let cells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
        if (cells.length &gt; 0) {
            cells.forEach(cell =&gt; {
                cell.style.backgroundColor = (color === &quot;none&quot;) ? &quot;&quot; : color;
            });
        } else if (activeCell) {
            activeCell.style.backgroundColor = (color === &quot;none&quot;) ? &quot;&quot; : color;
        }
    });
});

// 10-7. Custom Cell Background Color picker
let cellColorCustom = document.getElementById(&quot;cell-color-custom&quot;);
cellColorCustom.addEventListener(&quot;input&quot;, function (e) {
    let color = cellColorCustom.value;
    let cells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
    if (cells.length &gt; 0) {
        cells.forEach(cell =&gt; {
            cell.style.backgroundColor = color;
            cell.classList.add(&#039;transparent&#039;);
        });
    } else if (activeCell) {
        activeCell.style.backgroundColor = color;
        activeCell.classList.add(&#039;transparent&#039;);
    }
});

// =======================
// Block 11: セル自動編集モード切替 (キーダウンイベント)
// =======================

document.addEventListener(&quot;keydown&quot;, function (e) {
    // 既に他の入力フィールド (INPUT, TEXTAREA など) にフォーカスがある場合は無視
    const activeTag = document.activeElement.tagName;
    if (activeTag === &quot;INPUT&quot; || activeTag === &quot;TEXTAREA&quot;) {
        return;
    }

    // Ctrl キーが押されている場合は、セルへの自動編集モードの切替を行わない
    if (e.ctrlKey) {
        return;
    }

    // もし activeCell が存在し、かつまだ編集モードになっていない場合
    // なお、e.key が 1 文字の場合（印字可能なキー）にのみ反応
    if (activeCell &amp;&amp; !activeCell.isContentEditable &amp;&amp; e.key.length === 1) {
        // 自動的に編集モードにする
        activeCell.contentEditable = &quot;true&quot;;
        // 編集モードに切替えたらフォーカスを当てる
        activeCell.focus();
        // 既存の内容を削除したい場合は（Excel では初回入力で置換されることが多い）
        activeCell.textContent = &quot;&quot;;
        // 入力されたキーを現在のカーソル位置に挿入する
        document.execCommand(&#039;insertText&#039;, false, e.key);
        e.preventDefault();
    }
});

// 連続移動用タイマー（グローバル変数）
let navigationInterval = null;

document.addEventListener(&quot;keydown&quot;, function (e) {
    // 数式バーにフォーカスされていたら何もしない
    if (document.activeElement === formulaBarInput) return;

    // Tabキー判定（Shift+Tab含む）
    if (e.key === &quot;Tab&quot;) {
        let currentCell = activeCell;
        if (!currentCell) return;

        // 編集中のセルを解除（Excelと同じ挙動）
        if (currentCell.isContentEditable) {
            currentCell.contentEditable = &quot;false&quot;;
            delete currentCell.dataset.editBy;
        }

        let row = parseInt(currentCell.dataset.row, 10);
        let col = parseInt(currentCell.dataset.col, 10);

        // 左右移動
        let targetCol = e.shiftKey ? col - 1 : col + 1;
        let targetRow = row;

        // 列が足りなければ追加
        if (targetCol &gt;= currentColumns) {
            loadColumns(targetCol - currentColumns + 1);
        }

        // 左端で Shift+Tab した場合は上の行の最後列に移動
        if (targetCol &lt; 0) {
            targetRow = row - 1;
            if (targetRow &lt; 1) targetRow = 1;
            targetCol = currentColumns - 1;
        }

        const targetCell = getCell(targetRow, targetCol);
        if (targetCell) {
            navigateToCell(targetRow, targetCol, e);
            updateFillHandle();
        }

        e.preventDefault();
        return; // Tab処理完了で他の処理をスキップ
    }

    // 既存の矢印キー / Enter 判定
    const arrowKeys = [&quot;ArrowUp&quot;, &quot;ArrowDown&quot;, &quot;ArrowLeft&quot;, &quot;ArrowRight&quot;];
    const navigationKeys = [...arrowKeys, &quot;Enter&quot;];
    if (!navigationKeys.includes(e.key)) return;

    // 編集中 (contentEditable) のセルならキャレット操作を優先
    if (document.activeElement &amp;&amp; document.activeElement.isContentEditable) {
        const cellText = document.activeElement.textContent.trim();
        if (
            cellText.startsWith(&quot;=&quot;) ||
            document.activeElement.dataset.editBy === &quot;dblclick&quot; ||
            document.activeElement.dataset.editBy === &quot;F2&quot;
        ) {
            return;
        }
    }

    let currentCell2 = activeCell;
    if (!currentCell2 &amp;&amp; document.activeElement &amp;&amp; document.activeElement.tagName === &quot;TD&quot;) {
        currentCell2 = document.activeElement;
        activeCell = currentCell2;
    }
    if (!currentCell2) return;

    if (document.activeElement.isContentEditable) {
        document.activeElement.blur();
    }

    doMove(e);

    if (arrowKeys.includes(e.key)) {
        if (!navigationInterval) {
            navigationInterval = setInterval(() =&gt; {
                doMove(e);
            }, 100);
        }
    }

    e.preventDefault();
});

document.addEventListener(&quot;keyup&quot;, function (e) {
    const arrowKeys = [&quot;ArrowUp&quot;, &quot;ArrowDown&quot;, &quot;ArrowLeft&quot;, &quot;ArrowRight&quot;];
    if (arrowKeys.includes(e.key)) {
        if (navigationInterval) {
            clearInterval(navigationInterval);
            navigationInterval = null;
        }
    }
});

/**
 * doMove(e)
 *
 * 現在の activeCell（結合セルの場合はアンカー情報も考慮）から移動先セルの座標を計算し、
 * getVisibleCell() で表示されているセル（アンカーセル）を取得した上で、navigateToCell() と
 * updateFillHandle() を実行します。さらに、スクロールコンテナ（#spreadsheet-container）内で
 * 隣接セルの位置をチェックし、見切れていれば即時更新（behavior:&quot;auto&quot;）でスクロール補正します。
 */
function doMove(e) {
    let currentCell = activeCell;
    if (!currentCell) return;

    // 現在のセルの座標（data-row, data-col）を取得
    let currentRow = parseInt(currentCell.dataset.row, 10);
    let currentCol = parseInt(currentCell.dataset.col, 10);

    // 結合セルの場合、merge関連情報（mergeMin～mergeMax）があればアンカーを使用
    let rs = parseInt(currentCell.getAttribute(&quot;rowspan&quot;)) || 1;
    let cs = parseInt(currentCell.getAttribute(&quot;colspan&quot;)) || 1;
    if (currentCell.dataset.mergeMinRow) {
        currentRow = parseInt(currentCell.dataset.mergeMinRow, 10);
        currentCol = parseInt(currentCell.dataset.mergeMinCol, 10);
        rs = parseInt(currentCell.dataset.mergeMaxRow, 10) - currentRow + 1;
        cs = parseInt(currentCell.dataset.mergeMaxCol, 10) - currentCol + 1;
    }

    // 移動先セルの座標を計算
    let targetRow = currentRow;
    let targetCol = currentCol;
    if (e.key === &quot;Enter&quot; || e.key === &quot;ArrowDown&quot;) {
        targetRow = currentRow + rs;
    } else if (e.key === &quot;ArrowRight&quot;) {
        targetCol = currentCol + cs;
    } else if (e.key === &quot;ArrowLeft&quot;) {
        targetCol = currentCol - 1;
    } else if (e.key === &quot;ArrowUp&quot;) {
        targetRow = currentRow - 1;
    }

    // Helper: 指定された (row, col) のセルが非表示なら、mergeAnchor情報を辿って見えるセル（アンカー）を返す
    function getVisibleCell(row, col) {
        let cell = getCell(row, col);
        while (
            cell &amp;&amp;
            cell.style.display === &quot;none&quot; &amp;&amp;
            cell.dataset.mergeAnchorRow &amp;&amp;
            cell.dataset.mergeAnchorCol
        ) {
            row = parseInt(cell.dataset.mergeAnchorRow, 10);
            col = parseInt(cell.dataset.mergeAnchorCol, 10);
            cell = getCell(row, col);
        }
        return cell;
    }

    let visibleTarget = getVisibleCell(targetRow, targetCol);
    if (!visibleTarget) return;

    // セル移動（navigateToCell() は不足行・列があれば自動生成する既存の機能とする）
    navigateToCell(
        parseInt(visibleTarget.dataset.row, 10),
        parseInt(visibleTarget.dataset.col, 10),
        e
    );
    updateFillHandle();

    // スクロール補正
    if (container) {
        const contRect = container.getBoundingClientRect();
        const cellRect = visibleTarget.getBoundingClientRect();

        // 横方向
        if (e.key === &quot;ArrowLeft&quot;) {
            let leftCell = getCell(
                parseInt(visibleTarget.dataset.row, 10),
                parseInt(visibleTarget.dataset.col, 10) - 1
            );
            if (leftCell) {
                let leftRect = leftCell.getBoundingClientRect();
                if (leftRect.left &lt; contRect.left) {
                    container.scrollBy({ left: -leftCell.offsetWidth, behavior: &quot;auto&quot; });
                }
            }
        } else if (e.key === &quot;ArrowRight&quot;) {
            let rightCell = getCell(
                parseInt(visibleTarget.dataset.row, 10),
                parseInt(visibleTarget.dataset.col, 10) + 1
            );
            if (rightCell) {
                let rightRect = rightCell.getBoundingClientRect();
                if (rightRect.right &gt; contRect.right) {
                    container.scrollBy({ left: rightCell.offsetWidth, behavior: &quot;auto&quot; });
                }
            }
        }

        // 縦方向は、隣接する「もう1つ上／下のセル」をチェックして補正
        if (e.key === &quot;ArrowUp&quot;) {
            let aboveCell = getCell(
                parseInt(visibleTarget.dataset.row, 10) - 1,
                parseInt(visibleTarget.dataset.col, 10)
            );
            if (aboveCell) {
                let aboveRect = aboveCell.getBoundingClientRect();
                if (aboveRect.top &lt; contRect.top) {
                    container.scrollBy({ top: -aboveCell.offsetHeight, behavior: &quot;auto&quot; });
                }
            }
        } else if (e.key === &quot;ArrowDown&quot; || e.key === &quot;Enter&quot;) {
            let belowCell = getCell(
                parseInt(visibleTarget.dataset.row, 10) + 1,
                parseInt(visibleTarget.dataset.col, 10)
            );
            if (belowCell) {
                let belowRect = belowCell.getBoundingClientRect();
                if (belowRect.bottom &gt; contRect.bottom) {
                    container.scrollBy({ top: belowCell.offsetHeight, behavior: &quot;auto&quot; });
                }
            }
        }
    }

    document.querySelectorAll(&#039;#spreadsheet tbody td&#039;).forEach(td =&gt; {
        td.classList.remove(&#039;transparent&#039;);
    });

}





document.addEventListener(&quot;keydown&quot;, function (e) {
    if (e.key === &quot;F2&quot;) {

        let targetCell = activeCell;
        if (!targetCell) {
            const selectedCells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
            if (selectedCells.length &gt; 0) {
                targetCell = selectedCells[0];
            }
        }
        if (targetCell) {
            // ダブルクリック時と同じ編集モードに入る処理を実行
            handleCellDblClick({ target: targetCell });
            updateFillHandle();
        }
        e.preventDefault();
        handleF2Key(e);
        return;
    }

    // ESC キーを判別（e.key が &quot;Escape&quot; または e.keyCode が 27）
    if (e.key === &quot;Escape&quot; || e.keyCode === 27) {
        // 編集中のセルを取得（contenteditable が true のもの）
        const editingCell = document.querySelector(&quot;td[contenteditable=&#039;true&#039;]&quot;);
        if (editingCell) {
            // 編集モード解除
            editingCell.contentEditable = &quot;false&quot;;
            updateFillHandle();
            e.preventDefault();
        }
    }
});




function setCaretToEnd(el) {
    if (typeof window.getSelection !== &quot;undefined&quot; &amp;&amp; typeof document.createRange !== &quot;undefined&quot;) {
        var range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false); // false にすることで、カーソルを末尾へ
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    } else if (typeof document.body.createTextRange !== &quot;undefined&quot;) {
        var textRange = document.body.createTextRange();
        textRange.moveToElementText(el);
        textRange.collapse(false);
        textRange.select();
    }
}


// =======================
// Block X: 枠線適用機能 (Border Application Functions)
// =======================

// 【外枠適用】
function applyOuterBorderWithWidth(borderWidth) {
    const selectedCells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
    if (!selectedCells.length) return;
    let minRow = Infinity, maxRow = -Infinity, minCol = Infinity, maxCol = -Infinity;
    selectedCells.forEach(cell =&gt; {
        const row = +cell.dataset.row;
        const col = +cell.dataset.col;
        minRow = Math.min(minRow, row);
        maxRow = Math.max(maxRow, row);
        minCol = Math.min(minCol, col);
        maxCol = Math.max(maxCol, col);
    });
    selectedCells.forEach(cell =&gt; {
        const row = +cell.dataset.row;
        const col = +cell.dataset.col;
        if (row === minRow) cell.style.borderTop = `${borderWidth}px solid black`;
        if (row === maxRow) cell.style.borderBottom = `${borderWidth}px solid black`;
        if (col === minCol) cell.style.borderLeft = `${borderWidth}px solid black`;
        if (col === maxCol) cell.style.borderRight = `${borderWidth}px solid black`;
    });
}
// 通常枠
function applyOuterBorder() {
    applyOuterBorderWithWidth(3.5);
}
// 太枠
function applyOuterBorder_bold() {
    applyOuterBorderWithWidth(8);
}

// 選択範囲の上側（最小行側）のセルに各掛線を適用
function applyBorderOnEdge(direction, borderWidth = 3.5) {
    const selectedCells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
    if (!selectedCells.length) return;
    let edgeValue = direction === &#039;top&#039; || direction === &#039;left&#039; ? Infinity : -Infinity;
    selectedCells.forEach(cell =&gt; {
        const value = +(direction === &#039;top&#039; || direction === &#039;bottom&#039; ? cell.dataset.row : cell.dataset.col);
        if (direction === &#039;top&#039; || direction === &#039;left&#039;) {
            edgeValue = Math.min(edgeValue, value);
        } else {
            edgeValue = Math.max(edgeValue, value);
        }
    });
    selectedCells.forEach(cell =&gt; {
        const value = +(direction === &#039;top&#039; || direction === &#039;bottom&#039; ? cell.dataset.row : cell.dataset.col);
        if (value === edgeValue) {
            const styleProp = `border${direction[0].toUpperCase()}${direction.slice(1)}`;
            cell.style[styleProp] = `${borderWidth}px solid black`;
        }
    });
}
const applyTopBorder = () =&gt; applyBorderOnEdge(&#039;top&#039;);
const applyBottomBorder = () =&gt; applyBorderOnEdge(&#039;bottom&#039;);
const applyLeftBorder = () =&gt; applyBorderOnEdge(&#039;left&#039;);
const applyRightBorder = () =&gt; applyBorderOnEdge(&#039;right&#039;);

// 【各セル枠適用】
function applyCellBorder() {
    const selectedCells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
    if (selectedCells.length === 0) return;
    selectedCells.forEach(cell =&gt; {
        cell.style.borderTop = &quot;3.5px solid black&quot;;
        cell.style.borderBottom = &quot;3.5px solid black&quot;;
        cell.style.borderLeft = &quot;3.5px solid black&quot;;
        cell.style.borderRight = &quot;3.5px solid black&quot;;
    });
}

// =======================
// Block X: 枠線適用ボタン用のイベントリスナー
// =======================

let applyOuterBorderButton = document.getElementById(&quot;apply-outer-border&quot;);
applyOuterBorderButton.addEventListener(&quot;click&quot;, function (e) {
    applyOuterBorder();
});

let applyOuterBorderButton2 = document.getElementById(&quot;apply-outer-border-bold&quot;);
applyOuterBorderButton2.addEventListener(&quot;click&quot;, function (e) {
    applyOuterBorder_bold();
});

let applyCellBorderButton = document.getElementById(&quot;apply-cell-border&quot;);
applyCellBorderButton.addEventListener(&quot;click&quot;, function (e) {
    applyCellBorder();
});
// =======================
// Block X: 枠線解除機能 (Combined Border Removal Function)
// =======================

function removeAllBorders() {
    const selectedCells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
    if (selectedCells.length === 0) return;
    selectedCells.forEach(cell =&gt; {
        cell.style.borderTop = &quot;&quot;;
        cell.style.borderBottom = &quot;&quot;;
        cell.style.borderLeft = &quot;&quot;;
        cell.style.borderRight = &quot;&quot;;
    });
}

// =======================
// Block X: 枠線解除ボタン用のイベントリスナー（統合版）
// =======================

let removeAllBordersButton = document.getElementById(&quot;remove-all-borders&quot;);
removeAllBordersButton.addEventListener(&quot;click&quot;, function (e) {
    removeAllBorders();
});


document.addEventListener(&quot;keydown&quot;, function (e) {
    if (document.activeElement === formulaBarInput) {
        return;
    }
    // もし現在フォーカスされている要素が編集モードの場合は、通常の一文字削除（デフォルト動作）を行うため何もしない
    if (document.activeElement &amp;&amp; document.activeElement.isContentEditable) {
        return;
    }
    // Backspace または Delete キーが押された場合の処理（編集モードでないとき）
    if (e.key === &quot;Backspace&quot; || e.key === &quot;Delete&quot;) {
        // 複数セルが選択されている場合（selected クラスが付いているセル群）を優先して対象とする
        const selectedCells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);

        if (selectedCells.length &gt; 0) {
            // 選択されている複数のセルすべての内容と、保持している数式データなどをクリアする
            selectedCells.forEach(cell =&gt; {
                cell.textContent = &quot;&quot;;
                if (cell.dataset.formula) {
                    delete cell.dataset.formula;
                }
                // 編集モードでなくても念のため contentEditable を false に設定
                cell.contentEditable = &quot;false&quot;;
            });
        } else if (activeCell) {
            // 複数選択がなければ、activeCell に対して同様の処理を行う
            activeCell.textContent = &quot;&quot;;
            if (activeCell.dataset.formula) {
                delete activeCell.dataset.formula;
            }
            activeCell.contentEditable = &quot;false&quot;;
        }
        updateFillHandle();
        // 標準の Backspace / Delete のブラウザ動作（ページ戻り等）を防止
        e.preventDefault();
        formulaBarInput.value = &quot;&quot;;
    }
});

// 例：セル参照（例 &quot;A1&quot;）を { row, col } に変換する（0-index と想定）
function parseCellReference(ref) {
    const match = ref.match(/^([A-Z]+)(\d+)$/);
    if (!match) return null;

    // 修正ここ: すでに定義済みの columnLettersToIndex 関数を使用して、
    // 複数文字の列番号も正しく変換する
    const col = columnLettersToIndex(match[1]);
    const row = parseInt(match[2], 10);
    return { row, col };
}

// 例：範囲指定（例 &quot;A1:B3&quot;）を { start: {row, col}, end: {row, col} } に変換する
function parseRangeReference(rangeRef) {
    const parts = rangeRef.split(&quot;:&quot;);
    if (parts.length !== 2) return null;
    const start = parseCellReference(parts[0]);
    const end = parseCellReference(parts[1]);
    if (!start || !end) return null;
    return { start, end };
}

// セルの DOM 要素を取得する（data-row と data-col 属性で識別する例）
function getCellElement(row, col) {
    return document.querySelector(`#spreadsheet td[data-row=&quot;${row}&quot;][data-col=&quot;${col}&quot;]`);
}

// 既存のクリア処理（背景色クリア）を、以下のように outline のクリアに変更
function clearCalculationRangeHighlights() {
    const cells = document.querySelectorAll(&quot;#spreadsheet td&quot;);
    cells.forEach(cell =&gt; {
        cell.style.outline = &quot;&quot;;
    });
}

// 数式内の計算対象グループごとにセルの背景色を設定する関数
function highlightCalculationRange(formula) {
    clearCalculationRangeHighlights();

    const palette = [&quot;blue&quot;, &quot;red&quot;, &quot;yellowgreen&quot;, &quot;purple&quot;, &quot;yellow&quot;, &quot;blueviolet&quot;, &quot;mediumvioletred&quot;];
    let groups = formula.includes(&quot;,&quot;)
        ? formula.split(&quot;,&quot;).map(s =&gt; s.trim()).filter(Boolean)
        : [...new Set((formula.match(/[A-Z]+\d+(?::[A-Z]+\d+)?/g) || []))];

    for (let i = 0; i &lt; groups.length; i++) {
        const color = palette[i % palette.length];
        const refs = groups[i].match(/[A-Z]+\d+(?::[A-Z]+\d+)?/g) || [];
        for (let ref of refs) {
            if (ref.includes(&quot;:&quot;)) {
                const range = parseRangeReference(ref);
                if (!range) continue;
                for (let r = range.start.row; r &lt;= range.end.row; r++) {
                    for (let c = range.start.col; c &lt;= range.end.col; c++) {
                        const cell = getCellElement(r, c);
                        if (cell) cell.style.outline = `5px solid ${color}`;
                    }
                }
            } else {
                const pos = parseCellReference(ref);
                if (!pos) continue;
                const cell = getCellElement(pos.row, pos.col);
                if (cell) cell.style.outline = `5px solid ${color}`;
            }
        }
    }
}

// 数式バーをクリック（またはフォーカス）した際に、バーに数式があれば計算対象セル範囲をハイライト
formulaBarInput.addEventListener(&quot;click&quot;, function () {
    const formulaText = formulaBarInput.value.trim();
    if (formulaText &amp;&amp; formulaText.startsWith(&quot;=&quot;)) {
        highlightCalculationRange(formulaText);
    } else {
        clearCalculationRangeHighlights();
    }
    activeCell.style.outline = &quot;solid 3.5px steelblue&quot;;
});

formulaBarInput.addEventListener(&quot;focus&quot;, function () {
    handleCellDblClick({ target: activeCell }, true); // フォーカスはセルに当てない
    updateFillHandle();
});

formulaBarInput.addEventListener(&quot;input&quot;, function () {
    const formulaText = formulaBarInput.value.trim();
    if (formulaText &amp;&amp; formulaText.startsWith(&quot;=&quot;)) {
        highlightCalculationRange(formulaText);
    } else {
        clearCalculationRangeHighlights();
    }
    if (formulaText === &#039;{&quot;mergecell&quot;}&#039;) {
        highlightMergedCells();
    } else {
        removeMergedCellsHighlight();
    }
    const formulaText2 = formulaBarInput.value;
    const selectedCells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);

    selectedCells.forEach(cell =&gt; {
        cell.textContent = formulaText2;
        cell.style.outline = &quot;solid 2px steelblue&quot;;
    });
});

function highlightMergedCells() {
    // シート内の全セルを取得
    const cells = document.querySelectorAll(&quot;#spreadsheet tbody td&quot;);
    cells.forEach(cell =&gt; {
        // rowspan, colspan 属性の値を数値で取得（属性が無ければ 1 とする）
        const rowSpan = cell.getAttribute(&quot;rowspan&quot;) ? parseInt(cell.getAttribute(&quot;rowspan&quot;), 10) : 1;
        const colSpan = cell.getAttribute(&quot;colspan&quot;) ? parseInt(cell.getAttribute(&quot;colspan&quot;), 10) : 1;
        // 結合セルとみなす条件
        const isMerged = (rowSpan &gt; 1 || colSpan &gt; 1) || (cell.dataset.mergeMinRow &amp;&amp; cell.dataset.mergeMinCol);
        if (isMerged) {
            cell.classList.add(&quot;merge-highlight&quot;);
        }
    });
}

function removeMergedCellsHighlight() {
    const highlighted = document.querySelectorAll(&quot;#spreadsheet tbody td.merge-highlight&quot;);
    highlighted.forEach(cell =&gt; cell.classList.remove(&quot;merge-highlight&quot;));
}

document.addEventListener(&quot;input&quot;, e =&gt; {
    const t = e.target;
    if (t?.matches(&quot;td[contenteditable=&#039;true&#039;]&quot;)) {
        const val = t.textContent.trim();
        val.startsWith(&quot;=&quot;) ? highlightCalculationRange(val) : clearCalculationRangeHighlights();
        formulaBarInput.value = t.textContent;
    }
    debouncedSaveState();
});

// 数式バーにフォーカスが入ったタイミングでも同様の処理を行う場合はこちらも追加（任意）
formulaBarInput.addEventListener(&quot;focus&quot;, function () {
    const formulaText = formulaBarInput.value.trim();
    if (formulaText &amp;&amp; formulaText.startsWith(&quot;=&quot;)) {
        highlightCalculationRange(formulaText);
    }
});

// 数式バーからフォーカスが外れたら、ハイライトをクリア
formulaBarInput.addEventListener(&quot;blur&quot;, function () {
    clearCalculationRangeHighlights();
});

// keydown イベント：この段階で先に抑制する（キャプチャフェーズでの実行）
document.addEventListener(
    &quot;keydown&quot;,
    function (e) {
        if (e.ctrlKey &amp;&amp; e.key.toLowerCase() === &quot;a&quot;) {
            if (document.activeElement === formulaBarInput) {
                return;
            }
            // 編集モード中（contentEditable）のセル内なら、
            // デフォルトのテキスト選択（セル内全選択）に任せ、セル全体の選択は行わない
            if (document.activeElement &amp;&amp; document.activeElement.isContentEditable) {
                return;
            }
            // 早期にキャンセル
            e.preventDefault();
            e.stopImmediatePropagation();

            // 編集中ならまず blur() で解除
            if (document.activeElement &amp;&amp; document.activeElement.isContentEditable) {
                document.activeElement.blur();
            }

            // 全セル選択の処理
            const previouslySelected = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
            previouslySelected.forEach((cell) =&gt; {
                cell.classList.remove(&quot;selected&quot;);
            });
            const allCells = document.querySelectorAll(&quot;#spreadsheet tbody td&quot;);
            allCells.forEach((cell) =&gt; {
                cell.classList.add(&quot;selected&quot;);
            });
            updateFillHandle();
            if (allCells.length &gt; 0) {
                activeCell = allCells[0];
            }

            return;
        }
    },
    true // キャプチャフェーズで登録
);

// keypress イベントもキャプチャフェーズで抑止（万が一 keydown だけで防げない場合）
document.addEventListener(
    &quot;keypress&quot;,
    function (e) {
        if (e.ctrlKey &amp;&amp; e.key.toLowerCase() === &quot;a&quot;) {
            e.preventDefault();
            e.stopImmediatePropagation();
        }
    },
    true
);

// beforeinput イベントをリッスンして、入力前に &quot;a&quot; が挿入されないようにする
document.addEventListener(
    &quot;beforeinput&quot;,
    function (e) {
        if (e.ctrlKey &amp;&amp; e.data &amp;&amp; e.data.toLowerCase() === &quot;a&quot;) {
            e.preventDefault();
            e.stopImmediatePropagation();
        }
    },
    true
);

// 行番号と列番号の間の空白（corner エリア）をクリックしたら全セル選択する
document.getElementById(&quot;corner&quot;).addEventListener(&quot;click&quot;, e =&gt; {
    e.preventDefault();
    if (document.activeElement?.isContentEditable) return;
    // 既存選択解除と全選択をまとめて行う
    const allCells = document.querySelectorAll(&quot;#spreadsheet tbody td&quot;);
    allCells.forEach(cell =&gt; cell.classList.toggle(&quot;selected&quot;, true));
    updateFillHandle();
    activeCell = allCells[0] ?? activeCell;
});

window.onload = function () {
    //==============================
    // ドラッグ操作用の共通変数
    //==============================
    let isRowSelecting = false;
    let rowSelectionStart = null;
    let rowSelectionCurrent = null;

    let isColSelecting = false;
    let colSelectionStart = null;
    let colSelectionCurrent = null;

    //==============================
    // mousedown イベントをイベント委譲で処理
    //==============================
    document.addEventListener(&quot;mousedown&quot;, function (e) {
        // 行番号 (row_number) の場合
        const rowHeader = e.target.closest(&quot;th.row_number&quot;);
        if (rowHeader) {
            e.preventDefault();
            if (document.activeElement &amp;&amp; document.activeElement.isContentEditable) {
                document.activeElement.blur();
            }
            isRowSelecting = true;
            rowSelectionStart = parseInt(rowHeader.textContent.trim());
            rowSelectionCurrent = rowSelectionStart;
            clearSelected();
            selectRows(rowSelectionStart, rowSelectionStart);
            // 行番号が優先なら、ここで処理を終了する場合:
            return;
        }

        // 列番号 (col_number) の場合
        const colHeader = e.target.closest(&quot;th.col_number&quot;);
        if (colHeader) {
            e.preventDefault();
            if (document.activeElement &amp;&amp; document.activeElement.isContentEditable) {
                document.activeElement.blur();
            }
            isColSelecting = true;
            colSelectionStart = colLabelToIndex(colHeader.textContent.trim());
            colSelectionCurrent = colSelectionStart;
            clearSelected();
            selectColumns(colSelectionStart, colSelectionStart);
        }
    });

    //==============================
    // ドラッグ中（mousemove）に対象の行／列を更新する
    //==============================
    document.addEventListener(&quot;mousemove&quot;, function (e) {
        // 行選択の場合の処理
        if (isRowSelecting) {
            const th = e.target.closest(&quot;th.row_number&quot;);
            if (th) {
                const hoveredRow = parseInt(th.textContent.trim());
                if (hoveredRow !== rowSelectionCurrent) {
                    rowSelectionCurrent = hoveredRow;
                    const from = Math.min(rowSelectionStart, rowSelectionCurrent);
                    const to = Math.max(rowSelectionStart, rowSelectionCurrent);
                    clearSelected();
                    selectRows(from, to);
                }
            }
        }
        // 列選択の場合の処理
        if (isColSelecting) {
            const th = e.target.closest(&quot;th.col_number&quot;);
            if (th) {
                const hoveredCol = colLabelToIndex(th.textContent.trim());
                if (hoveredCol !== colSelectionCurrent) {
                    colSelectionCurrent = hoveredCol;
                    const from = Math.min(colSelectionStart, colSelectionCurrent);
                    const to = Math.max(colSelectionStart, colSelectionCurrent);
                    clearSelected();
                    selectColumns(from, to);
                }
            }
        }
    });

    //==============================
    // マウスアップでドラッグ選択終了
    //==============================
    document.addEventListener(&quot;mouseup&quot;, function (e) {
        if (isRowSelecting) {
            isRowSelecting = false;
            rowSelectionStart = null;
            rowSelectionCurrent = null;
        }
        if (isColSelecting) {
            isColSelecting = false;
            colSelectionStart = null;
            colSelectionCurrent = null;
        }
    });


    //==============================
    // ヘルパー関数
    //==============================

    // 選択状態をクリア（#spreadsheet 内の td から selected クラスを削除）
    function clearSelected() {
        const selectedCells = document.querySelectorAll(&quot;#spreadsheet td.selected&quot;);
        selectedCells.forEach(cell =&gt; cell.classList.remove(&quot;selected&quot;));
    }

    // 行番号 (data-row 属性に一致) の範囲を選択
    function selectRows(from, to) {
        const selectors = [];
        for (let r = from; r &lt;= to; r++) {
            selectors.push(`td[data-row=&quot;${r}&quot;]`);
        }
        const cells = document.querySelectorAll(&quot;#spreadsheet &quot; + selectors.join(&quot;,&quot;));
        cells.forEach(cell =&gt; cell.classList.add(&quot;selected&quot;));
    }

    // 列番号 (data-col 属性に一致) の範囲を選択
    function selectColumns(from, to) {
        const selectors = [];
        for (let c = from; c &lt;= to; c++) {
            selectors.push(`td[data-col=&quot;${c}&quot;]`);
        }
        const cells = document.querySelectorAll(&quot;#spreadsheet &quot; + selectors.join(&quot;,&quot;));
        cells.forEach(cell =&gt; cell.classList.add(&quot;selected&quot;));
    }

    // 例：列番号ラベル &quot;A&quot; -&gt; 0, &quot;B&quot; -&gt; 1, &quot;AA&quot; -&gt; 26 などに変換する関数
    function colLabelToIndex(label) {
        let index = 0;
        label = label.toUpperCase();
        for (let i = 0; i &lt; label.length; i++) {
            index = index * 26 + ((label.charCodeAt(i) - 65) + 1);
        }
        return index - 1; // 0-index に調整
    }








    const spreadsheet = document.getElementById(&quot;spreadsheet&quot;);
    if (!spreadsheet) {
        console.error(&quot;Spreadsheet element not found.&quot;);
        return;
    }

    // =========================
    // ツールチップの生成と制御
    // =========================
    const resizeTooltip = (() =&gt; {
        let tooltip = document.createElement(&quot;div&quot;);
        tooltip.id = &quot;resize-tooltip&quot;;
        tooltip.style.position = &quot;fixed&quot;;
        tooltip.style.background = &quot;rgba(0, 0, 0, 0.7)&quot;;
        tooltip.style.color = &quot;#fff&quot;;
        tooltip.style.padding = &quot;4px 8px&quot;;
        tooltip.style.borderRadius = &quot;4px&quot;;
        tooltip.style.fontSize = &quot;12px&quot;;
        tooltip.style.display = &quot;none&quot;;
        tooltip.style.pointerEvents = &quot;none&quot;; // ツールチップがマウス操作を妨げないように
        tooltip.style.zIndex = &quot;10000&quot;;
        document.body.appendChild(tooltip);
        return tooltip;
    })();

    function updateResizeTooltip(x, y, text) {
        resizeTooltip.textContent = text;
        // マウスポインターの右上側に表示（必要に応じてオフセットを調整してください）
        resizeTooltip.style.left = (x + 10) + &quot;px&quot;;
        resizeTooltip.style.top = (y - 30) + &quot;px&quot;;
        resizeTooltip.style.display = &quot;block&quot;;
    }

    function hideResizeTooltip() {
        resizeTooltip.style.display = &quot;none&quot;;
    }

    // =========================
    // 初回のリサイズハンドル追加
    // =========================
    addRowResizeHandles();
    addColumnResizeHandles();

    // =========================
    // 動的に追加された要素にも対応する MutationObserver の設定
    // =========================
    const observer = new MutationObserver((mutationsList, observer) =&gt; {
        for (const mutation of mutationsList) {
            mutation.addedNodes.forEach((node) =&gt; {
                if (node.nodeType === Node.ELEMENT_NODE) {
                    // 新規追加されたノード自身が、またはその子孫に行番号ヘッダーが含まれていたら
                    if (node.matches(&quot;th.row_number&quot;) || node.querySelector(&quot;th.row_number&quot;)) {
                        addRowResizeHandles();
                    }
                    // 同様に、列番号ヘッダーが含まれていたら
                    if (node.matches(&quot;th.col_number&quot;) || node.querySelector(&quot;th.col_number&quot;)) {
                        addColumnResizeHandles();
                    }
                }
            });
        }
    });
    observer.observe(spreadsheet, { childList: true, subtree: true });

    // =========================
    // 関数定義
    // =========================

    // 行番号ヘッダーにリサイズハンドルを追加する
    function addRowResizeHandles() {
        // th.row_number と td.row_number の両方に対応
        const rowHeaders = document.querySelectorAll(&quot;th.row_number, td.row_number&quot;);
        rowHeaders.forEach(cell =&gt; {
            // 既にハンドルが追加されていない場合のみ追加
            if (!cell.querySelector(&quot;.row-resize-handle&quot;)) {
                const handle = document.createElement(&quot;div&quot;);
                handle.className = &quot;row-resize-handle&quot;;
                // 以下のスタイルでハンドルをセルの下端の中央に配置
                handle.style.position = &quot;absolute&quot;;
                handle.style.left = &quot;0&quot;;
                handle.style.right = &quot;0&quot;;
                // セルの下端に配置し、中央に来るように調整（すなわち「1」と「2」などの間になる）
                handle.style.top = &quot;100%&quot;;
                handle.style.transform = &quot;translateY(-50%)&quot;;
                // ハンドルの高さは細いバーとして指定（必要に応じて調整）
                handle.style.height = &quot;6px&quot;;
                // カーソルは縦方向リサイズとする
                handle.style.cursor = &quot;row-resize&quot;;
                // オーバーレイが邪魔にならないようにしておく（オプション）
                // handle.style.background = &quot;rgba(0, 0, 0, 0.3)&quot;;
                // 親要素（セル）を相対位置に
                cell.style.position = &quot;sticky&quot;;
                cell.style.textAlign = &quot;right&quot;;
                cell.style.fontSize = &quot;large&quot;;
                cell.appendChild(handle);
                // mousedown イベントで行リサイズハンドラーへ
                handle.addEventListener(&quot;mousedown&quot;, rowResizeHandler);
            }
        });
    }


    // 列番号ヘッダーにリサイズハンドルを追加する
    function addColumnResizeHandles() {
        const colHeaders = document.querySelectorAll(&quot;th.col_number&quot;);
        colHeaders.forEach(th =&gt; {
            // 既にハンドルが追加されていないかチェック
            if (!th.querySelector(&quot;.col-resize-handle&quot;)) {
                const handle = document.createElement(&quot;div&quot;);
                handle.className = &quot;col-resize-handle&quot;;
                // スタイル調整（右端に配置する形）
                handle.style.position = &quot;absolute&quot;;
                handle.style.right = &quot;0&quot;;
                handle.style.top = &quot;0&quot;;
                handle.style.width = &quot;6px&quot;;
                handle.style.height = &quot;100%&quot;;
                handle.style.cursor = &quot;col-resize&quot;;
                th.style.textAlign = &quot;center&quot;;
                th.style.fontSize = &quot;large&quot;;
                th.appendChild(handle);
                handle.addEventListener(&quot;mousedown&quot;, colResizeHandler);
            }
            // ヘッダーに data-col 属性が無ければ、列番号テキストから追加（例：&quot;A&quot; &rarr; 0）
            if (!th.hasAttribute(&quot;data-col&quot;)) {
                const colLabel = th.textContent.trim();
                const colIndex = colLabelToIndex(colLabel);
                th.setAttribute(&quot;data-col&quot;, colIndex);
            }
        });
    }

    // ----- 行のリサイズ処理（ドラッグ中に行全体の高さを調整） -----
    function rowResizeHandler(e) {
        e.stopPropagation();
        e.preventDefault();

        // 現在の行を取得 (行番号ヘッダーは &lt;th&gt;、親行は &lt;tr&gt;)
        const th = e.target.parentElement;
        const tr = th.parentElement;
        const startY = e.clientY;
        const startHeight = tr.offsetHeight;

        const onMouseMove = function (eMove) {
            const dy = eMove.clientY - startY;
            let newHeight = startHeight + dy;
            if (newHeight &lt; 20) newHeight = 20; // 最低高さを設定

            // 行内のすべてのセル (th と td) に新しい高さを設定
            Array.from(tr.children).forEach(cell =&gt; {
                cell.style.height = newHeight + &quot;px&quot;;
            });
            tr.style.height = newHeight + &quot;px&quot;;
            // ツールチップに現在の高さ (px) を表示（マウス座標から表示）
            updateResizeTooltip(eMove.clientX, eMove.clientY, newHeight + &quot;px&quot;);
            setTimeout(() =&gt; {
                setupRowVisibilityObserver();
            }, 500);
        };

        const onMouseUp = function () {
            document.removeEventListener(&quot;mousemove&quot;, onMouseMove);
            document.removeEventListener(&quot;mouseup&quot;, onMouseUp);
            hideResizeTooltip();
        };

        document.addEventListener(&quot;mousemove&quot;, onMouseMove);
        document.addEventListener(&quot;mouseup&quot;, onMouseUp);
    }

    // ----- 列のリサイズ処理（ドラッグ中に同じ data-col の列の幅を調整） -----
    function colResizeHandler(e) {
        e.stopPropagation();
        e.preventDefault();

        const th = e.target.parentElement;
        const startX = e.clientX;
        const startWidth = th.offsetWidth;
        const colIndex = th.getAttribute(&quot;data-col&quot;);

        const onMouseMove = function (eMove) {
            const dx = eMove.clientX - startX;
            let newWidth = startWidth + dx;
            if (newWidth &lt; 30) newWidth = 30; // 最小幅

            // ヘッダー自身の幅を更新
            th.style.width = newWidth + &quot;px&quot;;
            // 同じ data-col を持つ全ての td セルの幅を更新
            const colCells = document.querySelectorAll(`#spreadsheet td[data-col=&quot;${colIndex}&quot;]`);
            colCells.forEach(td =&gt; {
                td.style.width = newWidth + &quot;px&quot;;
            });
            // ツールチップに現在の幅 (px) を表示
            updateResizeTooltip(eMove.clientX, eMove.clientY, newWidth + &quot;px&quot;);
            setTimeout(() =&gt; {
                setupRowVisibilityObserver();
            }, 500);
        };

        const onMouseUp = function () {
            document.removeEventListener(&quot;mousemove&quot;, onMouseMove);
            document.removeEventListener(&quot;mouseup&quot;, onMouseUp);
            hideResizeTooltip();
        };

        document.addEventListener(&quot;mousemove&quot;, onMouseMove);
        document.addEventListener(&quot;mouseup&quot;, onMouseUp);
    }

    // ----- 補助関数 -----
    // A, B, C... AA, AB... -&gt; 0, 1, 2, ... （例としてアルファベット&rarr;数値に変換する関数）
    function colLabelToIndex(label) {
        let index = 0;
        for (let i = 0; i &lt; label.length; i++) {
            index *= 26;
            index += label.charCodeAt(i) - 64;  // &#039;A&#039; は 65 なので
        }
        return index - 1;  // 0-indexed にするため 1 を引く
    }


    // 列番号ラベル (&quot;A&quot;, &quot;B&quot;, &quot;AA&quot;, &hellip;) を 0-index に変換する関数
    function colLabelToIndex(label) {
        let index = 0;
        label = label.toUpperCase();
        for (let i = 0; i &lt; label.length; i++) {
            index = index * 26 + (label.charCodeAt(i) - 65 + 1);
        }
        return index - 1;
    }












    // A1 セルを取得（getCellは 1-index, 0-index の引数をとります）
    const a1Cell = getCell(1, 0);
    if (a1Cell) {
        // 既存の選択状態を解除
        const previouslySelected = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
        previouslySelected.forEach(cell =&gt; cell.classList.remove(&quot;selected&quot;));

        // A1 セルを選択状態にする
        a1Cell.classList.add(&quot;selected&quot;);
        updateSelectedCellsDisplay();

        // アクティブセルを更新
        activeCell = a1Cell;
        updateFillHandle();

        // セルにフォーカスを当てる（エディタとして編集操作ができるように）
        a1Cell.focus();


        // 数式バーの内容も更新（セルの数式があればそれを、そうでなければテキスト内容を設定）
        formulaBarInput.value = a1Cell.dataset.formula ? a1Cell.dataset.formula : a1Cell.textContent;
    }



};





// 上揃えボタン
let verticalAlignTopButton = document.getElementById(&quot;vertical-align-top&quot;);
verticalAlignTopButton.addEventListener(&quot;click&quot;, function (e) {
    let cells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
    if (cells.length &gt; 0) {
        cells.forEach(cell =&gt; {
            if (cell.style.verticalAlign === &quot;top&quot;) {
                cell.style.verticalAlign = &quot;&quot;;
            } else {
                cell.style.verticalAlign = &quot;top&quot;;
            }
        });
    } else if (activeCell) {
        if (activeCell.style.verticalAlign === &quot;top&quot;) {
            activeCell.style.verticalAlign = &quot;&quot;;
        } else {
            activeCell.style.verticalAlign = &quot;top&quot;;
        }
    }
});
// 中央揃えボタン
let verticalAlignMiddleButton = document.getElementById(&quot;vertical-align-middle&quot;);
verticalAlignMiddleButton.addEventListener(&quot;click&quot;, function (e) {
    let cells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
    if (cells.length &gt; 0) {
        cells.forEach(cell =&gt; {
            if (cell.style.verticalAlign === &quot;middle&quot;) {
                cell.style.verticalAlign = &quot;&quot;;
            } else {
                cell.style.verticalAlign = &quot;middle&quot;;
            }
        });
    } else if (activeCell) {
        if (activeCell.style.verticalAlign === &quot;middle&quot;) {
            activeCell.style.verticalAlign = &quot;&quot;;
        } else {
            activeCell.style.verticalAlign = &quot;middle&quot;;
        }
    }
});
// 下揃えボタン
let verticalAlignBottomButton = document.getElementById(&quot;vertical-align-bottom&quot;);
verticalAlignBottomButton.addEventListener(&quot;click&quot;, function (e) {
    let cells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
    if (cells.length &gt; 0) {
        cells.forEach(cell =&gt; {
            if (cell.style.verticalAlign === &quot;bottom&quot;) {
                cell.style.verticalAlign = &quot;&quot;;
            } else {
                cell.style.verticalAlign = &quot;bottom&quot;;
            }
        });
    } else if (activeCell) {
        if (activeCell.style.verticalAlign === &quot;bottom&quot;) {
            activeCell.style.verticalAlign = &quot;&quot;;
        } else {
            activeCell.style.verticalAlign = &quot;bottom&quot;;
        }
    }
});
let toggleTextWrapButton = document.getElementById(&quot;toggle-text-wrap&quot;);
toggleTextWrapButton.addEventListener(&quot;click&quot;, function (e) {
    let cells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
    if (cells.length &gt; 0) {
        cells.forEach(cell =&gt; {
            // 初期状態は &quot;pre&quot;（折り返しOFF）
            if (cell.style.whiteSpace === &quot;pre&quot;) {
                // 折り返しONに：改行はそのまま表示しつつ自動折り返し
                cell.style.whiteSpace = &quot;pre-wrap&quot;;
                cell.style.wordBreak = &quot;break-all&quot;;
            } else {
                // 折り返しOFFに：改行は保持されるが自動折り返しは行わない
                cell.style.whiteSpace = &quot;pre&quot;;
                cell.style.wordBreak = &quot;&quot;;
            }
        });
    } else if (activeCell) {
        if (activeCell.style.whiteSpace === &quot;pre&quot;) {
            activeCell.style.whiteSpace = &quot;pre-wrap&quot;;
            activeCell.style.wordBreak = &quot;break-all&quot;;
        } else {
            activeCell.style.whiteSpace = &quot;pre&quot;;
            activeCell.style.wordBreak = &quot;&quot;;
        }
    }
});

function updateSelectedCellsDisplay() {
    const selected = [...document.querySelectorAll(&quot;td.selected&quot;)];
    if (!selected.length) {
        const el = document.getElementById(&quot;selected-cells-display&quot;);
        if (el) el.textContent = &quot;&quot;;
        updateFontSizeSelect();
        return;
    }
    let minR = Infinity, maxR = -Infinity, minC = Infinity, maxC = -Infinity;
    const coords = selected.map(c =&gt; {
        const r = +c.dataset.row, c_ = +c.dataset.col;
        if (r &lt; minR) minR = r; if (r &gt; maxR) maxR = r;
        if (c_ &lt; minC) minC = c_; if (c_ &gt; maxC) maxC = c_;
        return toColumnName(c_) + r;
    });
    const expected = (maxR - minR + 1) * (maxC - minC + 1);
    const text = selected.length === 1 ? coords[0]
        : selected.length === expected ? `${toColumnName(minC)}${minR}:${toColumnName(maxC)}${maxR}`
            : coords.join(&quot;, &quot;);
    const el = document.getElementById(&quot;selected-cells-display&quot;);
    if (el) el.textContent = text;
    updateFontSizeSelect();
}

// 0-indexedの列番号を Excel 表記（&quot;A&quot;, &quot;B&quot;, ..., &quot;Z&quot;, &quot;AA&quot;, ...）に変換する関数
function toColumnName(n) {
    let s = &quot;&quot;;
    for (; n &gt;= 0; n = Math.floor(n / 26) - 1)
        s = String.fromCharCode((n % 26) + 65) + s;
    return s;
}

function updateFontSizeSelect() {
    const selected = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
    if (!selected.length) return;
    let common = null;
    for (const cell of selected) {
        const size = getComputedStyle(cell).fontSize;
        if (common === null) common = size;
        else if (common !== size) return console.log(&quot;選択セルには複数の font-size が設定されています。&quot;);
    }
    const select = document.getElementById(&quot;font-size&quot;);
    if (!select) return console.error(&quot;font-size セレクト要素が見つかりません。&quot;);
    if (select.value === common) return;
    for (const opt of select.options) opt.selected = opt.value === common;
}

// マウスダウン：新規選択開始時に、既存の選択をクリアしてクリックしたセルを選択
document.addEventListener(&quot;mousedown&quot;, function (e) {
    if (e.target.tagName.toUpperCase() === &quot;TD&quot;) {
        updateSelectedCellsDisplay();
    }
    var isClickInsideStartButton = Array.from(document.querySelectorAll(&#039;.pulldown_btn,.pulldown_menu&#039;)).some(button =&gt; button.contains(e.target));
    if (!isClickInsideStartButton) {
        document.querySelectorAll(&quot;.pulldown_menu&quot;).forEach(pulldown_menu =&gt; {
            pulldown_menu.style.display = &quot;none&quot;;
        })
    }
});

// マウス移動：左ボタン押下中 (e.buttons === 1) の場合、ドラッグでセルを選択
document.addEventListener(&quot;mousemove&quot;, function (e) {
    if (e.buttons === 1 &amp;&amp; e.target &amp;&amp; e.target.tagName.toUpperCase() === &quot;TD&quot;) {
        updateSelectedCellsDisplay();
    }
});

// クリック：単体クリックの場合は、前回の選択をクリアして新たに選択
document.addEventListener(&quot;click&quot;, function (e) {
    if (e.target.tagName.toUpperCase() === &quot;TD&quot;) {
        updateSelectedCellsDisplay();
    }
    debouncedSaveState();
});

// キーダウン：矢印キーなどで選択が変更された場合も表示を更新
document.addEventListener(&quot;keydown&quot;, function (e) {
    const arrowKeys = [&quot;ArrowUp&quot;, &quot;ArrowDown&quot;, &quot;ArrowLeft&quot;, &quot;ArrowRight&quot;, &quot;Enter&quot;];
    if (arrowKeys.includes(e.key)) {
        updateSelectedCellsDisplay();
    }
});

// アクティブセルにフィルハンドルを追加／更新する関数
function updateFillHandle() {
    document.querySelectorAll(&quot;.fill-handle&quot;).forEach(h =&gt; h.remove());
    const selected = [...document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;)];
    if (!selected.length) return;
    let target;
    if (selected.length === 1) {
        target = activeCell;
    } else {
        let minR = Infinity, maxR = -Infinity, minC = Infinity, maxC = -Infinity;
        for (const c of selected) {
            const r = +c.dataset.row, col = +c.dataset.col;
            if (r &lt; minR) minR = r; if (r &gt; maxR) maxR = r;
            if (col &lt; minC) minC = col; if (col &gt; maxC) maxC = col;
        }
        target = getCell(maxR, maxC);
    }
    if (target &amp;&amp; !target.isContentEditable) {
        target.style.position = &quot;relative&quot;;
        const fh = document.createElement(&quot;div&quot;);
        fh.className = &quot;fill-handle&quot;;
        target.appendChild(fh);
        fh.addEventListener(&quot;mousedown&quot;, fillHandleMouseDown);
    }
}

// 【selected】セルブロックの境界を計算する関数
// フィル操作管理用グローバル変数
let isFillDragging = false;
let fillDragStartCell = null;          // マウスダウン時のアンカー（通常 activeCell）
let fillDragStartCoord = { x: 0, y: 0 }; // マウスダウン時の座標（window座標）
let currentFillRange = null;           // 現在のフィル範囲 { minRow, maxRow, minCol, maxCol }
let initialFillRange = null;           // マウスダウン時に記録した、もともとの【selected】セルの境界
let initialBottomRight = null;           // initialFillRange の右下（アンカー）セルの情報

// 【selected】セルブロックの境界を計算する関数
function computeInitialFillRange() {
    const selectedCells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
    let minRow = Infinity, maxRow = -Infinity, minCol = Infinity, maxCol = -Infinity;
    selectedCells.forEach(cell =&gt; {
        const r = parseInt(cell.dataset.row, 10);
        const c = parseInt(cell.dataset.col, 10);
        if (r &lt; minRow) minRow = r;
        if (r &gt; maxRow) maxRow = r;
        if (c &lt; minCol) minCol = c;
        if (c &gt; maxCol) maxCol = c;
    });
    return { minRow, maxRow, minCol, maxCol };
}


// フィルハンドルのマウスダウン時の処理
function fillHandleMouseDown(e) {
    // 編集モード中なら無視する
    if (activeCell &amp;&amp; activeCell.isContentEditable) return;
    e.stopPropagation();
    e.preventDefault();
    isFillDragging = true;
    fillDragStartCell = activeCell;
    fillDragStartCoord = { x: e.clientX, y: e.clientY };
    // もともと【selected】になっているセルのブロックの境界を記録
    initialFillRange = computeInitialFillRange();
    // アンカーとして、初期選択ブロックの右下のセル（initialFillRange.maxRow, maxCol）を記録
    initialBottomRight = { row: initialFillRange.maxRow, col: initialFillRange.maxCol };
    document.addEventListener(&quot;mousemove&quot;, fillHandleMouseMove);
    document.addEventListener(&quot;mouseup&quot;, fillHandleMouseUp);
}

// ドラッグ中のmousemoveで範囲を更新（デルタ計算方式）
function fillHandleMouseMove(e) {
    if (!isFillDragging) return;

    // セルのサイズ（環境に合わせて調整または動的取得してください）
    const cellWidth = 120;  // px
    const cellHeight = 40;  // px

    // ① マウス下のセル要素を取得
    let targetElem = document.elementFromPoint(e.clientX, e.clientY);
    while (targetElem &amp;&amp; targetElem.tagName !== &quot;TD&quot;) {
        targetElem = targetElem.parentElement;
    }
    if (!targetElem) return;

    const targetRow = parseInt(targetElem.dataset.row, 10);
    const targetCol = parseInt(targetElem.dataset.col, 10);

    let newRange = null;

    // ② どちらのモードか判定：
    // 拡大モード：マウス下のセルの行・列が初期アンカー（initialBottomRight）のそれ以上なら拡大
    if (targetRow &gt;= initialBottomRight.row &amp;&amp; targetCol &gt;= initialBottomRight.col) {
        newRange = {
            minRow: initialFillRange.minRow,
            minCol: initialFillRange.minCol,
            maxRow: targetRow,
            maxCol: targetCol
        };
    } else {
        // 縮小モード：マウス下のセルが初期アンカーの内側にあるとき
        // ここでは、フィルハンドルのDOM要素（初期アンカー）のウィンドウ上の位置から、
        // 現在のマウス位置との差分を計算し、それをセル数に変換して縮小分を求める。

        // フィルハンドル要素（アンカー）がある前提で、activeCell（あるいは初期アンカー側）のfill-handleを取得
        let fillHandleElem = fillDragStartCell.querySelector(&quot;.fill-handle&quot;);
        if (fillHandleElem) {
            let rect = fillHandleElem.getBoundingClientRect();

            // 横方向の縮小量
            let diffX = rect.right - e.clientX;  // マウスが左にどれだけ移動したか
            let shrinkCols = Math.round(diffX / cellWidth);
            // 新しい maxCol は、初期アンカーから縮小分だけ減算
            let newMaxCol = initialBottomRight.col - shrinkCols;
            if (newMaxCol &lt; initialFillRange.minCol) newMaxCol = initialFillRange.minCol;

            // 縦方向の縮小量
            let diffY = rect.bottom - e.clientY; // マウスが上にどれだけ移動したか
            let shrinkRows = Math.round(diffY / cellHeight);
            let newMaxRow = initialBottomRight.row - shrinkRows;
            if (newMaxRow &lt; initialFillRange.minRow) newMaxRow = initialFillRange.minRow;

            newRange = {
                minRow: initialFillRange.minRow,
                minCol: initialFillRange.minCol,
                maxRow: newMaxRow,
                maxCol: newMaxCol
            };
        } else {
            // 万が一フィルハンドルが取得できない場合は、単純に目標セルを基準にする
            newRange = {
                minRow: initialFillRange.minRow,
                minCol: initialFillRange.minCol,
                maxRow: targetRow,
                maxCol: targetCol
            };
        }
    }

    currentFillRange = newRange;

    // ③ 既存の一時ハイライト（fill-selected）の解除
    document.querySelectorAll(&quot;#spreadsheet tbody td.fill-selected&quot;).forEach(cell =&gt; {
        cell.classList.remove(&quot;fill-selected&quot;);
    });

    // ④ currentFillRange 内のセルに一時ハイライト（fill-selected）を付与
    for (let r = currentFillRange.minRow; r &lt;= currentFillRange.maxRow; r++) {
        for (let c = currentFillRange.minCol; c &lt;= currentFillRange.maxCol; c++) {
            const cell = getCell(r, c); // 既存の getCell(row, col) 関数を利用
            if (cell) {
                cell.classList.add(&quot;fill-selected&quot;);
            }
        }
    }
}

// ドラッグ終了時の処理：選択されたセルに値を反映＆selectedクラスを付与
function fillHandleMouseUp(e) {
    if (!isFillDragging) return;

    document.removeEventListener(&quot;mousemove&quot;, fillHandleMouseMove);
    document.removeEventListener(&quot;mouseup&quot;, fillHandleMouseUp);

    // 複製元の情報：ここでは activeCell（またはアンカーセルとしての fillDragStartCell ）の情報を取得
    // 表示テキストや数式情報、スタイルなどを含む
    const fillSource = activeCell; // もしくは fillDragStartCell

    // ① シート全体の既存の selected クラスを一旦解除してリセットする
    document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;).forEach(cell =&gt; {
        cell.classList.remove(&quot;selected&quot;);
    });

    // ② currentFillRange (例: { minRow, maxRow, minCol, maxCol } ) 内の各セルを処理
    // ドラッグ終了時などでセルコピー処理を実行（例）
    for (let r = currentFillRange.minRow; r &lt;= currentFillRange.maxRow; r++) {
        for (let c = currentFillRange.minCol; c &lt;= currentFillRange.maxCol; c++) {
            const targetCell = getCell(r, c);
            if (targetCell) {
                cloneCellProperties(fillSource, targetCell);
                targetCell.classList.add(&quot;selected&quot;);
            }
        }
    }

    // すべてのセルへのコピーが完了した後に、数式の再計算を一括で実行
    updateAllFormulas();

    // ③ 一時ハイライト（fill-selected）の解除
    document.querySelectorAll(&quot;#spreadsheet tbody td.fill-selected&quot;).forEach(cell =&gt; {
        cell.classList.remove(&quot;fill-selected&quot;);
    });

    isFillDragging = false;
    currentFillRange = null;

    // 必要なら、選択セルの表示を更新する関数を呼ぶなど
    updateSelectedCellsDisplay();
}

/**
 * 数式内のすべてのセル参照をコピー元とコピー先のオフセットに合わせて変更する関数
 * (例：コピー元セルが A1 で、コピー先セルが B2 なら、参照 &quot;A1&quot; は &quot;B2&quot; に変換される)
 *
 * @param {string} formula - コピー元セルの数式。先頭は &quot;=&quot; がついている前提。
 * @param {number} rowOffset - コピー先セルとコピー元セルの行の差分（targetRow - sourceRow）
 * @param {number} colOffset - コピー先セルとコピー元セルの列の差分（targetCol - sourceCol）
 * @returns {string} 調整済みの数式文字列
 */
function adjustFormula(formula, rowOffset, colOffset) {
    const adjustedBody = formula.substring(1).replace(/([A-Z]+)(\d+)/g, function (match, colLetters, rowStr) {
        const origRow = parseInt(rowStr, 10);
        const origCol = columnLettersToIndex(colLetters); // 複数文字にも対応する関数
        const newRow = origRow + rowOffset;
        const newCol = origCol + colOffset;
        return getCellReferenceByCoord(newRow, newCol);
    });
    return &quot;=&quot; + adjustedBody;
}

/**
 * セルからセルへプロパティをクローンする関数。
 * ※ 数式が存在する場合、コピー先セルの位置に合わせてセル参照を調整します。
 * 　ユーザーが上書きした場合はハンドル側（handleCellBlur など）で dataset.formula を削除するため、
 * 　ここでは、コピー元に dataset.formula が存在し先頭が &quot;=&quot; なら常にコピー・調整することにします。
 */
function cloneCellProperties(sourceCell, targetCell) {
    targetCell.textContent = sourceCell.textContent;
    Object.entries(sourceCell.dataset).forEach(([key, val]) =&gt; {
        if (key !== &#039;row&#039; &amp;&amp; key !== &#039;col&#039; &amp;&amp; !key.startsWith(&quot;merge&quot;)) {
            targetCell.dataset[key] = val;
        }
    });
    if (sourceCell.dataset.formula?.startsWith(&quot;=&quot;)) {
        const srcRow = +sourceCell.dataset.row;
        const srcCol = +sourceCell.dataset.col;
        const tgtRow = +targetCell.dataset.row;
        const tgtCol = +targetCell.dataset.col;
        const rowOffset = tgtRow - srcRow;
        const colOffset = tgtCol - srcCol;
        targetCell.dataset.formula = adjustFormula(sourceCell.dataset.formula, rowOffset, colOffset);
    } else {
        delete targetCell.dataset.formula;
    }
    [&quot;Top&quot;, &quot;Right&quot;, &quot;Bottom&quot;, &quot;Left&quot;].forEach(side =&gt; {
        const width = sourceCell.style[`border${side}Width`];
        const style = sourceCell.style[`border${side}Style`];
        const color = sourceCell.style[`border${side}Color`];
        if (width) targetCell.style[`border${side}Width`] = width;
        if (style) targetCell.style[`border${side}Style`] = style;
        if (color) targetCell.style[`border${side}Color`] = color;
    });
    const computed = window.getComputedStyle(sourceCell);
    const bgColor = computed.backgroundColor;
    targetCell.style.backgroundColor = (bgColor === &quot;rgba(0, 0, 0, 0)&quot; || bgColor === &quot;transparent&quot;) ? &quot;&quot; : bgColor;
    [
        &quot;color&quot;,
        &quot;textAlign&quot;,
        &quot;fontSize&quot;,
        &quot;fontFamily&quot;,
        &quot;fontStyle&quot;,
        &quot;fontWeight&quot;,
        &quot;verticalAlign&quot;,
        &quot;textDecoration&quot;,
        &quot;textShadow&quot;
    ].forEach(prop =&gt; {
        targetCell.style[prop] = computed[prop];
    });
    targetCell.removeAttribute(&quot;contenteditable&quot;);
    targetCell.classList.remove(&quot;selected&quot;, &quot;fill-selected&quot;);
}

// セルクリック時にアクティブセルを更新後、フィルハンドルの状態を更新
document.querySelector(&quot;#spreadsheet tbody&quot;).addEventListener(&quot;click&quot;, function (e) {
    if (e.target.tagName.toUpperCase() === &quot;TD&quot;) {
        updateFillHandle();
    }
});
document.querySelector(&quot;#spreadsheet tbody&quot;).addEventListener(&quot;dblclick&quot;, function (e) {
    if (e.target.tagName.toUpperCase() === &quot;TD&quot;) {
        updateFillHandle();
    }
});

document.addEventListener(&quot;mousemove&quot;, function (e) {
    // 範囲選択が終了したタイミング
    updateFillHandle();
});




/*********************
 * 数式の挿入機能
 *********************/

/**
 * 選択中 (selected クラスが付与された) のセルに対して、数式を挿入し、評価結果を表示する
 */
function insertFunctionIntoSelectedCells(formula) {
    if (formula[0] !== &quot;=&quot;) {
        console.error(&quot;挿入する数式は &#039;=&#039; から始まる必要があります&quot;);
        return;
    }
    const selectedCells = document.querySelectorAll(&quot;td.selected&quot;);
    selectedCells.forEach(cell =&gt; {
        // セルに数式として保持（再評価時に利用できるよう dataset に記録）
        cell.dataset.formula = formula;
        // 数式を評価して表示
        const result = evaluateFormula(formula);
        cell.textContent = result;
        document.getElementById(&#039;formula-bar&#039;).value = formula;
    });
}

/**
 * ボタン押下時に呼ばれる関数
 * 渡された数式テンプレートをそのまま選択セルに挿入する
 */
function applyFormula(formula) {
    insertFunctionIntoSelectedCells(formula);
}


document.getElementById(&quot;merge-cells&quot;).addEventListener(&quot;click&quot;, mergeSelectedCells);
document.getElementById(&quot;unmerge-cells&quot;).addEventListener(&quot;click&quot;, unmergeSelectedCells);

/**
 * 選択状態のセルを結合する関数
 * ※ 選択セルは連続した矩形状でなければならない
 */
// 
function mergeSelectedCells() {
    const selectedCells = document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;);
    if (selectedCells.length === 0) return;

    let rows = [];
    let cols = [];
    selectedCells.forEach(cell =&gt; {
        rows.push(parseInt(cell.dataset.row, 10));
        cols.push(parseInt(cell.dataset.col, 10));
    });
    const minRow = Math.min(...rows);
    const maxRow = Math.max(...rows);
    const minCol = Math.min(...cols);
    const maxCol = Math.max(...cols);

    const expectedCount = (maxRow - minRow + 1) * (maxCol - minCol + 1);

    // 単体セルの場合は結合しない
    if (expectedCount === 1) {
        alert(&quot;単体セルでは結合できません。&quot;);
        return;
    }

    if (selectedCells.length !== expectedCount) {
        alert(&quot;連続した矩形状のセルを選択してください。&quot;);
        return;
    } else {
        setTimeout(() =&gt; {
            updateAllFormulas();
        }, 0);
    }

    // 結合済みのセルが範囲内に存在していないか確認する
    for (let r = minRow; r &lt;= maxRow; r++) {
        for (let c = minCol; c &lt;= maxCol; c++) {
            const cell = getCell(r, c);
            if (cell &amp;&amp; (cell.classList.contains(&quot;merged&quot;) ||
                cell.dataset.mergeMinRow ||
                cell.dataset.mergeAnchorRow)) {
                alert(&quot;既に結合されているセルが範囲内に含まれているため、結合できません。&quot;);
                return;
            }
        }
    }

    // 範囲内を行優先、列優先で走査して、値が入力されているセル（空でないセル）の最初の内容を取得する
    let anchorValue = &quot;&quot;;
    let anchorFormula = &quot;&quot;; // 数式があれば保持するための変数
    let found = false;
    for (let r = minRow; r &lt;= maxRow; r++) {
        for (let c = minCol; c &lt;= maxCol; c++) {
            const cell = getCell(r, c);
            if (cell &amp;&amp; cell.innerHTML.trim() !== &quot;&quot;) {
                if (cell.dataset.formula &amp;&amp; cell.dataset.formula.trim() !== &quot;&quot;) {
                    // 数式が登録されている場合は、評価結果とともに数式そのものも保存する
                    anchorValue = evaluateFormula(cell.dataset.formula);
                    anchorFormula = cell.dataset.formula;
                } else {
                    anchorValue = cell.innerHTML;
                }
                found = true;
                break;
            }
        }
        if (found) break;
    }

    // アンカーセルは常に範囲の左上（minRow, minCol）とする
    const anchor = getCell(minRow, minCol);
    // 取得した値をアンカーにセットする
    anchor.innerHTML = anchorValue;
    // 数式が存在していた場合は、数式情報も保持する
    if (anchorFormula) {
        anchor.dataset.formula = anchorFormula;
    }
    anchor.setAttribute(&quot;rowspan&quot;, maxRow - minRow + 1);
    anchor.setAttribute(&quot;colspan&quot;, maxCol - minCol + 1);
    anchor.classList.add(&quot;merged&quot;);
    // 結合情報をアンカーに保持する
    anchor.dataset.mergeMinRow = minRow;
    anchor.dataset.mergeMaxRow = maxRow;
    anchor.dataset.mergeMinCol = minCol;
    anchor.dataset.mergeMaxCol = maxCol;

    // 結合範囲内のアンカー以外のセルは表示を解除し、内部データをクリアする
    for (let r = minRow; r &lt;= maxRow; r++) {
        for (let c = minCol; c &lt;= maxCol; c++) {
            // アンカーセルは除外
            if (r === minRow &amp;&amp; c === minCol) continue;
            const cell = getCell(r, c);
            if (cell) {
                // セルの内容を削除
                cell.innerHTML = &quot;&quot;;
                // dataset のうち data-row, data-col 以外すべて削除
                Object.keys(cell.dataset).forEach(key =&gt; {
                    if (key !== &quot;row&quot; &amp;&amp; key !== &quot;col&quot;) {
                        delete cell.dataset[key];
                    }
                });
                // スタイル属性をクリアし、非表示に設定
                cell.removeAttribute(&quot;style&quot;);
                cell.style.display = &quot;none&quot;;
                // クラスもクリア
                cell.className = &quot;&quot;;
                // 結合時のアンカー情報を付与
                cell.dataset.mergeAnchorRow = minRow;
                cell.dataset.mergeAnchorCol = minCol;
            }
        }
    }
}




/**
 * 選択状態（または activeCell が結合セル）のセルの結合を解除する関数
 * ※ 結合セルのアンカーとなっているセルを対象にします
 */
function unmergeSelectedCells() {
    // 選択セル全体を取得
    const selectedCells = Array.from(document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;));
    if (selectedCells.length === 0) {
        alert(&quot;結合解除するセルを選択してください。&quot;);
        return;
    }

    // 結合グループのアンカーを重複処理しないため、各アンカーの &ldquo;row,col&rdquo; キーを保持する Set
    const processedAnchorKeys = new Set();

    selectedCells.forEach(cell =&gt; {
        // まず、セルが結合状態か判定
        const rowSpanAttr = cell.getAttribute(&quot;rowspan&quot;);
        const colSpanAttr = cell.getAttribute(&quot;colspan&quot;);
        const rowSpan = rowSpanAttr ? parseInt(rowSpanAttr, 10) : 1;
        const colSpan = colSpanAttr ? parseInt(colSpanAttr, 10) : 1;
        const isMerged = (rowSpan &gt; 1 || colSpan &gt; 1) || (cell.dataset.mergeMinRow &amp;&amp; cell.dataset.mergeMinCol);

        if (!isMerged) {
            // 結合状態でなければスキップ
            return;
        }

        // 結合セルの場合、まずアンカーセルを決定する。
        // 通常はアンカーには merged クラスが付いている（または mergeAnchor* 属性が無い）ので、
        // もし cell に mergeAnchorRow/mergeAnchorCol があれば、それはアンカー以外とみなしてアンカーを取得する
        let anchorCell = cell;
        if (!cell.classList.contains(&quot;merged&quot;) &amp;&amp; cell.dataset.mergeAnchorRow &amp;&amp; cell.dataset.mergeAnchorCol) {
            anchorCell = getCell(
                parseInt(cell.dataset.mergeAnchorRow, 10),
                parseInt(cell.dataset.mergeAnchorCol, 10)
            );
        }
        if (!anchorCell) return;

        // 重複処理を避けるため、キー（例: &quot;5,3&quot;）を使ってこのアンカーを一意に識別
        const anchorKey = anchorCell.dataset.row + &quot;,&quot; + anchorCell.dataset.col;
        if (processedAnchorKeys.has(anchorKey)) {
            return;
        }
        processedAnchorKeys.add(anchorKey);

        // 結合範囲を取得する
        let minRow, maxRow, minCol, maxCol;
        if (
            anchorCell.dataset.mergeMinRow &amp;&amp;
            anchorCell.dataset.mergeMinCol &amp;&amp;
            anchorCell.dataset.mergeMaxRow &amp;&amp;
            anchorCell.dataset.mergeMaxCol
        ) {
            minRow = parseInt(anchorCell.dataset.mergeMinRow, 10);
            maxRow = parseInt(anchorCell.dataset.mergeMaxRow, 10);
            minCol = parseInt(anchorCell.dataset.mergeMinCol, 10);
            maxCol = parseInt(anchorCell.dataset.mergeMaxCol, 10);
        } else {
            // もし merge 情報が無い場合は、HTML 属性の rowspan/colspan から計算
            const baseRow = parseInt(anchorCell.dataset.row, 10);
            const baseCol = parseInt(anchorCell.dataset.col, 10);
            minRow = baseRow;
            minCol = baseCol;
            maxRow = baseRow + (rowSpan - 1);
            maxCol = baseCol + (colSpan - 1);
        }

        // アンカーセルの結合属性・データ・クラスを解除する
        anchorCell.removeAttribute(&quot;rowspan&quot;);
        anchorCell.removeAttribute(&quot;colspan&quot;);
        anchorCell.classList.remove(&quot;merged&quot;);
        delete anchorCell.dataset.mergeMinRow;
        delete anchorCell.dataset.mergeMaxRow;
        delete anchorCell.dataset.mergeMinCol;
        delete anchorCell.dataset.mergeMaxCol;
        delete anchorCell.dataset.mergeAnchorRow;
        delete anchorCell.dataset.mergeAnchorCol;

        // 結合範囲内の、アンカーセル以外のセルに対しても解除処理を実施
        for (let r = minRow; r &lt;= maxRow; r++) {
            for (let c = minCol; c &lt;= maxCol; c++) {
                // アンカーセルは除外
                if (r === minRow &amp;&amp; c === minCol) continue;
                const otherCell = getCell(r, c);
                if (otherCell) {
                    otherCell.style.display = &quot;&quot;; // 元の表示状態に戻す
                    otherCell.classList.remove(&quot;merged-hidden&quot;);
                    // merge 関連のすべての data 属性を削除
                    delete otherCell.dataset.mergeAnchorRow;
                    delete otherCell.dataset.mergeAnchorCol;
                    delete otherCell.dataset.mergeMinRow;
                    delete otherCell.dataset.mergeMinCol;
                    delete otherCell.dataset.mergeMaxRow;
                    delete otherCell.dataset.mergeMaxCol;
                }
            }
        }
    });
    updateSelectedCellsDisplay();
    setupRowVisibilityObserver();
}

// グローバル変数：コピーされたセル群の詳細情報を保持
let clipboardData = null;
function copySelectedCells() {
    const selectedCells = Array.from(document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;));
    if (!selectedCells.length) return console.log(&quot;コピー対象のセルがありません。&quot;);
    const rows = selectedCells.map(cell =&gt; +cell.dataset.row);
    const cols = selectedCells.map(cell =&gt; +cell.dataset.col);
    const minRow = Math.min(...rows), maxRow = Math.max(...rows);
    const minCol = Math.min(...cols), maxCol = Math.max(...cols);
    const expectedCount = (maxRow - minRow + 1) * (maxCol - minCol + 1);
    const isContiguous = selectedCells.length === expectedCount;
    clipboardData = {
        startRow: minRow,
        startCol: minCol,
        data: isContiguous ? [] : selectedCells.map(cell =&gt; ({
            row: +cell.dataset.row,
            col: +cell.dataset.col,
            value: cell.textContent,
            formula: cell.dataset.formula || &quot;&quot;,
            cssText: cell.getAttribute(&quot;style&quot;) || &quot;&quot;
        }))
    };
    if (isContiguous) {
        for (let r = minRow; r &lt;= maxRow; r++) {
            const rowData = [];
            for (let c = minCol; c &lt;= maxCol; c++) {
                const cell = getCell(r, c);
                rowData.push({
                    value: cell?.textContent || &quot;&quot;,
                    formula: cell?.dataset.formula || &quot;&quot;,
                    cssText: cell?.getAttribute(&quot;style&quot;) || &quot;&quot;
                });
            }
            clipboardData.data.push(rowData);
        }
    }
    console.log(&quot;コピー完了:&quot;, clipboardData);
}

// ===========================
// 詳細貼り付け処理：連続範囲に合わせたコピーの復元
// ===========================
// 新規関数：数式中のセル参照をオフセット分調整する関数
function adjustFormulaReferences(formula, rowDelta, colDelta) {
    // 正規表現で A1 や B2 などの参照を検出
    return formula.replace(/([A-Z]+)(\d+)/g, (match, colLetters, rowStr) =&gt; {
        const colIndex = columnLettersToIndex(colLetters);
        const newColIndex = colIndex + colDelta;
        const newColLetters = getColumnName(newColIndex);
        const newRow = parseInt(rowStr, 10) + rowDelta;
        return newColLetters + newRow;
    });
}

// 貼り付け処理の更新：数式中のセル参照を調整して貼り付ける
function pasteClipboardData() {
    if (!clipboardData) return console.log(&quot;貼り付け対象のデータがありません。&quot;);
    const selected = Array.from(document.querySelectorAll(&quot;#spreadsheet tbody td.selected&quot;));
    let targetCell = activeCell;
    if (selected.length) {
        let minRow = Infinity, minCol = Infinity;
        for (const cell of selected) {
            const r = +cell.dataset.row, c = +cell.dataset.col;
            if (r &lt; minRow) minRow = r;
            if (c &lt; minCol) minCol = c;
        }
        targetCell = getCell(minRow, minCol) || activeCell;
    }
    const targetRow = +targetCell.dataset.row;
    const targetCol = +targetCell.dataset.col;
    const rowDelta = targetRow - clipboardData.startRow;
    const colDelta = targetCol - clipboardData.startCol;
    if (
        clipboardData.startRow !== null &amp;&amp;
        clipboardData.data.length === 1 &amp;&amp;
        clipboardData.data[0].length === 1 &amp;&amp;
        selected.length &gt; 1
    ) {
        const cellData = clipboardData.data[0][0];
        const newFormula = cellData.formula ? adjustFormulaReferences(cellData.formula, rowDelta, colDelta) : &quot;&quot;;
        for (const destCell of selected) {
            if (newFormula) {
                destCell.dataset.formula = newFormula;
                destCell.textContent = evaluateFormula(newFormula);
            } else {
                delete destCell.dataset.formula;
                destCell.textContent = cellData.value;
            }
            destCell.style.cssText = cellData.cssText;
        }
        updateAllFormulas();
        updateFillHandle();
        updateSelectedCellsDisplay();
        return;
    }
    if (Array.isArray(clipboardData.data[0])) {
        const numRows = clipboardData.data.length;
        const numCols = clipboardData.data[0].length;
        for (let r = 0; r &lt; numRows; r++) {
            for (let c = 0; c &lt; numCols; c++) {
                const destCell = getCell(targetRow + r, targetCol + c);
                if (!destCell) continue;
                const cellData = clipboardData.data[r][c];
                const newFormula = cellData.formula ? adjustFormulaReferences(cellData.formula, rowDelta, colDelta) : &quot;&quot;;
                if (newFormula) {
                    destCell.dataset.formula = newFormula;
                    destCell.textContent = evaluateFormula(newFormula);
                } else {
                    delete destCell.dataset.formula;
                    destCell.textContent = cellData.value;
                }
                destCell.style.cssText = cellData.cssText;
            }
        }
    } else {
        for (const item of clipboardData.data) {
            const destRow = targetRow + (item.row - clipboardData.startRow);
            const destCol = targetCol + (item.col - clipboardData.startCol);
            const destCell = getCell(destRow, destCol);
            if (!destCell) continue;
            const newFormula = item.formula ? adjustFormulaReferences(item.formula, rowDelta, colDelta) : &quot;&quot;;
            if (newFormula) {
                destCell.dataset.formula = newFormula;
                destCell.textContent = evaluateFormula(newFormula);
            } else {
                delete destCell.dataset.formula;
                destCell.textContent = item.value;
            }
            destCell.style.cssText = item.cssText;
        }
    }
    updateAllFormulas();
    updateFillHandle();
    updateSelectedCellsDisplay();
}

// ===========================
// キーボードイベント（Ctrl+C / Ctrl+V）およびツールバーでのボタン操作
// ===========================
document.addEventListener(&quot;keydown&quot;, function (e) {
    const cell = e.target;
    // cell.contentEditable が &quot;true&quot; でなければ条件成立する
    if (e.ctrlKey &amp;&amp; cell.contentEditable !== &quot;true&quot;) {
        if (e.key.toLowerCase() === &#039;c&#039;) {
            copySelectedCells();
            return;
        }
        if (e.key.toLowerCase() === &#039;v&#039;) {
            pasteClipboardData();
            return;
        }
    }
});

// ===== Undo / Redo のためのグローバル変数 =====
let undoHistory = [];
let redoHistory = [];

// ===== 連続操作を抑えるためのデバウンス処理 =====
let saveStateTimeout;

function debouncedSaveState(delay = 250) {  // 250ms 操作がなければ状態保存
    if (saveStateTimeout) {
        clearTimeout(saveStateTimeout);
    }
    saveStateTimeout = setTimeout(() =&gt; {
        saveState();
    }, delay);
}

/**
 * 保存状態を「DOM全体」ではなく、セルデータ（値、数式、スタイル、結合情報など）のみを
 * JSON 形式にして保存する関数です。
 */
function saveState() {
    // シート内のすべてのセル（例：tbody内のtd）から、必要な情報を抽出
    const cells = document.querySelectorAll(&quot;#spreadsheet tbody td&quot;);
    let savedCells = [];
    cells.forEach(cell =&gt; {
        // ここでは値があっても空でも保存しますが、条件を付ける場合は適宜調整してください
        savedCells.push({
            row: parseInt(cell.dataset.row, 10),
            col: parseInt(cell.dataset.col, 10),
            value: cell.textContent,
            formula: cell.dataset.formula || &quot;&quot;,
            style: cell.getAttribute(&quot;style&quot;) || &quot;&quot;,
            colspan: cell.getAttribute(&quot;colspan&quot;) || &quot;1&quot;,
            rowspan: cell.getAttribute(&quot;rowspan&quot;) || &quot;1&quot;
        });
    });

    // 必要であれば、行の高さなども追加できますが、ここではセル情報のみ保存しています

    const state = {
        cells: savedCells
    };

    // 新たな操作の場合、Redo 履歴はクリア
    redoHistory = [];
    // JSON.stringify により文字列化して保存（undoHistory は配列として管理）
    undoHistory.push(JSON.stringify(state));

    console.log(&quot;State saved. UndoHistory length:&quot;, undoHistory.length);
}

function loadState(stateJSON) {
    const cells = JSON.parse(stateJSON).cells;
    for (const { row, col, value, formula, style, colspan, rowspan } of cells) {
        const cell = getCell(row, col);
        if (!cell) continue;
        if (value.trim()) {
            if (formula?.trim()) {
                cell.dataset.formula = formula;
                cell.textContent = evaluateFormula(formula);
            } else {
                delete cell.dataset.formula;
                cell.textContent = value;
            }
        } else {
            delete cell.dataset.formula;
            cell.textContent = &quot;&quot;;
        }
        cell.style.cssText = style || &quot;&quot;;
        setSpan(cell, &quot;colspan&quot;, colspan);
        setSpan(cell, &quot;rowspan&quot;, rowspan);
    }
    function setSpan(cell, attr, val) {
        const num = Number(val);
        num &gt; 1 ? cell.setAttribute(attr, num) : cell.removeAttribute(attr);
    }
}

function undo() {
    if (undoHistory.length &lt;= 1) return console.log(&quot;これ以上戻れません。&quot;);
    redoHistory.push(undoHistory.pop());
    loadState(undoHistory[undoHistory.length - 1]);
}

function redo() {
    if (!redoHistory.length) return console.log(&quot;これ以上進めません。&quot;);
    const state = redoHistory.pop();
    undoHistory.push(state);
    loadState(state);
}

// ===== キーボードショートカットのバインド =====
document.addEventListener(&quot;keydown&quot;, function (e) {
    // Ctrl+Zで Undo
    if (e.ctrlKey &amp;&amp; !e.shiftKey &amp;&amp; e.key.toLowerCase() === &quot;z&quot;) {
        e.preventDefault();
        e.stopImmediatePropagation();
        undo();
        return;
    }
    // Ctrl+Yで Redo
    if (e.ctrlKey &amp;&amp; e.key.toLowerCase() === &quot;y&quot;) {
        e.preventDefault();
        e.stopImmediatePropagation();
        redo();
        return;
    }

    if (e.ctrlKey &amp;&amp; e.key.toLowerCase() === &quot;s&quot;) {
        e.preventDefault();
        e.stopImmediatePropagation();
        saveSpreadsheetData();
        return;
    }

});

// ===== 状態保存のタイミング =====
// 例えば、セル編集完了（blur イベント）のタイミングで保存する例
document.addEventListener(&quot;blur&quot;, function (e) {
    if (e.target &amp;&amp; e.target.tagName.toLowerCase() === &quot;td&quot;) {
        debouncedSaveState();
    }
}, true);

// また、貼り付けやフォーマット変更など、操作終了時にも debouncedSaveState() を呼ぶようにしてください


// ---------------------------------
// 保存処理：セル・行・列・ズーム情報の保存＋圧縮して localStorage に保存
// ---------------------------------
/***************** 不要なデータの除去 *****************/
// オブジェクトや配列を再帰的に走査し、空文字・null・undefinedや、特定のデフォルト値と同じプロパティを削除する
/***************** ビット列変換用ユーティリティ *****************/
// 指定した桁数で 2 進数表現に変換（左側を 0 でパディング）
function toPaddedBin(num, length) {
    const bin = num.toString(2);
    return &quot;0&quot;.repeat(length - bin.length) + bin;
}

/***************** LZW 圧縮／解凍（コード配列版） *****************/
// 入力文字列を LZW で圧縮し、コードの配列を返す
function lzw_compress_array(uncompressed) {
    const dictionary = {};
    for (let i = 0; i &lt; 256; i++) {
        dictionary[String.fromCharCode(i)] = i;
    }
    let phrase = &quot;&quot;;
    const out = [];
    let code = 256;
    for (let i = 0; i &lt; uncompressed.length; i++) {
        const currChar = uncompressed[i];
        const phrasePlusChar = phrase + currChar;
        if (dictionary.hasOwnProperty(phrasePlusChar)) {
            phrase = phrasePlusChar;
        } else {
            out.push(dictionary[phrase]);
            dictionary[phrasePlusChar] = code++;
            phrase = currChar;
        }
    }
    if (phrase !== &quot;&quot;) {
        out.push(dictionary[phrase]);
    }
    return out;
}

// コード配列から元の文字列を LZW で復元
function lzw_decompress_array(codes) {
    const dictionary = {};
    for (let i = 0; i &lt; 256; i++) {
        dictionary[i] = String.fromCharCode(i);
    }
    let old = codes[0];
    let phrase = dictionary[old];
    let out = phrase;
    let code = 256;
    for (let i = 1; i &lt; codes.length; i++) {
        const currCode = codes[i];
        let curr;
        if (dictionary.hasOwnProperty(currCode)) {
            curr = dictionary[currCode];
        } else {
            curr = phrase + phrase[0];
        }
        out += curr;
        dictionary[code++] = phrase + curr[0];
        phrase = curr;
    }
    return out;
}

/***************** 高圧縮：LZW ＋ ビットパッキング *****************/
// compressData: 入力文字列（例：JSON）を圧縮し、1 つの文字列として出力する
function compressData(dataStr) {
    // Unicode 対応：入力文字列をまず URL エンコード（unescape/encodeURIComponent）して ASCII 化する
    const safeStr = unescape(encodeURIComponent(dataStr));

    // 1. LZW 圧縮：文字列をコード配列に変換
    const codes = lzw_compress_array(safeStr);

    // 2. 最小必要ビット幅の算出（初期辞書は 8 ビット分とする）
    let maxCode = 0;
    for (let i = 0; i &lt; codes.length; i++) {
        if (codes[i] &gt; maxCode) {
            maxCode = codes[i];
        }
    }
    const bitWidth = Math.max(8, Math.ceil(Math.log2(maxCode + 1)));
    const codeCount = codes.length;

    // 3. ヘッダー作成：先頭 8 ビットに bitWidth、次の 32 ビットにコード数 codeCount を記録
    const header = toPaddedBin(bitWidth, 8) + toPaddedBin(codeCount, 32);

    // 4. 各コードを固定ビット幅（bitWidth 桁）の 2 進数に変換し連結
    let bits = &quot;&quot;;
    for (let i = 0; i &lt; codes.length; i++) {
        bits += toPaddedBin(codes[i], bitWidth);
    }

    // 5. ヘッダーとコード部ビット列を連結
    const fullBitString = header + bits;

    // 6. 【16 ビット単位に詰める】：最終ビット列の長さが 16 の倍数になるよう右側を 0 埋め
    const padLength = (16 - (fullBitString.length % 16)) % 16;
    const paddedBitString = fullBitString + &quot;0&quot;.repeat(padLength);

    // 7. 16 ビット毎に区切り、各 16 ビットを文字コードに変換して連結
    let compressed = &quot;&quot;;
    for (let i = 0; i &lt; paddedBitString.length; i += 16) {
        const chunk = paddedBitString.substring(i, i + 16);
        const charCode = parseInt(chunk, 2);
        compressed += String.fromCharCode(charCode);
    }
    return compressed;
}


// decompressData: 圧縮データ文字列を復元し、元の文字列（例：JSON）を返す
function decompressData(compressedStr) {
    let bitString = &quot;&quot;;
    // 1. 16 ビット単位の文字列を 16 ビットの 2 進数文字列に展開
    for (let i = 0; i &lt; compressedStr.length; i++) {
        let bits = compressedStr.charCodeAt(i).toString(2);
        bits = &quot;0&quot;.repeat(16 - bits.length) + bits;
        bitString += bits;
    }

    // 2. ヘッダーから bitWidth（最初の 8 ビット）とコード数（次の 32 ビット）を読み出す
    const bitWidth = parseInt(bitString.substring(0, 8), 2);
    const codeCount = parseInt(bitString.substring(8, 40), 2);
    const codes = [];
    let index = 40; // ヘッダー分読み飛ばす
    for (let i = 0; i &lt; codeCount; i++) {
        const codeBits = bitString.substring(index, index + bitWidth);
        const code = parseInt(codeBits, 2);
        codes.push(code);
        index += bitWidth;
    }

    // 3. LZW 復元：コード配列から元データの文字列を復元
    const decompressed = lzw_decompress_array(codes);
    // Unicode 対応：元の文字列に戻すため、escape/decodeURIComponent を適用
    return decodeURIComponent(escape(decompressed));
}

/***************** 不要なデータの除去 *****************/
// オブジェクトや配列を再帰的に走査し、空文字／null／undefined や特定のデフォルト値と同じプロパティを削除する
function cleanData(data) {
    if (Array.isArray(data)) {
        return data.map(item =&gt; cleanData(item));
    } else if (data !== null &amp;&amp; typeof data === &#039;object&#039;) {
        for (let key in data) {
            if (data.hasOwnProperty(key)) {
                data[key] = cleanData(data[key]);
                if (data[key] === &quot;&quot; || data[key] === null || data[key] === undefined) {
                    delete data[key];
                }
                if ((key === &quot;colspan&quot; || key === &quot;rowspan&quot;) &amp;&amp; data[key] === &quot;1&quot;) {
                    delete data[key];
                }
            }
        }
        return data;
    } else {
        return data;
    }
}

/***************** 配列形式・完全圧縮版 保存処理 *****************/
function saveSpreadsheetData() {
    loadingstate.textContent = &quot;保存中...&quot;;
    setTimeout(() =&gt; {
        try {
            const savedCells = [];
            const mergeKeys = [&quot;mergeAnchorRow&quot;, &quot;mergeAnchorCol&quot;, &quot;mergeMinRow&quot;, &quot;mergeMinCol&quot;, &quot;mergeMaxRow&quot;, &quot;mergeMaxCol&quot;];
            const mkShort = { mergeAnchorRow: 0, mergeAnchorCol: 1, mergeMinRow: 2, mergeMinCol: 3, mergeMaxRow: 4, mergeMaxCol: 5 };
            const DEFAULT_COLSPAN = 1, DEFAULT_ROWSPAN = 1;
            const DEFAULT_ROW_HEIGHT = &quot;24px&quot;, DEFAULT_COL_WIDTH = &quot;100px&quot;;

            const compressStyle = s =&gt; s ? s.replace(/\s*([:;])\s*/g, &quot;$1&quot;).replace(/;$/, &quot;&quot;) : &quot;&quot;;

            document.querySelectorAll(&quot;#spreadsheet tbody td&quot;).forEach(cell =&gt; {
                const r = +cell.dataset.row, c = +cell.dataset.col;
                const arr = [r, c];
                const v = cell.hidden ? (cell.dataset.originalValue || &quot;&quot;) : cell.textContent.trim();
                if (v) arr[2] = v;
                const f = (cell.dataset.formula || &quot;&quot;).trim();
                if (f) arr[3] = f;
                const s = compressStyle(cell.getAttribute(&quot;style&quot;) || &quot;&quot;);
                if (s) arr[4] = s;
                const cs = +cell.getAttribute(&quot;colspan&quot;) || DEFAULT_COLSPAN;
                if (cs !== DEFAULT_COLSPAN) arr[5] = cs;
                const rs = +cell.getAttribute(&quot;rowspan&quot;) || DEFAULT_ROWSPAN;
                if (rs !== DEFAULT_ROWSPAN) arr[6] = rs;
                mergeKeys.forEach((k, i) =&gt; { if (cell.dataset[k] != null) arr[7 + i] = cell.dataset[k]; });
                if (arr.length &gt; 2) savedCells.push(arr);
            });

            const savedRows = Array.from(document.querySelectorAll(&quot;#spreadsheet tbody tr&quot;))
                .map(tr =&gt; { const h = getComputedStyle(tr).height; return h === DEFAULT_ROW_HEIGHT ? null : [+tr.dataset.row, h]; }).filter(Boolean);

            const savedColumns = Array.from(document.querySelectorAll(&quot;#spreadsheet thead th&quot;))
                .map((th, c) =&gt; { const w = getComputedStyle(th).width; return w === DEFAULT_COL_WIDTH ? null : [c, w]; }).filter(Boolean);

            const zoom = document.getElementById(&quot;zoom-slider&quot;)?.value || &quot;100&quot;;

            const jsonStr = JSON.stringify([savedCells, savedRows, savedColumns, zoom]);
            localStorage.setItem(&quot;spreadsheetData&quot;, compressData(jsonStr));
            loadingstate.textContent = &quot;保存しました。&quot;;
            updateLocalStorageUsage();
        } catch (err) {
            console.error(&quot;保存エラー:&quot;, err);
            loadingstate.textContent = &quot;保存エラーが発生しました。&quot;;
        }
    }, 300);
}

function loadSpreadsheetData() {
    const savedStr = localStorage.getItem(&quot;spreadsheetData&quot;);
    if (!savedStr) return loadingstate.textContent = &quot;データがありません&quot;;
    let data;
    try {
        data = JSON.parse(decompressData(savedStr));
        loadingstate.textContent = &quot;読み込み中...&quot;;
    } catch {
        loadingstate.textContent = &quot;データがありません&quot;;
        return;
    }
    const [cells, rows, columns, zoomVal] = data;
    const slider = document.getElementById(&quot;zoom-slider&quot;),
        display = document.getElementById(&quot;zoom-display&quot;),
        bar = document.getElementById(&quot;loading-progress-bar&quot;);
    if (slider &amp;&amp; display &amp;&amp; container) {
        const z = +(`${zoomVal}`.replace(&quot;%&quot;, &quot;&quot;)) || 100;
        slider.value = z;
        display.textContent = z + &quot;%&quot;;
        spreadsheetContent.style.zoom = z / 100;
    }
    const maxRow = Math.max(0, ...(cells || []).map(c =&gt; +c[0]));
    if (maxRow &gt;= rowCount) loadRows(maxRow - rowCount + 1);
    (rows || []).forEach(r =&gt; getRow(r[0])?.style &amp;&amp; (getRow(r[0]).style.height = r[1]));
    (columns || []).forEach(c =&gt; {
        const th = document.querySelector(`#spreadsheet thead th:nth-child(${c[0] + 1})`);
        if (th) th.style.width = c[1];
    });
    const mergeKeys = [&quot;mergeAnchorRow&quot;, &quot;mergeAnchorCol&quot;, &quot;mergeMinRow&quot;, &quot;mergeMinCol&quot;, &quot;mergeMaxRow&quot;, &quot;mergeMaxCol&quot;];
    const batchSize = 1500;
    let index = 0, total = cells.length;
    // ① 全セル復元（数式は dataset にセットするだけ）
    function restoreCells() {
        const end = Math.min(index + batchSize, total);
        for (; index &lt; end; index++) {
            const d = cells[index];
            const cell = getCell(d[0], d[1]);
            if (!cell) continue;
            if (d[5] &gt; 1) cell.setAttribute(&quot;colspan&quot;, d[5]); else cell.removeAttribute(&quot;colspan&quot;);
            if (d[6] &gt; 1) cell.setAttribute(&quot;rowspan&quot;, d[6]); else cell.removeAttribute(&quot;rowspan&quot;);
            if (d[3]) cell.dataset.formula = d[3];
            else { if (cell.textContent !== (d[2] ?? &quot;&quot;)) cell.textContent = d[2] ?? &quot;&quot;; delete cell.dataset.formula; }
            if (cell.style.cssText !== d[4]) cell.style.cssText = d[4] || &quot;&quot;;
            mergeKeys.forEach((k, i) =&gt; { if (d[7 + i] != null) cell.dataset[k] = d[7 + i]; else delete cell.dataset[k]; });
        }
        if (bar) bar.style.width = `${Math.min((index / total) * 100, 100)}%`;
        if (index &lt; total) requestAnimationFrame(restoreCells);
        else evaluateAllFormulas();
    }
    // ② 全セル数式評価（依存関係対応）
    function evaluateAllFormulas() {
        setupRowVisibilityObserver();
        loadingstate.textContent = &quot;読み込み完了&quot;;
        if (bar) bar.style.width = &quot;0%&quot;;
        const all = Array.from(document.querySelectorAll(&quot;#spreadsheet tbody td&quot;));
        // 簡易的に複数回評価することで下&rarr;上依存にも対応
        const maxPasses = 5;
        for (let pass = 0; pass &lt; maxPasses; pass++) {
            all.forEach(td =&gt; {
                if (td.dataset.formula) {
                    try { td.textContent = evaluateFormula(td.dataset.formula); }
                    catch (e) { /* 依存セル未準備の場合は無視 */ }
                }
            });
        }
        all.forEach(td =&gt; td.classList.add(&quot;borderss&quot;));
        requestAnimationFrame(() =&gt; all.forEach(td =&gt; td.classList.remove(&quot;borderss&quot;)));
    }
    if (total) restoreCells();
    else { setupRowVisibilityObserver(); loadingstate.textContent = &quot;読み込み完了&quot;; }
}

/* ----- ヘルパー関数 ----- */
function getRow(rowNumber) {
    return document.querySelector(`#spreadsheet tbody tr[data-row=&#039;${rowNumber}&#039;]`);
}

function debounce(fn, delay) {
    var timer;
    return function () {
        var args = arguments;
        clearTimeout(timer);
        timer = setTimeout(function () {
            fn.apply(null, args);
        }, delay);
    };
}

function throttle(fn, delay) {
    var last = 0;
    return function () {
        var now = Date.now();
        if (now - last &gt;= delay) {
            last = now;
            fn.apply(null, arguments);
        }
    };
}

/* ----- 行可視化監視（完全即時反映・最軽量・横スクロール対応・初期ロード堅牢） ----- */
let rowObserver = null, visibleCols = [];
if (!container || !table) console.warn(&quot;spreadsheet-container または spreadsheet が見つかりません。&quot;);

/* 横方向で見えている列を計算（キャッシュ＆最小DOM計測） */
let _lastColCheck = 0, _cachedHeader = null, _cachedContainerRect = null;
const computeVisibleColumns = () =&gt; {
    const now = performance.now();
    if (now - _lastColCheck &lt; 20) return; // 余分な再計算を防止
    _lastColCheck = now;

    _cachedContainerRect = container?.getBoundingClientRect?.();
    if (!_cachedContainerRect || !table) return;

    const h = _cachedHeader ||= table.querySelector(&quot;thead tr&quot;) || table.querySelector(&quot;tbody tr&quot;);
    if (!h) return (visibleCols = []);

    const cleft = _cachedContainerRect.left;
    const cright = _cachedContainerRect.right;
    const cells = h.children;
    const len = cells.length;
    if (visibleCols.length !== len) visibleCols = new Array(len);

    for (let i = 0; i &lt; len; i++) {
        const r = cells[i].getBoundingClientRect();
        visibleCols[i] = !(r.right &lt; cleft || r.left &gt; cright);
    }
};

/* 行とセルの可視性を即時反映（差分のみ更新） */
const applyRowVisibility = (row, vis) =&gt; {
    const active = document.activeElement;
    const v = vis || row.contains(active);
    const rowVis = v ? &quot;visible&quot; : &quot;hidden&quot;;
    if (row.style.visibility !== rowVis)
        row.style.visibility = rowVis;

    const cols = visibleCols;
    const cells = row.children;
    for (let i = 0, len = cells.length; i &lt; len; i++) {
        const cell = cells[i];
        const show = ((cols[i] ?? true) &amp;&amp; v) || cell.contains(active);
        const s = show ? &quot;visible&quot; : &quot;hidden&quot;;
        if (cell.style.visibility !== s)
            cell.style.visibility = s;
    }
};

function setupRowVisibilityObserver() {
    if (!container || !table) return;
    rowObserver?.disconnect();
    rowObserver = new IntersectionObserver(entries =&gt; {
        computeVisibleColumns(); // 即時更新
        for (let i = 0; i &lt; entries.length; i++) {
            const e = entries[i];
            const r = e.target;
            const v = e.isIntersecting || r.contains(document.activeElement);
            if (r.dataset.visible !== String(v)) {
                r.dataset.visible = String(v);
                applyRowVisibility(r, v); // 即時反映
            }
        }
    }, { root: container, threshold: 0 });
    const rows = table.querySelectorAll(&quot;tbody tr&quot;);
    for (let i = 0, len = rows.length; i &lt; len; i++)
        rowObserver.observe(rows[i]);
    // ✅ ここで初期状態を即時反映
    updateVisibilityNow();
}
/* ----- 即時反映トリガ関数（手動実行用） ----- */
function updateVisibilityNow() {
    if (!container || !table) return;
    // 最新の横列可視状態を計算
    computeVisibleColumns();
    const rows = table.querySelectorAll(&quot;tbody tr&quot;);
    const containerRect = container.getBoundingClientRect();
    const top = containerRect.top;
    const bottom = containerRect.bottom;
    const active = document.activeElement;
    for (let i = 0, len = rows.length; i &lt; len; i++) {
        const row = rows[i];
        const rect = row.getBoundingClientRect();
        // 行の可視判定
        const visible = !(rect.bottom &lt; top || rect.top &gt; bottom) || row.contains(active);
        row.dataset.visible = String(visible);
        // 行＋セルを即時反映
        applyRowVisibility(row, visible);
    }
}

/* 初期描画時に即座に反映 */
const markInitialRowVisibility = () =&gt; {
    _cachedContainerRect = container?.getBoundingClientRect?.();
    if (!_cachedContainerRect || !table) return;
    const active = document.activeElement;
    const rows = table.querySelectorAll(&quot;tbody tr&quot;);
    const top = _cachedContainerRect.top;
    const bottom = _cachedContainerRect.bottom;

    for (let i = 0, len = rows.length; i &lt; len; i++) {
        const r = rows[i];
        const b = r.getBoundingClientRect();
        const v = !(b.bottom &lt; top || b.top &gt; bottom) || r.contains(active);
        r.dataset.visible = String(v);
        applyRowVisibility(r, v);
    }
};

/* 横スクロール時も即時反映 */
const onContainerScroll = () =&gt; {
    computeVisibleColumns();
    const rows = document.querySelectorAll(&quot;#spreadsheet tbody tr&quot;);
    const visCols = visibleCols;
    const active = document.activeElement;

    for (let i = 0, len = rows.length; i &lt; len; i++) {
        const r = rows[i];
        const v = r.dataset.visible === &quot;true&quot; || r.contains(active);
        const cells = r.children;
        for (let j = 0, cLen = cells.length; j &lt; cLen; j++) {
            const cell = cells[j];
            const show = ((visCols[j] ?? true) &amp;&amp; v) || cell.contains(active);
            const s = show ? &quot;visible&quot; : &quot;hidden&quot;;
            if (cell.style.visibility !== s)
                cell.style.visibility = s;
        }
    }
};

/* 初期化（完全同期・再初期化対応） */
function initVisibilityControllerRobust() {
    if (!container || !table)
        return document.readyState === &quot;loading&quot;
            ? document.addEventListener(&quot;DOMContentLoaded&quot;, initVisibilityControllerRobust, { once: true })
            : console.warn(&quot;initVisibilityControllerRobust: container/table 未検出。&quot;);

    computeVisibleColumns();
    markInitialRowVisibility();
    setupRowVisibilityObserver();

    const tbody = table.querySelector(&quot;tbody&quot;);
    if (tbody) {
        const mo = new MutationObserver(records =&gt; {
            for (let i = 0; i &lt; records.length; i++) {
                if (records[i].addedNodes.length) {
                    computeVisibleColumns();
                    markInitialRowVisibility();
                    setupRowVisibilityObserver();
                    break;
                }
            }
        });
        mo.observe(tbody, { childList: true });
    }

    container.addEventListener(&quot;scroll&quot;, onContainerScroll, { passive: true });
    window.addEventListener(&quot;resize&quot;, () =&gt; {
        computeVisibleColumns();
        const rows = document.querySelectorAll(&quot;#spreadsheet tbody tr&quot;);
        for (let i = 0, len = rows.length; i &lt; len; i++)
            applyRowVisibility(rows[i], rows[i].dataset.visible === &quot;true&quot;);
    });
}

/* 実行 */
initVisibilityControllerRobust();

// =======================
// 高性能ズーム（最適化版）
// =======================

const zoomSlider = document.getElementById(&quot;zoom-slider&quot;);
const zoomDisplay = document.getElementById(&quot;zoom-display&quot;);

const MIN_ZOOM = 20, MAX_ZOOM = 200;
const ZOOM_STEP = 5; // スライダー・ホイール・ピンチ共通刻み

let savedData = { zoom: &quot;100%&quot; };
let zoomValue = parseInt(savedData.zoom) || 100;       // 内部丸め済み値
let pendingZoomValue = zoomValue;                      // 操作中の連続値

// スライダー初期化
zoomSlider.value = zoomValue;
zoomDisplay.textContent = zoomValue + &quot;%&quot;;
spreadsheetContent.style.zoom = zoomValue / 100;

// ---------------- rAF でまとめて DOM 更新 ----------------
let pendingZoomUpdate = false;
function applyZoom() {
    if (pendingZoomUpdate) return;
    pendingZoomUpdate = true;
    requestAnimationFrame(() =&gt; {
        const displayZoom = Math.min(MAX_ZOOM, Math.max(MIN_ZOOM, Math.round(pendingZoomValue / ZOOM_STEP) * ZOOM_STEP));
        spreadsheetContent.style.zoom = displayZoom / 100;
        zoomDisplay.textContent = displayZoom + &quot;%&quot;;
        zoomSlider.value = displayZoom;
        zoomValue = displayZoom;
        // 🔹 ズーム後に可視セルを更新
        document.querySelectorAll(&quot;#spreadsheet tbody tr&quot;).forEach(setupRowVisibilityObserver);
        pendingZoomUpdate = false;
    });
}

// ---------------- スライダー ----------------
zoomSlider.addEventListener(&quot;input&quot;, () =&gt; {
    pendingZoomValue = parseInt(zoomSlider.value);
    applyZoom();
});

// ---------------- Ctrl + ホイール ----------------
document.addEventListener(&quot;wheel&quot;, (e) =&gt; {
    if (!e.ctrlKey) return;
    e.preventDefault();
    const step = (e.deltaY &lt; 0 ? ZOOM_STEP : -ZOOM_STEP);
    pendingZoomValue = Math.min(MAX_ZOOM, Math.max(MIN_ZOOM, pendingZoomValue + step));
    applyZoom();
}, { passive: false });

// ---------------- ピンチ ----------------
let isPinching = false;
let initialPinchDistance = null;
let initialPinchZoom = null;

const pinchSensitivity = 0.03;
const pinchMinRatioChange = 0.005; // デッドゾーン拡大
const pinchMinPxChange = 2;

document.addEventListener(&quot;touchstart&quot;, (e) =&gt; {
    if (e.touches.length === 2) {
        isPinching = true;
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        initialPinchDistance = Math.sqrt(dx * dx + dy * dy);
        initialPinchZoom = pendingZoomValue; // 現在の連続値を基準
    }
}, { passive: true });

document.addEventListener(&quot;touchmove&quot;, (e) =&gt; {
    if (!isPinching || e.touches.length !== 2) return;
    e.preventDefault();

    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const distance = Math.sqrt(dx * dx + dy * dy);

    if (!initialPinchDistance || initialPinchDistance &lt;= 0) return;

    const ratio = distance / initialPinchDistance;
    if (Math.abs(ratio - 1) &lt; pinchMinRatioChange &amp;&amp; Math.abs(distance - initialPinchDistance) &lt; pinchMinPxChange) return;

    // 非線形補正（穏やかに拡大縮小）
    pendingZoomValue = initialPinchZoom * Math.pow(ratio, pinchSensitivity);
    applyZoom();
}, { passive: false });

function endPinch() {
    isPinching = false;
    initialPinchDistance = null;
    initialPinchZoom = null;
}
document.addEventListener(&quot;touchend&quot;, (e) =&gt; { if (e.touches.length &lt; 2) endPinch(); }, { passive: true });
document.addEventListener(&quot;touchcancel&quot;, endPinch, { passive: true });

// localStorage の使用量（バイト単位）を計算する関数（UTF-16：1文字＝2バイトと概算）
function getLocalStorageUsage() {
    let total = 0;
    for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
            total += (key.length + localStorage.getItem(key).length) * 2;
        }
    }
    return total;
}

// バイト数を分かりやすい単位に変換する関数
function formatBytes(bytes) {
    if (bytes &lt; 1024) return bytes + &quot; bytes&quot;;
    else if (bytes &lt; 1024 * 1024) return (bytes / 1024).toFixed(2) + &quot; KB&quot;;
    else return (bytes / (1024 * 1024)).toFixed(2) + &quot; MB&quot;;
}

// localStorage の総容量・使用量・残り容量をそれぞれ更新する関数
function updateLocalStorageUsage() {
    const MAX = 5 * 1024 * 1024;
    const used = getLocalStorageUsage();
    const rem = MAX - used;
    const elems = {
        localStorageTotal: `全体容量: ${formatBytes(MAX)}`,
        localStorageUsed: `使用量: ${formatBytes(used)}`,
        localStorageRemaining: `残り容量: ${formatBytes(rem)}`
    };
    for (const id in elems) {
        const el = document.getElementById(id);
        if (el) el.textContent = elems[id];
    }
}

// ページ読み込み時に更新（必要に応じて保存後にも呼び出してください）
document.addEventListener(&quot;DOMContentLoaded&quot;, updateLocalStorageUsage);

// ページ読み込み時に保存データを自動的に読み込む
window.addEventListener(&quot;load&quot;, function () {
    loadSpreadsheetData();
});

// -------------------------
// 初期状態の生成：列・行ともに
// -------------------------
initializeColumns(INITIAL_COLUMNS);
loadRows(INITIAL_ROWS);

// プルダウンボタン

document.querySelectorAll(&quot;.pulldown_btn&quot;).forEach(pulldown =&gt; {
    pulldown.addEventListener(&quot;mousedown&quot;, function (e) {
        document.querySelectorAll(&quot;.pulldown_menu&quot;).forEach(pulldown_menu =&gt; {
            pulldown_menu.style.display = &quot;none&quot;;
        })
        const pulldown_menu = pulldown.closest(&quot;.pulldown_menu_parent&quot;).children[1];
        if (pulldown_menu.style.display == &quot;block&quot;) {
            pulldown_menu.style.display = &quot;none&quot;;
        } else {
            pulldown_menu.style.display = &quot;block&quot;;
        }

    })
});
                </textarea>
                </code>
            </div>
            <progress id="myProgress" value="50" max="100"></progress>
        </div>

        <div class="setup" style="display: none; position: absolute; top: 0px; width: 100%; height: 100%;">
            <img src="nexser_image/Windows95_wallpaper.jpg"
                style="height: 100%; width: 100%; position: absolute; z-index: 0;"></img>
            <div class="setup_windows" style="z-index: 1;">
                <p style="font-size: 50px; position: absolute; top: 0px; color: white; font-weight: bold;">Nexser Setup
                </p>
            </div>
        </div>

        <div class="nexser_boot_menu"
            style="font-family: Courier; border: double 5px white; box-shadow: 7.5px 7.5px #888888; width: 500px; height: 30vh; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <br>
            <div style="text-align: center; margin-top: 30px;">
                <p class="nexser_bootmenu_text">text</p>
                <p class="nexser_bootmenu_text2">text2</p>
            </div>
            <div style="position: absolute; bottom: 20px;">
                <span style="margin-left: 100px;" class="program_border boot_sound hover_blue" onclick="nexser_start()">
                    &emsp;はい&emsp;</span>
                <span style="margin-left: 50px;" class="program_border hover_red" onclick="nexser_start()">
                    &emsp;スキップして起動する&emsp;</span>
            </div>
        </div>

        <div id="nexser_program">
            <div>
                <p style="text-align: center;" class="white_text">NEXSER PROGRAM</p>
                <div style=" border: double 5px white; border-color: darkblue; height: 90vh; background-color:
                    #DCDCDC;">
                    <p>NEXSER PROGRAM STARTUP LIST</p>
                    <div class="mini_window" style="border-color: darkblue;">
                        <ul style="column-count: 2;">
                            <li>my computer:&emsp;<span class="startup_computer">OFF</span></li>
                            <li>note pad:&emsp;<span class="startup_note">OFF</span></li>
                            <li>color_property:&emsp;<span class="startup_color">OFF</span></li>
                            <li>screen text:&emsp;<span class="startup_screen">OFF</span></li>
                            <li>htmlviewer edit:&emsp;<span class="startup_htmlviewer_edit">OFF</span></li>
                            <li>guide book:&emsp;<span class="startup_guidebook">OFF</span></li>
                            <li>objective sheet:&emsp;<span class="startup_objective">OFF</span></li>
                            <li>calendar:&emsp;<span class="startup_calendar">OFF</span></li>
                        </ul><br>
                    </div>
                    <div class="mini_window" style="border-color: darkblue;">
                        <div style="width: 100%; border-bottom: solid 1px darkblue;">STARTUP MODE</div>
                        <ul>
                            <li>speed:&emsp;<span class="startup_speed">LOW</span></li>
                            <li>auto startup:&emsp;<span class="auto_startup">OFF</span></li>
                        </ul><br>
                    </div>
                    <div class="mini_window" style="border-color: darkblue;">
                        <div style="width: 100%; border-bottom: solid 1px darkblue;">DRIVER</div>
                        <ul>
                            <li>sound:&emsp;<span class="startup_sound">INSTALL</span></li>
                        </ul><br>
                    </div>
                    <div class="mini_window" style="border-color: darkblue;">
                        <div style="width: 100%; border-bottom: solid 1px darkblue;">SCREEN MODE</div>
                        <ul>
                            <li>desktop version text:&emsp;<span class="startup_versiontext">OFF</span></li>
                        </ul>
                    </div>
                    <div class="hover_red" style="margin-top: 30px;" onclick="nexser_program_close()">
                        EXIT PROGRAM</div>
                </div>

            </div>
        </div>

        <div class="restart_text white_text">
            <p>nexser is now restarting...</p>
        </div>

        <div id="nexser">

            <div class="screen_light"></div>

            <div class="pattern_backgrounds" style="position: absolute; display: none; width: 100%; height: 100%;">
                <div class="backgrounds1"></div>
                <div class="backgrounds2"></div>
                <div class="backgrounds3"></div>
                <div class="backgrounds4"></div>
                <div class="backgrounds5"></div>
                <div class="backgrounds6"></div>
                <div class="backgrounds7"></div>
                <div class="backgrounds8"></div>
                <div class="backgrounds9"></div>
            </div>

            <div class="nexser_background_image">
                <div class="nexser_backgroundimage">
                    <img class="nexser_backgroundimage_child" loading="lazy">
                </div>
            </div>

            <div class="child_windows window_nosearch pass_signin_menu content_center back_silver active">
                <div class="title">
                    <span class="title_icon"></span><span>password</span>
                </div>
                <div class="title_buttons">
                    <span class="close_button button2 pointer_none"></span><br>
                </div>
                <div class="window_contents">
                    <form autocomplete="off" method="get" onsubmit="return false;">
                        <input class="large border2" type="password" id="pass_form" maxlength="4" autocomplete="off"
                            style="height: 20px; margin-top: 10px; width: 290px;">
                        <input type="submit" class="button2 apply_button" value="実行"
                            style="margin-top: 5px; height: 25px;" onclick="password_login()">
                        <span class="red_text pass_no" style="margin: 5px;"></span>
                    </form>
                </div>
            </div>

            <div class="child_windows welcome_menu back_silver active window_nosearch">
                <div class="title">
                    <span class="title_icon"></span><span>welcome nexser beta</span>
                </div>

                <div class="title_buttons">
                    <span class="drag_button">&nbsp;</span>
                    <span class="button2 startnexser_close close_button pointer_none" onclick="sound_stop()"></span>
                </div>

                <div class="window_contents back_silver">
                    <div class="welcome_icons" style="display: none;">
                        <span class="welicon_1"></span>
                        <span class="welicon_2"></span>
                    </div>
                    <div class="mini_window">
                        <p class="welcome_text1">Welcome Nexser</p>
                        <p class="welcome_underline"
                            style="position: absolute; top: 75px; border-top: solid 2px black;"></p>
                        <span class="welcome_text2 border2"
                            style="background: whitesmoke; margin-top: 70px; margin-left: 5px; width: 350px; height: 260px; font-size: small; font-weight: bold; position: absolute; overflow-y: scroll;">
                            <p>nexserへようこそ!<br>このnexserはPCに搭載されている&nbsp;windows&nbsp;に近い操作が可能です。(一部操作が異なります。)<br>バグ・不具合が発生した場合にはページを再ロードしてください。
                            </p>
                            <ul>
                                <li>[&emsp;利用規約&emsp;]</li>
                                <li>・本体のコードのコピー禁止。</li>
                                <li>・プライバシー情報は第三者へ提供しないこと。</li>
                                <li>[&emsp;利用する際の注意&emsp;]</li>
                                <li>・保存したデータは他のパソコンに共有が出来ません。(外部にデータ出力すれば引継ぎ可能)</li>
                                <li class="x-large bold">注意</li>
                                <li class="red_text">・各ブラウザの仕様により、保存したデータが一週間で消える可能性があります。(永続的に残る場合もある。)</li>
                                <li class="red_text">・ブラウザの履歴を消すと、Nexserに保存したデータも消えます。(ブラウザの設定によります。)</li>
                                <li class="red_text">・データが消えないようにするためには、定期的に保存してください。</li>
                                <li class="red_text">・(※各端末の容量により、保存できるデータ量が異なります。)</li>
                            </ul>
                        </span>
                        <p style="position: absolute; bottom: 0;" class="nexser_title_text"></p>
                        <button class="button2 start_nexser borderinline_dotted"
                            onmouseup="nexser_on(),sound_stop()"><span>&emsp;start nexser&emsp;</span></button>
                        <div class="login_form">
                            <p class="bold small">毎ログイン時にこの画面を表示させる。</p>
                            <div class="login_buttons" style="display: flex;">
                                <span style="display: block;"
                                    class="button2 login_welcome apply_button borderinline_dotted">&emsp;YES&emsp;</span>
                                <span style="display: block;"
                                    class="button2 nologin_welcome apply_button borderinline_dotted">&emsp;NO&emsp;</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="desktop" class="nexser_desktop">
                <span class="white_text desktop_version_text nexser_title_text"
                    style="display: none; position: absolute; bottom: 40px;"></span>

                <span id="background_text"></span>

                <div id="files">
                    <ul class="files_inline">
                        <div class="desktop_files test_button parentss">
                            <li class="desktop_files_text editable">main</li>
                            <span class="dli-folder"></span>
                        </div>
                        <div class="desktop_files test_button2 parentss">
                            <li class="desktop_files_text editable">my_computer</li>
                            <span class="dli-folder"></span>
                        </div>
                        <div class="desktop_files test_button3 parentss">
                            <li class="desktop_files_text editable">control_panel</li>
                            <span class="dli-folder"></span>
                        </div>
                        <div class="desktop_files test_button15 parentss">
                            <li class="desktop_files_text editable">accessory</li>
                            <span class="dli-folder"></span>
                        </div>
                        <div class="desktop_files test_button6 parentss">
                            <li class="desktop_files_text editable">prompt</li>
                            <span class="dli-folder"></span>
                        </div>
                        <div class="desktop_files trash_can parentss">
                            <li class="desktop_files_text editable">trash</li>
                            <div class="trash-bin">
                                <span class="lid"></span>
                                <span class="mesh"></span>
                            </div>
                        </div>
                    </ul>
                </div>

                <div id="soft_windows">

                    <div class="child_windows file_windows main resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>main</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;window&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="window_half_big">window half big</li>
                                        <li class="windowsize_reset">window size reset</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;view&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="allwindow_toolbar">allwindow toolbar</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_tool">
                            <div class="windowtool_buttons">
                                <div class="windowtool_buttons_child">
                                </div>
                            </div>
                        </div>

                        <div class="window_contents border2">
                            <ul class="black_text window_inline_list">
                                <div class="window_files test_button3">
                                    <li>control_panel</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button6">
                                    <li>prompt</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button2">
                                    <li>my_computer</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button23">
                                    <li>file setting</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files document_button">
                                    <li>my document</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button35">
                                    <li>taskbar properties</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files">
                                    <li>test</li><span class="window_file_icon2"></span>
                                </div>
                            </ul>
                        </div>
                    </div>

                    <div class="child_windows file_windows my_computer resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>my computer</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;window&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="window_half_big">window half big</li>
                                        <li class="windowsize_reset">window size reset</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;view&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="allwindow_toolbar">allwindow toolbar</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_tool">

                            <div class="windowtool_buttons">
                                <div class="windowtool_buttons_child">
                                </div>
                            </div>

                        </div>

                        <div class="window_contents border2">
                            <ul class="black_text window_inline_list">
                                <div class="window_files test_button">
                                    <li>main</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button5">
                                    <li>system</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button14">
                                    <li>window mode</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button15">
                                    <li>accessory</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button24">
                                    <li>debug</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button37">
                                    <li>device</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button33">
                                    <li>browser</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files">
                                    <li>test</li><span class="window_file_icon2"></span>
                                </div>
                            </ul>
                        </div>
                    </div>

                    <div class="child_windows file_windows browser_menu resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>browser</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;window&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="window_half_big">window half big</li>
                                        <li class="windowsize_reset">window size reset</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;view&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="allwindow_toolbar">allwindow toolbar</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_tool">

                            <div class="windowtool_buttons">
                                <div class="windowtool_buttons_child">
                                </div>
                            </div>

                        </div>

                        <div class="window_contents border2">
                            <ul class="black_text window_inline_list">
                                <div class="window_files" onclick='processUrl("https://www.google.com/", "google")'>
                                    <li>Google</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files" onclick='processUrl("https://www.yahoo.co.jp/", "yahoo")'>
                                    <li>Yahoo!</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files" onclick='processUrl("https://www.bing.com/", "bing")'>
                                    <li>Bing</li><span class="window_file_icon"></span>
                                </div>
                            </ul>
                        </div>
                    </div>

                    <div class="child_windows note_pad back_silver resize active">
                        <div class="title">
                            <span class="title_icon"></span><span class="note_title">notepad</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button2 button2 note_close"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="title2" style="border-bottom: solid 1px black;">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;font size&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li onclick="notetext_size('notetext_small')">small</li>
                                        <li onclick="notetext_size('notetext_medium')">medium</li>
                                        <li onclick="notetext_size('notetext_large')">large</li>
                                        <li onclick="notetext_size('notetext_x-large')">x-large</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;window&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="window_half_big">window half big</li>
                                        <li class="windowsize_reset">window size reset</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;alltext&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <p class="bold small underline" style="text-align: left; padding-right: 20px;">
                                            Text decoration</p>
                                        <li class="notetext_bold" onclick="notetext_all_bold()">bold</li>
                                        <li class="notetext_oblique" onclick="notetext_all_oblique()">oblique</li>
                                        <li class="notetext_underline" onclick="notetext_all_underline()">underline</li>
                                        <div class="note_text_color">
                                            <p class="bold small underline" style="text-align: left;">Text color</p>
                                            <li onclick="notecolor_remove()">black</li>
                                            <li onclick="notecolor_change('blue')">blue</li>
                                            <li onclick="notecolor_change('green')">green</li>
                                            <li onclick="notecolor_change('red')">red</li>
                                            <li onclick="notecolor_change('orange')">orange</li>
                                            <li onclick="notecolor_change('yellow')">yellow</li>
                                        </div>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;setting&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li onclick="note_lineheight()">Note lineHeight</li>
                                        <li onclick="note_textspacing()">Note text spacing</li>
                                        <li onclick="notedata_clear()">Notedata clear</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;edit&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li onclick="notearea_allselect()">select</li>
                                        <li onclick="notearea_time()">time</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_content">
                            <div class="back_silver">
                                <input type="button" class="button2" value="&emsp;save&emsp;" onclick="save()">
                                <input type="button" class="button2" value="&emsp;load&emsp;" onclick="load()">
                                <input type="button" class="button2" value="&emsp;windows2000 text load&emsp;"
                                    onclick="win2000_load()" style="position: absolute; right: 0px; top: 52.5px;">
                                <input type="button" id="cleartextbtn" class="button2" value="&emsp;clear&emsp;">
                            </div>
                            <form name="note_form" class="note_forms">
                                <textarea id="note_text" name="note_area" class="note_area border2 no_over" cols="50"
                                    rows="15"></textarea>
                            </form>
                        </div>
                        <div class="window_bottom">
                            <ul style="display:flex; position: relative; font-size: 12.5px;">
                                <li class="border2">Textcount:&emsp;<span id="inputlength">0</span>
                                </li>
                                <li class="border2" style="margin-left: 20px;">Mode:&emsp;<span
                                        class="test_notetext">Text&nbsp;</span></li>
                                <li class="border2 notetext_lines" style="margin-left: 20px;"></li>
                                <li class="border2" style="margin-left: 20px;" id="memo_save_text">
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="child_windows objective_menu back_silver resize active">
                        <div class="title">
                            <span class="title_icon"></span><span class="objective_title">objective sheet</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button2 button2 objective_close"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="title2" style="border-bottom: solid 1px black;">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;window&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="window_half_big">window half big</li>
                                        <li class="windowsize_reset">window size reset</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_contents back_silver scrollbar_none">
                            <div>
                                <input type="button" class="button2" value="&emsp;save&emsp;"
                                    onclick="objective_save()">
                                <input type="button" class="button2" value="&emsp;load&emsp;"
                                    onclick="objective_load()">
                                <input type="button" id="cleartextbtn3" class="button2" value="&emsp;clear&emsp;">
                                <input type="button" class="button2" value="&emsp;Data clear&emsp;"
                                    onclick="objectiveData_clear()">
                            </div>
                            <span class="border2">タイトルを入力:</span>
                            <form name="objective_title_form" style="display: inline;"
                                onkeydown="if(event.keyCode == 13){return false;}">
                                <textarea id="objective_title_text" name="objective_title_area"
                                    class="objective_title_area border2"
                                    style="resize: none; width: 500px; height: 20px; font-size: large;" cols="1"
                                    rows="1"></textarea>
                            </form>
                            <span class="border2 medium">
                                目標を記入:</span>
                            <form name="objective_form" class="no_over">
                                <textarea id="objective_text" name="objective_area"
                                    class="objective_area border2 no_over" style="overflow: scroll;" cols="50"
                                    rows="15"></textarea>
                            </form>
                        </div>
                    </div>

                    <div class="child_windows windowmode_menu active back_silver">
                        <div class="title">
                            <span class="title_icon"></span><span>window mode</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_contents">
                            <ul class="window_inline_list2 border2" style="background: whitesmoke;">
                                <li class="hover_blue" id="window_invisible">invisible</li>
                                <li class="hover_blue" onclick="windowmode_reset()">default</li>
                            </ul>
                            <p class="red_text back_silver">After imageが有効の場合は使えません</p>
                            <p class="border2">After image: <span class="windowafter">ON</span></p>
                            <p class="border2">Mode: <span class="windowmode">default</span></p>
                        </div>
                    </div>

                    <div class="child_windows file_windows accessory_menu resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>accessory</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;window&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="window_half_big">window half big</li>
                                        <li class="windowsize_reset">window size reset</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;view&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="allwindow_toolbar">allwindow toolbar</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_tool">

                            <div class="windowtool_buttons">
                                <div class="windowtool_buttons_child">
                                </div>
                            </div>

                        </div>

                        <div class="window_contents border2">
                            <ul class="black_text window_inline_list">
                                <div class="window_files test_button7">
                                    <li>clock</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button16">
                                    <li>calc</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button12">
                                    <li>notepad</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button13">
                                    <li>text drop</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button18">
                                    <li>camera</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button19">
                                    <li>htmlviewer edit</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button25">
                                    <li>file download</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button27">
                                    <li>stop watch</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button30">
                                    <li>objective sheet</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button29">
                                    <li>tetris</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button34">
                                    <li>main sweeper</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button31">
                                    <li>calendar</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button32">
                                    <li>cpu bench</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button38">
                                    <li>omikuji</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button40">
                                    <li>paint</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button41">
                                    <li>othello</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button44">
                                    <li>memory game</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files kakeibo_btn">
                                    <li>kakeibo</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button47">
                                    <li>editor</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button48">
                                    <li>url droplist</li><span class="window_file_icon"></span>
                                </div>
                            </ul>
                        </div>
                    </div>

                    <div class="child_windows file_windows control_panel resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>control panel</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;window&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="window_half_big">window half big</li>
                                        <li class="windowsize_reset">window size reset</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;view&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="allwindow_toolbar">allwindow toolbar</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_tool">

                            <div class="windowtool_buttons">
                                <div class="windowtool_buttons_child">
                                </div>
                            </div>

                        </div>

                        <div class="window_contents border2">
                            <ul class="black_text window_inline_list">
                                <div class="window_files test_button8">
                                    <li>sound</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button4">
                                    <li>color_property</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button9">
                                    <li>driver</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button10">
                                    <li>mouse</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button11">
                                    <li>screen text</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button17">
                                    <li>nexser sound</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button22">
                                    <li>font</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button26">
                                    <li>display</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button33">
                                    <li>browser</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button39">
                                    <li>storage monitor</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button42">
                                    <li>nexser files text</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button45">
                                    <li>alarm</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files restriction_btn">
                                    <li>restriction</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button46">
                                    <li>location</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button28">
                                    <li>add programs</li><span class="window_file_icon"></span>
                                </div>
                                <div class="window_files test_button49">
                                    <li>system resource</li><span class="window_file_icon"></span>
                                </div>
                            </ul>
                        </div>
                    </div>

                    <div class="child_windows sound_menu resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>sound</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;window&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="window_half_big">window half big</li>
                                        <li class="windowsize_reset">window size reset</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;sound&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li onclick="sound_stop()">stop</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;view&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="allwindow_toolbar">allwindow toolbar</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_tool">
                        </div>

                        <div class="window_contents border2">
                            <ul class="sound_list" style="background: whitesmoke;">
                            </ul>
                            <div class="window_inline_side" style="font-size: 13.7px;">
                                <ul class="sound_button_list"
                                    style="text-align: center; margin-left: 5px; position: absolute; top: 50px; width: 100px;">
                                </ul>
                            </div>
                        </div>

                    </div>

                    <div class="child_windows nexser_sound_menu resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>nexser sound</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;sound&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li onclick="sound_stop()">stop</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;window&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="window_half_big">window half big</li>
                                        <li class="windowsize_reset">window size reset</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;view&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="allwindow_toolbar">allwindow toolbar</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_tool">
                        </div>

                        <div class="window_contents border2 flex"
                            style="background: whitesmoke; padding:5px; gap:20px; flex-wrap:wrap;">
                            <div id="logon_sounds" class="sound_container" style="flex:1; min-width:300px;"></div>
                            <div id="logoff_sounds" class="sound_container" style="flex:1; min-width:300px;"></div>
                        </div>
                    </div>

                    <div class="child_windows system_menu active">
                        <div class="title">
                            <span class="title_icon"></span><span>system properties</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>

                        <div class="window_content back_silver" style="height: 100%;">
                            <div class="window_inline_menus">

                                <div class="window_inline_menus_parent menuselect">
                                    <ul>
                                        <li>&nbsp;General&nbsp;</li>
                                    </ul>
                                    <div class="window_inline_menus_child">
                                        <p class="window_menus_title">system</p>
                                        <ul style="text-align: left;">
                                            <li class="bold large">
                                                name:&emsp;<span>nexser&copy;</span></li>
                                            <li class="bold"><span>version:&emsp;</span>beta version 1.9
                                            </li><br>
                                            <li class="bold">2024-2025</li>
                                        </ul><br>
                                        <p class="window_menus_title">Edition:</p>
                                        <p class="edition_text bold" style="margin-left: 60px;">Home Edition</p>
                                        <div class="window_menu_right_content border2" style="background-color: black;">
                                            <p class="white_text bold content_center xx-large"
                                                style="font-style: oblique;">
                                                Nexser</p>
                                        </div>

                                    </div>
                                </div>

                                <div class="window_inline_menus_parent">
                                    <ul>
                                        <li>&nbsp;access&nbsp;</li>
                                    </ul>
                                    <div class="window_inline_menus_child">
                                        <p class="bold window_menus_title">Last Access:&emsp;</p>
                                        <span id="lastaccess_day" class="bold"></span>
                                    </div>
                                </div>

                                <div class="window_inline_menus_parent">
                                    <ul>
                                        <li>&nbsp;test3&nbsp;</li>
                                    </ul>
                                    <div class="window_inline_menus_child">
                                        <span>test3</span>
                                    </div>
                                </div>

                                <div class="window_inline_menus_parent">
                                    <ul>
                                        <li>&nbsp;test4&nbsp;</li>
                                    </ul>
                                    <div class="window_inline_menus_child">
                                        <span>test4</span>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <div class="child_windows clock_menu back_silver active">
                        <div class="title">
                            <span class="title_icon"></span><span>clock</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;clock mode&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="clockdata_analog">analog</li>
                                        <li class="clockdata_digital">digital</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;view&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="allwindow_toolbar">allwindow toolbar</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_tool">
                        </div>

                        <div class="window_content">
                            <div class="digital_clock_area border2"
                                style="height: 300px; background: silver; pointer-events: none; color: dimgray; display: flex; flex-direction:column;">
                                <ul class="bold" style="text-shadow: -1px -1px whitesmoke;">
                                    <li class="button x-large">日付:</li>
                                    <li class="date_day" style="font-size: 50px; text-align: center;">DATE</li>
                                </ul>

                                <ul class="bold" style="text-shadow: -1px -1px whitesmoke;">
                                    <li class="button x-large">時間:</li>
                                    <li class="date_clock" style="font-size: 50px; text-align: center;">CLOCK</li>
                                </ul>
                            </div>

                            <div class="analog_clock_area border2" style="background: whitesmoke; display: none;">
                                <canvas width=300 height=300 id="analog_clock"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows color_menu active">
                        <div class="title">
                            <span class="title_icon"></span><span>color property</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>

                        <div class="window_content back_silver" style="padding-top: 10px;">
                            <p><input type="text" id="bkcolor" size="40" class="large border2" autocomplete="off"
                                    placeholder="background">
                            </p>
                            <span>例: red, skyblue, #ffcc00 ...</span>
                            <p><input type="text" id="color" size="40" class="large border2" autocomplete="off"
                                    placeholder="text">
                            </p>
                            <span>例: red, skyblue, #ffcc00 ...</span>
                            <p><button class="button2" id="changeBtn">color set</button></p>
                            <button class="button2" onclick="colordata_clear()">colors data
                                clear</button>
                            <div class="mini_window">
                                <p>Background color</p>
                                <select id="select_backcolor" class="button2">
                                    <option value="">default</option>
                                    <option value=" black">black</option>
                                    <option value="white">white</option>
                                    <option value="gray">gray</option>
                                    <option value="blue">blue</option>
                                    <option value="red">red</option>
                                    <option value="yellow">yellow</option>
                                    <option value="green">green</option>
                                    <option value="purple">purple</option>
                                    <option value="lime">lime</option>
                                    <option value="skyblue">skyblue</option>
                                    <option value="pink">pink</option>
                                    <option value="orange">orange</option>
                                </select>

                                <p>Text color</p>
                                <select id="select_textcolor" class="button2">
                                    <option value="">default</option>
                                    <option value="black">black</option>
                                    <option value="white">white</option>
                                    <option value="gray">gray</option>
                                    <option value="blue">blue</option>
                                    <option value="red">red</option>
                                    <option value="yellow">yellow</option>
                                    <option value="green">green</option>
                                    <option value="purple">purple</option>
                                    <option value="lime">lime</option>
                                    <option value="skyblue">skyblue</option>
                                    <option value="pink">pink</option>
                                    <option value="orange">orange</option>
                                </select>
                                <p><button class="button2" onclick="setStorage()">color set</button></p>
                                <button class="button2" onclick="colordata_clear()">colors data clear</button>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows window_prompt resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>nexser prompt beta</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2" onclick="nexser_prompt_reset()"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;window&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="window_half_big">window half big</li>
                                        <li class="windowsize_reset">window size reset</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;text&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li onclick="prompt2_text_clear()">text clear</li>
                                        <li onclick="nexser_prompt_reset()">reset</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_contents window_prompt_content2">
                            <div id="prompt2" class="prompt_content no_over">
                                <p>[nexser prompt beta version 1.9]</p>
                                <div id="form_container">
                                    <div class="input_container">
                                        <span class="small">nexser/></span><textarea rows="1"
                                            class="command_input2 name2 focus2 command2" placeholder="|"
                                            onkeydown="handleKeyDown(event, this);if(event.keyCode == 13){return false;}"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows window_nosearch prompt_shell_menu resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>nexser shell</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="window_contents" style="position: relative;">
                            <textarea id="shell" class="no_over"
                                style="resize: none; height: 100%; width: 100%;"></textarea>
                        </div>
                    </div>

                    <div class="child_windows command_help_menu resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>command help</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;window&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="window_half_big">window half big</li>
                                        <li class="windowsize_reset">window size reset</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="commands window_contents border2">
                            <ul style="column-count: 2;">
                                <li>screen/full</li>
                                <li>screen/min</li>
                                <li>taskbar/none</li>
                                <li>taskbar/active</li>
                                <li>allwindow/reset</li>
                                <li>allwindow/close</li>
                                <li>allwindow/open</li>
                                <li>file/none</li>
                                <li>file/active</li>
                                <li>window/afterimage/true</li>
                                <li>window/afterimage/false</li>
                                <li style="color: blue;">cpu/bench</li>
                                <li style="color: red;">nexser/data/clear</li>
                                <li style="color: green;">welcome</li>
                                <li style="background: black;  color: white;">reset</li>
                                <li>windows95/open</li>
                                <li>windows2000/open</li>
                                <li>windowsystem/open</li>
                            </ul>
                        </div>

                    </div>

                    <div class="child_windows driver_menu active">
                        <div class="title">
                            <span class="title_icon"></span><span>driver</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>

                        <div class="window_content back_silver">
                            <p style="display: inline;" class="border2">デフォルトドライバー</p>
                            <div class="mini_window border2" style="background: whitesmoke;">
                                <p>sound&emsp;<button class="installbutton_1 button2" id="sound_driver">install</button>
                                </p>
                                <p>(インストールすると音が鳴ります)</p>
                                <p>color&emsp;<button class="installbutton_2 button2" id="color_driver">install</button>
                                </p>
                                <p>(インストールすると色を変更できます)</p>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows mouse_menu active">
                        <div class="title">
                            <span class="title_icon"></span><span>mouse</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="hover logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="border2 window_contents" style="background: whitesmoke;">
                            <p>mouse click</p>
                            <span id="button1" class="button2 borderinline_dotted"
                                style="display: block; box-sizing: border-box; height: 25px; width: 65px;">&nbsp;CLICK!&nbsp;</span>
                            <div class="mini_window" style="display: flex; padding: 5px;">
                                <span class="mouse_left border button2"
                                    style="display: block; text-align: center;">&emsp;left&emsp;</span>
                                <span class="mouse_right border button2"
                                    style="display: block; text-align: center;">&emsp;right&emsp;</span>
                            </div>
                            <div class="mini_window"
                                style="text-align: center; justify-content: center; color: white; width: 200px; background: gray;">
                                <div class="hover_red" style="height: 60px;">
                                    hover_red</div>
                                <div class="hover_blue" style="height: 60px;">
                                    hover_blue</div>
                                <div class="hover_green" style="height: 60px;">
                                    hover_green</div>
                                <div class="mouse_miniwindow border">
                                    <div class="mouse_testbutton">
                                        <p class="bold">click button test</p>
                                        <span class="borderinline_dotted button apply_button2">Button1</span>
                                        <span class="borderinline_dotted button2 apply_button2">Button2</span>
                                        <button class="button2"
                                            style="height: 20px; font-size: large; float: right; position: absolute; left: 25px; top: 110px; transform: scale(2);">▼</button>
                                        <span class="button2 close_button2" style="width: 19px; height: 19px; position: absolute; left: 75px; top:
                                            105px; transform: scale(2);"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows screen_text_menu active">
                        <div class="title">
                            <span class="title_icon"></span><span>screen text</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>

                        <div class="window_content back_silver">
                            <p>background text</p>
                            <form autocomplete="off" method="get" name="back_text_form" class="border2"
                                onsubmit="return false; length" onkeydown="if(event.keyCode == 13){return false;}">
                                <textarea type="text" name="back_text" class="back_text" id="back_text_input"
                                    maxlength="20"
                                    style="border: none; background: whitesmoke; resize: none; height: 16px; width: 100%; font-size: large;"></textarea>
                            </form>
                            <input type="submit" class="button2" value="submit" onclick="backtext_check()">
                            <input type="submit" class="button2" value="clear" onclick="backtext_clear()"><br>
                            <button class="button2" id="backtext_on">&nbsp;backtext on&nbsp;</button><br>
                            <button class="button2" id="backtext_off">&nbsp;backtext off&nbsp;</button>
                            <div class="mini_window">
                                <p>SIZE:&emsp;&emsp;</p>
                                <ul style="column-count: 2;">
                                    <li class="backtext_small"><button class="button2">&nbsp;small&nbsp;</button>
                                    </li>
                                    <li class="backtext_medium"><button class="button2">&nbsp;medium&nbsp;</button>
                                    </li>
                                    <li class="backtext_large"><button class="button2">&nbsp;large&nbsp;</button>
                                    </li>
                                    <li onclick="backtextSize_clear()"><button
                                            class="button2">&nbsp;Reset&nbsp;</button>
                                    </li>
                                </ul>
                            </div>
                            <div class="mini_window">
                                <p><span class="bold">screen preview&emsp;&emsp;</span><span>MODE:&nbsp;</span><span
                                        class="backtext_mode">OFF</span>
                                </p>
                                <div class="mini_screen">
                                    <div class="mini_desktop border2">
                                    </div>
                                    <span id="background_text2"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows display_menu active">
                        <div class="title">
                            <span class="title_icon"></span><span>display</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>

                        <div class="window_content back_silver" style="height: 100%;">
                            <div class="window_inline_menus">

                                <div class="window_inline_menus_parent menuselect">
                                    <ul>
                                        <li>&nbsp;window&nbsp;</li>
                                    </ul>
                                    <div class="window_inline_menus_child">
                                        <p style="margin: 5px;" class="border bold content_left">
                                            window titlebar color</p>
                                        <ul style="display: flex; margin-left: 10px;">
                                            <li class="color_btn button2 titlebar_red" style="background: red;">
                                            </li>
                                            <li class="color_btn button2 titlebar_blue" style="background: blue;">
                                            </li>
                                            <li class="color_btn button2 titlebar_green" style="background: green;">
                                            </li>
                                            <li class="color_btn button2 titlebar_yellow" style="background: yellow;">
                                            </li>
                                            <li class="color_btn button2 titlebar_orange" style="background: orange;">
                                            </li>
                                            <li class="color_btn button2 titlebar_pink" style="background: pink;">
                                            </li>
                                            <li class="color_btn button2 titlebar_purple" style="background: purple;">
                                            </li>
                                            <li class="color_btn button2 titlebar_black" style="background: black;">
                                            </li>
                                            <li class="color_btn button2 titlebar_teal" style="background: teal;">
                                            </li>
                                            <li class="color_btn button2 titlebar_new"
                                                style="background: linear-gradient(to right, #02175e, #A3C1E2);">
                                            </li>
                                            <li class="color_btn button2 titlebar_new2"
                                                style="background: linear-gradient(to right, black, blue);">
                                            </li>
                                            <li class="color_btn button2"></li>
                                        </ul>

                                        <p style="margin: 5px;" class="border bold content_left">
                                            background pattern</p>
                                        <ul style="display: flex; margin-left: 10px;">
                                            <li class="pattern_btn button2 back_pattern_1">
                                                <span class="backgrounds1"></span>
                                            </li>
                                            <li class="pattern_btn button2 back_pattern_2">
                                                <span class="backgrounds2"></span>
                                            </li>
                                            <li class="pattern_btn button2 back_pattern_3">
                                                <span class="backgrounds3"></span>
                                            </li>
                                            <li class="pattern_btn button2 back_pattern_4">
                                                <span class="backgrounds4"></span>
                                            </li>
                                            <li class="pattern_btn button2 back_pattern_5">
                                                <span class="backgrounds5"></span>
                                            </li>
                                            <li class="pattern_btn button2 back_pattern_6">
                                                <span class="backgrounds6"></span>
                                            </li>
                                            <li class="pattern_btn button2 back_pattern_7">
                                                <span class="backgrounds7"></span>
                                            </li>
                                            <li class="pattern_btn button2 back_pattern_8">
                                                <span class="backgrounds8"></span>
                                            </li>
                                            <li class="pattern_btn button2 back_pattern_9">
                                                <span class="backgrounds9"></span>
                                            </li>
                                            <li class="pattern_btn button2"></li>
                                        </ul>

                                        <p style="margin: 5px;" class="border bold content_left">
                                            display</p>
                                        <ul style="display: flex; margin-left: 10px;">
                                            <li class="display_pattern_btn button2">
                                                <span
                                                    style="display: block; height:100%; background: linear-gradient(45deg,black 50%,white 50%);"
                                                    onclick="color_bw()"></span>
                                            </li>
                                            <li class="display_pattern_btn button2">
                                                <span
                                                    style="display: block; height:100%; background: linear-gradient(0deg,black,white);"
                                                    onclick="color_invert()"></span>
                                            </li>
                                            <li class="display_pattern_btn button2">
                                                <span
                                                    style="display: block; height:100%; background: linear-gradient(90deg, darkblue 50%,darkred 50%);"
                                                    onclick="color_hue()"></span>
                                            </li>
                                            <li class="display_pattern_btn button2" onclick="backcolorfilter_clear()">
                                            </li>
                                        </ul>
                                        <div style="margin: 5px;">
                                            <span class="button2"
                                                onclick="titlebtn_left()">タイトルバーボタン配置左にする(再クリックで右)</span>
                                        </div>
                                    </div>


                                </div>

                                <div class="window_inline_menus_parent">
                                    <ul>
                                        <li>&nbsp;screen saver&nbsp;</li>
                                    </ul>
                                    <div class="window_inline_menus_child">
                                        <p class="window_menus_title">setting</p>

                                        <div style="position: absolute; left: 10px; top: 30px; width: 100px;">
                                            <span class="bold large border" style="text-align: left;">MODE:</span>
                                            <span class="button2 saver_on pointer_none apply_button"
                                                style="margin-top: 5px;">&emsp;ON&emsp;</span>
                                            <span style="margin-top: 5px;"
                                                class="button2 saver_off apply_button">&emsp;OFF&emsp;</span>
                                            <span class="bold large border" style="text-align: left;">PREVIEW:</span>
                                            <button class="button2 apply_button" style="margin-top: 5px;"
                                                onclick="screen_saver()">&emsp;TEST&emsp;</button>
                                            <p style="width: 175px;" class="small">(※モードがOFFの場合、<br>プレビューは表示されません)
                                            </p>
                                        </div>

                                        <p class="bold small" style="position: absolute; bottom: 0px;">MODE:<span
                                                class="saver_mode">OFF</span>
                                        </p>

                                        <div
                                            style="position: absolute; left: 200px; top: 30px; width: 120px; text-align: center;">
                                            <span class="bold large border">SECOND:</span><span>(60~900)</span>
                                            <input type="text" class="border2 saver_second large" style="width: 50px;"
                                                placeholder="|" maxlength="3">
                                            <button class="button2 large apply_button"
                                                onclick="savertime()">&emsp;OK&emsp;</button>
                                            <p class="bold">saver time: <span class="screensaver_text">none</span>
                                            </p>
                                            <button class="button2 small apply_button2"
                                                onclick="savertime_clear()">&emsp;タイムリセット&emsp;</button>
                                        </div>

                                        <div
                                            style="position: absolute; left: 400px; top: 30px; width: 150px; height: 100%;">
                                            <span class="bold large border" style="text-align: left;">SCREEN</span>
                                            <span class="large button2 apply_button2" style="margin-top: 5px;"
                                                onclick="set_saver(1)">&emsp;SCREEN 1&emsp;</span>
                                            <span class="large button2 apply_button2" style="margin-top: 5px;"
                                                onclick="set_saver(2)">&emsp;SCREEN 2&emsp;</span>
                                            <span class="large button2 apply_button2" style="margin-top: 5px;"
                                                onclick="set_saver(3)">&emsp;SCREEN 3&emsp;</span>
                                            <p class="bold" style="text-align: left;">SCREEN:&emsp;<span
                                                    class="screen_mode">1</span></p>
                                        </div>

                                    </div>
                                </div>

                                <div class="window_inline_menus_parent">
                                    <ul>
                                        <li>&nbsp;others&nbsp;</li>
                                    </ul>
                                    <div class="window_inline_menus_child">
                                        <ul style="column-count: 3; margin: 5px;">

                                            <div class="border" style="height: 70px;">
                                                <p class="large bold">Full screen</p>
                                                <span class="button2 apply_button"
                                                    onclick="full()">&emsp;ON&emsp;</span>
                                                <span class="button2 apply_button"
                                                    onclick="min()">&emsp;OFF&emsp;</span>
                                            </div>

                                            <div class="border" style="height: 70px;">
                                                <p class="large bold">toolbar</p>
                                                <span class="button2 toolbar_on apply_button">&emsp;ON&emsp;</span>
                                                <span class="button2 toolbar_off apply_button">&emsp;OFF&emsp;</span>
                                            </div>

                                            <div class="border" style="height: 70px;">
                                                <p class="large bold">filetext background</p>
                                                <span
                                                    class="button2 filettext_backcolor_on apply_button">&emsp;ON&emsp;</span>
                                                <span
                                                    class="button2 filettext_backcolor_off apply_button">&emsp;OFF&emsp;</span>
                                            </div>

                                        </ul>
                                        <ul style="column-count: 2; margin: 5px;">
                                            <div class="border" style="height: 70px;">
                                                <p class="large bold">window animation</p>
                                                <span class="button2 apply_button" onclick="window_animation_true()">
                                                    &emsp;ON&emsp;</span>
                                                <span class="button2 apply_button" onclick="window_animation_false()">
                                                    &emsp;OFF&emsp;</span>
                                            </div>

                                            <div class="border" style="height: 70px;">
                                                <p class="large bold">title font</p>
                                                <span class="button2 apply_button"
                                                    onclick="windowtitle_style('italic')">
                                                    &emsp;Italic&emsp;</span>
                                                <span class="button2 apply_button" onclick="windowtitle_style()">
                                                    &emsp;Reset&emsp;</span>
                                            </div>

                                        </ul>
                                    </div>
                                </div>

                                <div class="window_inline_menus_parent">
                                    <ul>
                                        <li>&nbsp;background&nbsp;</li>
                                    </ul>
                                    <div class="window_inline_menus_child">
                                        <p class="window_menus_title">Wallpaper</p>
                                        <ul style="column-count: 0; width: 0; height: 100%;">
                                            <button class="button2 apply_button2 wallpaper_95"
                                                style="margin: 2.5px;">&emsp;Windows95&emsp;</button>
                                            <button class="button2 apply_button2 wallpaper_95_2"
                                                style="margin: 2.5px;">&emsp;Windows95_sky&emsp;</button>
                                            <button class="button2 apply_button2 wallpaper_xp"
                                                style="margin: 2.5px;">&emsp;WindowsXP&emsp;</button>
                                            <button class="button2 apply_button2 wallpaper_space"
                                                style="margin: 2.5px;">&emsp;Space&emsp;</button>
                                            <button class="button2 apply_button2 wallpaper_allremove_btn"
                                                style="margin: 2.5px; margin-top: 20px;">&emsp;CLEAR&emsp;</button>
                                        </ul>
                                        <div class="window_menu_right_content border2 desk_img"
                                            style="background-color: #52adad;">
                                            <img loading="lazy">
                                        </div>
                                    </div>
                                </div>

                                <div class="window_inline_menus_parent">
                                    <ul>
                                        <li>&nbsp;aspect ratio&nbsp;</li>
                                    </ul>
                                    <div class="window_inline_menus_child">
                                        <p class="window_menus_title">display</p>

                                        <div class="border2 small"
                                            style="background: whitesmoke; height: auto; width: 200px; display: inline-block; position: absolute; left: 5px; top: 40px;">
                                            <p>この機能をオンにすると、画面の比率が変わります。</p>
                                        </div>

                                        <div style="position: absolute; bottom: 5px; left: 5px; width: 100%;">
                                            <span class="button2 display_now apply_button"
                                                style="position: absolute; left: 0px; bottom: 0px; width: 80px;">&emsp;NOW&emsp;</span>
                                            <span class="button2 display_old apply_button"
                                                style="position: absolute; left: 90px; bottom: 0px;">&emsp;OLD&emsp;</span>
                                        </div>

                                        <div class="window_menu_right_content border2"
                                            style="background-color: #52adad;">

                                            <div class="mini_windows_sample"
                                                style="pointer-events: none; height: 150px; width: auto; position: absolute; top: 10px; left: 50px;">

                                                <div class="title" style="background-color: navy; text-align: left;">
                                                    <span class="title_icon"></span><span>sample</span>
                                                </div>

                                                <div class="title_buttons">
                                                    <span class="close_button button2"></span>
                                                    <span class="bigminbtn button2"></span>
                                                    <span class="minimization_button button2"></span><br>
                                                </div>

                                                <div class="title2">
                                                    <div class="parent_list">
                                                        <ul>
                                                            <li>&emsp;icon&emsp;</li>
                                                        </ul>
                                                    </div>
                                                </div>

                                                <div class="border2 window_contents" style="height: 100px;">
                                                    <p>test test test test test test test</p>
                                                    <p>text text text text text</p>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>

                                <div class="window_inline_menus_parent">
                                    <ul>
                                        <li>&nbsp;title graphics&nbsp;</li>
                                    </ul>
                                    <div class="window_inline_menus_child">
                                        <p class="window_menus_title">window title shadow
                                        </p>
                                        <div class="border2 small"
                                            style="background: whitesmoke; height: auto; width: 200px; display: inline-block; position: absolute; left: 5px; top: 40px;">
                                            <p>この機能をオンにすると、すべてのウィンドウにあるリストに影が表示されます。<br>(※スタートメニューのリストには影が表示されません。)
                                            </p>
                                        </div>
                                        <div style="position: absolute; bottom: 5px; left: 5px; width: 100%;">
                                            <span class="button2 list_shadow_on apply_button"
                                                style="position: absolute; left: 0px; bottom: 0px;">&emsp;ON&emsp;</span>
                                            <span class="button2 list_shadow_off apply_button"
                                                style="position: absolute; left: 80px; bottom: 0px;">&emsp;OFF&emsp;</span>
                                        </div>
                                        <div class="window_menu_right_content border2"
                                            style="background-color: #52adad;">

                                            <div class="mini_windows_sample"
                                                style="pointer-events: none; height: 150px; width: auto; position: absolute; top: 10px; left: 50px;">

                                                <div class="title" style="background-color: navy; text-align: left;">
                                                    <span class="title_icon"></span><span>sample</span>
                                                </div>

                                                <div class="title_buttons">
                                                    <span class="close_button button2"></span>
                                                    <span class="bigminbtn button2"></span>
                                                    <span class="minimization_button button2"></span><br>
                                                </div>

                                                <div class="title2">
                                                    <div class="parent_list">
                                                        <ul>
                                                            <li>&emsp;icon&emsp;</li>
                                                        </ul>
                                                        <div class="sample_child_list">
                                                            <ul>
                                                                <li class="logoff">Logoff</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="border2 window_contents" style="height: 100px;">
                                                    <p>test test test test test test test</p>
                                                    <p>text text text text text</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows text_drop_menu resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>text drop</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list" style="display: none;">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;window&emsp;</li>
                                </ul>
                                <div class="child_list" style="display: none;">
                                    <ul>
                                        <li class="window_half_big">window half big</li>
                                        <li class="windowsize_reset">window size reset</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_content back_silver">
                            <input type="button" class="button2" value="&emsp;save&emsp;" onclick="save2()">
                            <input type="button" class="button2" value="&emsp;load&emsp;" onclick="load2()">
                            <input type="button" id="cleartextbtn2" class="button2" value="&emsp;clear&emsp;">
                            <form name="drop_form" action="" class="border2" style="display: flex;">
                                <textarea name="drop_area" class="drop_area no_over" id="drop" cols="50" rows="10"
                                    maxlength="0"
                                    style="border: none; resize: none; background: whitesmoke; color: black;"></textarea>
                            </form>
                        </div>
                        <div class="window_bottom" style="position: absolute;">
                            <span id="drop_save_text" class="border2">no save</span>
                        </div>
                    </div>

                    <div class="child_windows calc_menu active">
                        <div class="title">
                            <span class="title_icon"></span><span>calc</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2" onclick="calc_clear()"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;calc&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li onclick="calc2()">四捨五入</li>
                                        <li onclick="calc_clear()">clear</li>
                                        <li onclick="calc_oneremove()">oneremove</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_content border2">

                            <div class="parent_graph border">
                                <span class="child_graph"></span>
                            </div>

                            <div style="background: whitesmoke;">
                                <div class="black_text" style="width: 150px; height: 170px; padding: 5px;">
                                    <input type="text" class="border" id="result"
                                        style="width: 150px; height: 25px; pointer-events: none;">
                                    <div>
                                        <input type="button" class="button2 calc_button" value="1" onclick="edit(this)">
                                        <input type="button" class="button2 calc_button" value="2" onclick="edit(this)">
                                        <input type="button" class="button2 calc_button" value="3" onclick="edit(this)">
                                        <input type="button" class="button2 calc_button" value="+" onclick="edit(this)">
                                    </div>
                                    <div>
                                        <input type="button" class="button2 calc_button" value="4" onclick="edit(this)">
                                        <input type="button" class="button2 calc_button" value="5" onclick="edit(this)">
                                        <input type="button" class="button2 calc_button" value="6" onclick="edit(this)">
                                        <input type="button" class="button2 calc_button" value="-" onclick="edit(this)">
                                    </div>
                                    <div>
                                        <input type="button" class="button2 calc_button" value="7" onclick="edit(this)">
                                        <input type="button" class="button2 calc_button" value="8" onclick="edit(this)">
                                        <input type="button" class="button2 calc_button" value="9" onclick="edit(this)">
                                        <input type="button" class="button2 calc_button" value="/" onclick="edit(this)">
                                    </div>
                                    <div>
                                        <input type="button" class="button2 calc_button" value="0" onclick="edit(this)">
                                        <input type="button" class="button2 calc_button" value="." onclick="edit(this)">
                                        <input type="button" class="button2 calc_button" value="*" onclick="edit(this)">
                                        <input type="button" class="button2 calc_button" value="=" onclick="calc()">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows camera_menu work_no resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>camera</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button2 button2 camera_close"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span>
                            <span class="frame_fullbutton button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_content">
                            <div style="background: black; pointer-events: none;">
                                <video id="v" style="background-color: black;" playsinline></video>
                            </div>
                            <div class="window_bottom" style="display: flex; padding-top: 2px;">
                                <span id="start_camera" class="button2 apply_button"
                                    onclick="startCamera2()">start</span>
                                <span class="button2 apply_button" onclick="stopCamera()">finish</span>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows htmlviewer_edit_menu resize back_silver active">
                        <div class="title">
                            <span class="title_icon"></span><span>html viewer edit</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;window&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="window_half_big">window half big</li>
                                        <li class="windowsize_reset">window size reset</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_content"
                            style="position: relative; width: 100%; height: 100%; overflow: hidden;">
                            <textarea id="editor" class="border2"
                                style="width: calc(100% - 90px); height: calc(100% - 40px); margin-left: 80px;"></textarea>
                            <div style="position: absolute; left: 0px; top: 0px;">
                                <ul style="position: absolute;">
                                    <li class="button2 apply_button"
                                        onclick="editor_loadFromLocalStorage('HTML1'); editor_setCurrentKey('HTML1')">
                                        HTML 1</li>
                                    <li class="button2 apply_button"
                                        onclick="editor_loadFromLocalStorage('HTML2'); editor_setCurrentKey('HTML2')">
                                        HTML 2</li>
                                    <li class="button2 apply_button"
                                        onclick="editor_loadFromLocalStorage('HTML3'); editor_setCurrentKey('HTML3')">
                                        HTML 3</li>
                                    <li class="button2 apply_button"
                                        onclick="editor_loadFromLocalStorage('HTML4'); editor_setCurrentKey('HTML4')">
                                        HTML 4</li>
                                    <li class="button2 apply_button"
                                        onclick="editor_loadFromLocalStorage('HTML5'); editor_setCurrentKey('HTML5')">
                                        HTML 5</li>
                                </ul>
                                <p class="border2" style="margin: 5px; margin-top: 160px;">SELECT:<br><span
                                        class="html_mode pointer_none button" style="color: black;">none</span>
                                </p>
                            </div>

                            <div class="window_bottom back_silver"
                                style="position: relative; height: 32.5px; padding-top: 2px;">
                                <span class="button2 apply_button large bold" onclick="run()"
                                    style="position: absolute; left: 0px; text-align: center;">&nbsp;run&nbsp;</span>
                                <span class="button2 apply_button large bold" onclick="editor_saveCurrentEditorValue()"
                                    style="position: absolute; left: 80px; text-align: center;">&nbsp;save&nbsp;</span>
                                <span class="button2 apply_button2 large bold" onclick="testcode_html()"
                                    style="position: absolute; left: 160px; text-align: center;">&nbsp;sample
                                    code&nbsp;</span>
                                <span class="button2 apply_button large bold" onclick="testcode_clear()"
                                    style="position: absolute; left: 315px; text-align: center;">&nbsp;clear&nbsp;</span>
                            </div>

                        </div>
                    </div>

                    <div class="child_windows htmlviewer_run_menu resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>html viewer run</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span>
                            <span class="frame_fullbutton button2"></span><br>
                        </div>
                        <div class="html_view" style="width: 100%; height: 100%;">
                            <iframe id="preview" class="border2" loading="lazy"></iframe>
                        </div>
                    </div>

                    <div class="child_windows font_menu active">
                        <div class="title">
                            <span class="title_icon"></span><span>font</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_content">
                            <ul class="window_inline_list2 border2" style="background-color: whitesmoke;">
                                <li class="hover_blue font_serif">Font serif</li>
                                <li class="hover_blue font_sans_serif">Font sans serif</li>
                                <li class="hover_blue font_cursive">Font cursive</li>
                                <li class="hover_blue font_fantasy">Font fantasy</li>
                                <li class="hover_blue font_monospace">Font monospace</li>
                            </ul>
                        </div>
                    </div>

                    <div class="child_windows file_setting_menu active" style="width: 350px;">
                        <div class="title">
                            <span class="title_icon"></span><span>file setting</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>
                        <div class="title2" style="border-bottom: solid 1px black;">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_content back_silver">
                            <p class="bold large">window files</p>
                            <div class="mini_window">
                                <button class="button2 windowfile1 apply_button2">window file change</button><br>
                                <button class="button2 windowfile2 apply_button2">window file reset</button>
                                <div class="mini_window">
                                    <p>preview</p>
                                    <div class="window_contents border2 pointer_none" style="height: 85px;">
                                        <ul class="black_text window_inline_list" style="width: 100%; height: 100%;">
                                            <div class="window_files">
                                                <li>test</li><span class="window_file_icon"></span>
                                            </div>
                                            <div class="window_files">
                                                <li>test</li><span class="window_file_icon2"></span>
                                            </div>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <p class="bold large">desktop file</p>
                            <button class="button2 apply_button2" onclick="filepositon_reset()">position
                                reset</button>
                        </div>
                    </div>

                    <div class="child_windows file_download_menu active">
                        <div class="title">
                            <span class="title_icon"></span><span>file download</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="border2 window_contents">
                            <p>エクスポート</p>
                            <span id="exportButton" class="button2 apply_button2"
                                style="width: max-content;">ローカルストレージを外部出力</span><br>

                            <div class="mini_window">
                                <p>インポート<br><span class="red_text small">(※今まで編集していたデータは削除されます!)</span></p>
                                <label>
                                    <span class="button2 apply_button"
                                        style="width: max-content;">外部出力したnexserのデータをインポート</span>
                                    <input class="button2" type="file" id="fileInput">
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows debug_menu active">
                        <div class="title">
                            <span class="title_icon"></span><span>debug</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>

                        <div class="mini_window window_content"
                            style="background: black; color: lime; font-family: Courier; font-size: 16px;">
                            <ul>
                                <li>localstorage key:&emsp;<span class="local_keylength"></span></li>
                                <li>
                                    <span>active:&emsp;</span><span class="active_length">0</span>
                                </li>
                                <li>
                                    <span>child_windows:&emsp;</span><span class="child_windows_length">0</span>
                                </li>
                                <li>
                                    <span>window z_index:&emsp;</span><span class="z_index"></span>
                                </li>
                                <li>
                                    <span>title_select:&emsp;</span><span class="title_navy"></span>
                                </li>
                                <li>
                                    <span>saver_time:&emsp;</span><span class="saver_time">none</span>
                                </li>
                                <li>
                                    <span>drag_window:&emsp;</span><span class="drag_window">none</span>
                                </li>
                                <li style="margin-top: 20px;">
                                    <span>cpu cores:&emsp;</span><span class="cpu_cores">none</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="child_windows stopwatch_menu active">
                        <div class="title">
                            <span class="title_icon"></span><span>stop watch</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2" onclick="timerstop(),timerreset()"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="border2 window_contents" style="background: whitesmoke;">
                            <div id="time" style="font-size: 40px; text-align: center;">00:00:00.000</div>
                            <div id="buttons" style="display: flex; justify-content: center;">
                                <input id="start" class="button2 apply_button" type="button" value="start"
                                    style="font-size: 25px; margin: 5px;">
                                <input id="stop" class="button2 apply_button" type="button" value="stop"
                                    style="font-size: 25px; margin: 5px;">
                                <input id="reset" class="button2 apply_button" type="button" value="reset"
                                    style="font-size: 25px; margin: 5px;">
                            </div>
                        </div>
                    </div>


                    <div class="child_windows calendar_menu active">
                        <div class="title">
                            <span class="title_icon"></span><span>calendar</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="medium" style="display: flex;">
                                <button class="button2 borderinline_dotted" onclick="c_prev()">&emsp;old&emsp;</button>
                                <button class="button2 borderinline_dotted" onclick="c_next()">&emsp;next&emsp;</button>
                            </div>
                        </div>

                        <div class="calendar_content border2 window_contents">
                            <div class="wrapper">
                                <h1 id="header"></h1>
                                <div id="calendar"></div>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows cpu_bench_menu back_silver resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>cpu bench<span
                                    class="nexser_title_text"></span></span>
                        </div>
                        <div class="title_buttons cpubuttons" style="display: none;">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2" onclick="cpubench_reset(),cpubench_clear()"></span><br>
                        </div>
                        <div class="title2 cputitle" style="display: none;">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_contents">
                            <div class="cpumenu_1"
                                style="width: 600px; height: 300px; background: linear-gradient(45deg, silver, blue);">
                                <div>
                                    <p class="border2 content_center" style="font-size: 40px;">&nbsp;CPU BENCH&nbsp;
                                    </p>
                                    <span class="large white_text"
                                        style="position: absolute; bottom: 5px; right: 5px;">version
                                        0.1</span>
                                </div>
                            </div>
                            <div class="cpumenu_2" style="width: 700px; height: 370px; display: none;">
                                <p class="x-large white_text" style="background-color: black;">cpu bench</p>
                                <div style="display: flex;">
                                    <canvas id="benchmarkCanvas" style="background: black;" width="700"
                                        height="250"></canvas>
                                </div>
                                <span class="button2 cpurun_btn borderinline_dotted" onclick="cpubench()">&emsp;CPU
                                    BENCH RUN&emsp;</span>
                                <p class="cpu_run_text border"
                                    style="width: auto; height: 20px; background-color: white;">
                                </p>
                                <span class="button2 cpurun_btn_clear pointer_none" onclick="cpubench_clear()">&emsp;CPU
                                    BENCH CLEAR&emsp;</span>
                                <p>cpu bench version: 0.1</p>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows taskbar_setting_menu active">
                        <div class="title">
                            <span class="title_icon"></span><span>taskbar properties</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_content back_silver">


                            <div class="mini_window" style="height: 60px;">
                                <p class="bold">taskbar hover</p>
                                <span class="button2 apply_button" onclick="taskbar_autohide()">auto hide</span>
                                <span class="button2 apply_button" onclick="taskbar_reset()">default</span>
                            </div>

                            <div class="mini_window">
                                <p class="bold large">taskbar</p>
                                <div class="mini_window border2" style="background: whitesmoke;">
                                    <p>clock&emsp;<button class="clock_button button2">off</button></p>
                                    <p>battery&emsp;<button class="battery_button button2">off</button></p>
                                    <p>taskbar position&emsp;<button
                                            class="taskbar_position_button button2">top</button>
                                    </p>
                                    <p>always on top&emsp;<button class="taskbar_zindex_0 button2">off</button>
                                    </p>
                                    <p>taskbar leftbutton&emsp;<button class="taskbar_leftbtn button2">off</button>
                                    </p>
                                    <p>button autoadjustment&emsp;<button
                                            class="taskbarbutton_autoadjustment button2">off</button>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows game_window tetris_menu active back_silver">
                        <div class="title">
                            <span class="title_icon"></span><span>tetris</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2" onclick="tetris_reset()"></span>
                            <span class="minimization_button button2"></span>
                        </div>

                        <div class="window_contents border2 back_silver">
                            <div class="tetris_game">
                                <div class="wrapper-container">
                                    <span class="tetris-container">
                                        <canvas class="stage border2" id="stage" width="250px" height="500px"
                                            style="background-color:black;">
                                        </canvas>
                                        <span class="tetris-panel-container">
                                            <p>ver 1.0</p>
                                            <div style="display: flex; width: 250px;">
                                                <div>
                                                    <canvas id="next" class="line border2" width="130px"
                                                        height="150px"></canvas>
                                                    <span>Tetromino&nbsp;1</span>
                                                </div>
                                                <div>
                                                    <canvas id="next2" class="line border2" width="100px"
                                                        height="100px"></canvas>
                                                    <p>&#8592;Tetromino&nbsp;2</p>
                                                </div>
                                            </div><br>

                                            <p class="medium">スコア:<span id="lines">0</span></p>
                                            <p class="medium">最高スコア(試験的):<span id="lines2">0</span></p>
                                            <p><span id="message"></span><br></p>
                                            <div class="tetris-panel-container-padding"></div>
                                            <table class="tetris-button-panel tetbtn" style="margin-left: 30px;">
                                                <tr class="tetbutton">
                                                    <td id="tetris-rotate-button"
                                                        class="tetris-button tetbtn2 button2 large"
                                                        style="width: 60px; margin-left: 10px;">↻
                                                    </td>
                                                </tr>
                                                <tr class="tetbutton">
                                                    <td id="tetris-move-left-button"
                                                        class="tetris-button tetbtn button2 large" style="width: 60px;">
                                                        ←
                                                    </td>
                                                    <td id="tetris-fall-button"
                                                        class="tetris-button tetbtn button2 large" style="width: 60px;">
                                                        ↓
                                                    </td>
                                                    <td id="tetris-move-right-button"
                                                        class="tetris-button tetbtn button2 large" style="width: 60px;">
                                                        →
                                                    </td>
                                                </tr>
                                            </table>
                                        </span>
                                    </span>
                                </div><br>
                                <span class="button2 borderinline_dotted"
                                    onclick="tetris_start()">&emsp;スタート&emsp;</span>
                                <span class="button2 borderinline_dotted" onclick=" toline()">マス目表示の切り替え</span>
                                <span class="button2 tet_stopbtn pointer_none" onclick="tetris_stop()">一時停止/再開</span>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows game_window bom_menu resize back_silver active">
                        <div class="title">
                            <span class="title_icon"></span><span>main sweeper</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2 bom_close"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span>
                        </div>

                        <div class="window_contents back_silver">
                            <div id="setting">
                                <span class="border">&nbsp;W&nbsp;</span>
                                <input class="border2" type="number" id="w" value="9" min="2" max="50">
                                <span class="border">&nbsp;H&nbsp;</span>
                                <input class="border2" type="number" id="h" value="9" min="2" max="25">
                                <span class="border">&nbsp;B&nbsp;</span>
                                <input class="border2" type="number" id="b" value="10" min="1" max="1250">
                                <span>count:<span class="bombCount">0</span></span>
                            </div>
                            <div id="setting2" style="display: flex;">
                                <div id="btn" class=" button2 apply_button" style="display: block; width: 100px;">
                                    &emsp;スタート&emsp;
                                </div>
                                <span class="border">TIME:&emsp;<span id="bom_time"
                                        class="timers">000</span>&emsp;</span>
                                <span>前回のクリアタイム: <span style="pointer-events: none;"
                                        class="button2 bom_clear_time"></span>秒</span>
                            </div>
                            <div class="bom_stage" style="display: none;">
                                <table class="bom_board" id="board">
                                    <tbody>
                                        <tr>
                                            <td class="bor" style="display: none;"></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <h3 id="result"></h3>
                            </div>
                            <div id="bom_texts">
                                <h3>
                                    &lt;設定&gt;
                                </h3>
                                <p>W: 横のマスの数</p>
                                <p>H: 縦のマスの数</p>
                                <p>B: 爆弾の数</p>
                                <h3>
                                    &lt;操作&gt;
                                </h3>
                                <p>左クリック: マスを開ける</p>
                                <p>右クリック: ☐マークを付ける</p>
                                <p class="bold" style="color: red;">(タッチ操作対応 一部非対応)</p>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows window_nosearch nexser_search_menu resize back_silver active">
                        <div class="title">
                            <span class="title_icon"></span><span>nexser search</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2" onclick="search_clear()"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span>
                        </div>
                        <div class="window_contents back_silver">
                            <div style="display: flex; position: sticky; top: 0px; background-color: silver;">
                                <input type="text" id="myInput" class="border large"
                                    style="width: 90%; margin-top: 10px;" autocomplete="off" onkeyup="nexser_search()"
                                    placeholder="検索したい言葉を入力">
                                <span class="button2 apply_button" style="margin-top: 10px;"
                                    onclick="search_clear()">clear</span>
                            </div>

                            <div class="window_content">
                                <ul id="myUL" style="height: 100%;">
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows game_window othello_menu active">
                        <div class="title">
                            <span class="title_icon"></span><span>othello</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2" onclick="othello_start()"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_content border2">
                            <div class="othello_board othello_board_child" id="othello_board"></div>
                            <button class="button2" onclick="othello_start()">othello_reset & start</button>
                        </div>
                    </div>

                    <div class="child_windows device_menu back_silver work_no active">
                        <div class="title">
                            <span class="title_icon"></span><span>device</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>

                        <div class="window_contents back_silver">
                            <p class="device_text border2"></p><br>
                            <p class="device_text2 border2" id="orientation"></p>
                        </div>
                    </div>

                    <div class="child_windows password_menu back_silver active">
                        <div class="title">
                            <span class="title_icon"></span><span>password set</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>

                        <div class="window_contents back_silver">
                            <form autocomplete="off" method="get" onsubmit="return false;" style="margin-top: 10px;">
                                <input type="password" class="border2 password medium" maxlength="4" autocomplete="off"
                                    placeholder="4 textcount" style="width: 245px;">
                                <input type="submit" class="button2 apply_button" value="登録" onclick="pass_submit()">
                                <button class="button2 apply_button" onclick="pass_reset()">リセット</button>
                            </form>
                            <p>パスワード:&emsp;<span class="passcode">登録していません</span></p>
                        </div>

                    </div>

                    <div class="child_windows omikuji_menu back_silver active" style="width: 250px;">
                        <div class="title">
                            <span class="title_icon"></span><span>omikuji</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>

                        <div class="window_contents back_silver"><br>
                            <span class="apply_button button2 x-large"
                                style="text-align: center; width: 280px; height: 40px;"
                                onclick="drawOmikuji()">おみくじ</span><br><br>
                            <div class="border x-large" style="width: 280px; text-align: center;">
                                <span class="omikuji_text">おみくじを引いてみよう</span>
                            </div>

                        </div>
                    </div>

                    <div class="child_windows localstorage_monitor_menu back_silver active" style="width: 300px;">
                        <div class="title">
                            <span class="title_icon"></span><span>localstorage monitor</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>

                        <div class="window_contents back_silver">
                            <p>残りのローカルストレージ容量<br><span class="local_memory border2"></span>&emsp;<span
                                    class="small button2 borderinline_dotted local_memory_button"
                                    onclick="localmemory_size()">&emsp;残り容量を再計算&emsp;</span></p>
                            <p>使用中のローカルストレージ容量<br><span class="local_memory2 border2"></span>&emsp;</p>
                            <button class="apply_button2 button2 localstorage_details">詳細を見る</button>
                        </div>
                    </div>

                    <div class="child_windows localstorage_details_menu back_silver resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>localstorage details</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>

                        <div class="window_contents back_silver">
                            <p class="x-large bold">Local Storage Details</p>
                            <ul id="localStorageList"></ul>
                            <p class="bold x-large" id="totalSize"></p>
                        </div>
                    </div>

                    <div class="child_windows paint_menu active">
                        <div class="title">
                            <span class="title_icon"></span><span>paint</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"
                                onclick="paint_allclear(),paintcanvas_background()"></span><br>
                        </div>

                        <div class="window_contents back_silver">
                            <canvas class="border2" id="paint_canvas" width="800" height="450"></canvas>
                        </div>
                        <div class="window_bottom large" style="width: 100%;">
                            <button class="button2 borderinline_dotted" onclick="downloadCanvasAsPng()">
                                &nbsp;画像出力&nbsp;</button>
                            <button class="button2 borderinline_dotted"
                                onclick="eraser()">&nbsp;消しゴム　/　描き&nbsp;</button>
                            <button class="button2 borderinline_dotted"
                                onclick="paint_allclear(),paintcanvas_background()">&nbsp;全削除&nbsp;</button>
                            <span>&emsp;線の色:&nbsp;</span>
                            <select id="paint_selectcolor" class="button2">
                                <option value="black">black</option>
                                <option value="white">white</option>
                                <option value="blue">blue</option>
                                <option value="red">red</option>
                                <option value="yellow">yellow</option>
                                <option value="green">green</option>
                                <option value="purple">purple</option>
                                <option value="lime">lime</option>
                                <option value="skyblue">skyblue</option>
                                <option value="pink">pink</option>
                                <option value="orange">orange</option>
                            </select>
                            <span style="position: absolute; right: 25px;">モード:&emsp;<span
                                    class="draw_mode">描き</span></span>
                            <div style="display: flex;">
                                <p>線の太さ:&nbsp;</p>
                                <textarea class="paint_width large border2"
                                    style="margin-top: 4px; height: 20px;"></textarea>
                                <button class="button2 borderinline_dotted"
                                    onclick="changeLineWidth()">&nbsp;変更&nbsp;</button>

                                <textarea class="paint_text medium border2" style="margin-top: 4px; height: 16px;"
                                    placeholder="表示する文字の入力"></textarea>
                                <button class="button2 borderinline_dotted"
                                    onclick="paintcanvas_text()">キャンバスに文字を表示</button>
                            </div>
                            <div style="display: flex;">
                                <textarea class="paint_filename medium border2"
                                    style="margin-top: 4px; height: 16px; width: 200px;"
                                    placeholder="保存するファイル名の入力"></textarea>
                                <button class="button2 borderinline_dotted" onclick="
                                    canvasdata_file()">&emsp;出力&emsp;</button>
                                <label>
                                    <span class="button2 borderinline_dotted">&emsp;インポート&emsp;</span><input
                                        class="button2" type="file" id="fileInput" onchange="paintfiles(this)"
                                        style="display: none;">
                                </label>
                                </form>

                                <textarea class="paint_background border2 medium"
                                    style="margin-top: 4px; height: 16px; width: 200px;"
                                    placeholder="color code"></textarea><button class="button2 borderinline_dotted"
                                    onclick="paintcanvas_background()">背景色の変更</button>

                            </div>
                        </div>
                    </div>

                    <div class="child_windows nexser_files_menu resize back_silver active">
                        <div class="title">
                            <span class="title_icon"></span><span>nexser files text</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2" onclick="nexser_files_output_remove()"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>

                        <div class="window_contents border2 back_silver">
                            <div id="nexser_files_output"></div>
                        </div>
                    </div>

                    <div class="child_windows url_droplist_menu resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>url droplist</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>

                        <div id="urllist_dropzone" class="window_contents border2">
                            <ul id="buttonContainer" class="url_droplist_area"
                                style="display: inline-flex;flex-wrap: wrap;">
                            </ul>
                        </div>
                        <div class="window_bottom" style="position: relative;">
                            <p class="button2" onclick="savebtn_deletemode()">Delete</p>
                            <p>&emsp;Delete mode:<span id="del_mode">Off</span></p>
                            <p>&emsp;URL: <span class="border2" id="saveurl"></span></p>
                        </div>
                    </div>

                    <div class="child_windows game_window memory_game_menu resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>memory game</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2" onclick="resetGame()"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>

                        <div class="window_contents" style="background: green;">
                            <button class="start_card button2 borderinline_dotted"
                                style="font-size: xx-large; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"
                                onclick="card_board_start()">&emsp;START&emsp;</button>
                            <div id="game-board"></div>
                            <p class="x-large white_text" id="game_board_text" style="text-align: center;"></p>
                        </div>
                        <div class="window_bottom" style="display: flex;">
                            <p style="width: 100%;">揃ったペアの数:&nbsp;<span id="match-count">0</span>
                                <span class="button2 apply_button" style="margin-left: 10px;"
                                    onclick="resetGame()">reset</span>
                                <span style="position: absolute; bottom: 0; right: 0;">経過時間:
                                    <span id="elapsed-time">0</span>秒</span>
                            </p>
                        </div>
                    </div>

                    <div class="child_windows alarm_menu back_silver active">
                        <div class="title">
                            <span class="title_icon"></span><span>alarm</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>

                        <div class="window_contents back_silver">
                            <div id="timerText" class="xx-large">00:00:00</div>
                            <form name="alarm_form">
                                <p class="time_text large">アラーム: <select name="option_hours" class="border medium">
                                        <option value="0">00</option>
                                        <option value="1">01</option>
                                        <option value="2">02</option>
                                        <option value="3">03</option>
                                        <option value="4">04</option>
                                        <option value="5">05</option>
                                        <option value="6">06</option>
                                        <option value="7">07</option>
                                        <option value="8">08</option>
                                        <option value="9">09</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="13">13</option>
                                        <option value="14">14</option>
                                        <option value="15">15</option>
                                        <option value="16">16</option>
                                        <option value="17">17</option>
                                        <option value="18">18</option>
                                        <option value="19">19</option>
                                        <option value="20">20</option>
                                        <option value="21">21</option>
                                        <option value="22">22</option>
                                        <option value="23">23</option>
                                    </select>
                                    <select name="option_minutes" class="border medium">
                                        <option value="0">00</option>
                                        <option value="1">01</option>
                                        <option value="2">02</option>
                                        <option value="3">03</option>
                                        <option value="4">04</option>
                                        <option value="5">05</option>
                                        <option value="6">06</option>
                                        <option value="7">07</option>
                                        <option value="8">08</option>
                                        <option value="9">09</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="13">13</option>
                                        <option value="14">14</option>
                                        <option value="15">15</option>
                                        <option value="16">16</option>
                                        <option value="17">17</option>
                                        <option value="18">18</option>
                                        <option value="19">19</option>
                                        <option value="20">20</option>
                                        <option value="21">21</option>
                                        <option value="22">22</option>
                                        <option value="23">23</option>
                                        <option value="24">24</option>
                                        <option value="25">25</option>
                                        <option value="26">26</option>
                                        <option value="27">27</option>
                                        <option value="28">28</option>
                                        <option value="29">29</option>
                                        <option value="30">30</option>
                                        <option value="31">31</option>
                                        <option value="32">32</option>
                                        <option value="33">33</option>
                                        <option value="34">34</option>
                                        <option value="35">35</option>
                                        <option value="36">36</option>
                                        <option value="37">37</option>
                                        <option value="38">38</option>
                                        <option value="39">39</option>
                                        <option value="40">40</option>
                                        <option value="41">41</option>
                                        <option value="42">42</option>
                                        <option value="43">43</option>
                                        <option value="44">44</option>
                                        <option value="45">45</option>
                                        <option value="46">46</option>
                                        <option value="47">47</option>
                                        <option value="48">48</option>
                                        <option value="49">49</option>
                                        <option value="50">50</option>
                                        <option value="51">51</option>
                                        <option value="52">52</option>
                                        <option value="53">53</option>
                                        <option value="54">54</option>
                                        <option value="55">55</option>
                                        <option value="56">56</option>
                                        <option value="57">57</option>
                                        <option value="58">58</option>
                                        <option value="59">59</option>
                                    </select> <span class="time_btn button2" id="set_btn">設定</span>
                                </p>
                            </form>
                            <div class="container">
                                <p>アラーム設定時刻</p>
                                <ul id="parent_list" class="border2">
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows window_nosearch test_site_menu resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>test site</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span>
                        </div>

                        <div class="window_content" style="width: 100%; height: 100%;">
                            <iframe src="indexfiles/index.html" class="site_frame" style="width: 100%; height: 100%;"
                                frameborder="0" loading="lazy"></iframe>
                        </div>
                    </div>

                    <div class="child_windows kakeibo_menu resize back_silver active">
                        <div class="title">
                            <span class="title_icon"></span><span>kakeibo</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>

                        <div class="window_contents back_silver large">
                            <span class="x-large bold border2">家計簿</span>
                            <div class="input-group">
                                <label for="type">タイプ:</label>
                                <select id="type" class="button2 medium back_silver">
                                    <option value="収入">収入</option>
                                    <option value="支出">支出</option>
                                </select>
                            </div>
                            <div class="input-group border">
                                <label for="amount">金額:</label>
                                <input type="number" id="amount" class="border2 large" placeholder="金額を入力">
                            </div>
                            <div class="input-group border">
                                <label for="description">内容:</label>
                                <textarea id="description" class="border2 large resize_none" style="width: 600px;"
                                    placeholder="内容を入力"></textarea>
                            </div>
                            <div class="input-group border">
                                <label for="date" class="border">日付:</label>
                                <input type="date" id="kakeibo_date" class="border2 large">
                            </div>
                            <div class="input-group border">
                                <label for="time" class="border">時間:</label>
                                <input type="time" id="kakeibo_time" class="border2 large">
                            </div>
                            <button onclick="kakeibo_addEntry()" class="button2 medium">追加</button>
                            <div class="x-large">合計:<span class="total" id="total"></span></div>
                            <div id="entries" class="border"></div>
                        </div>
                    </div>

                    <div class="child_windows nexser_nextversion_menu resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>nexser nextversion</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>

                        <div class="window_content" style="height: 100%; width: 100%;">
                            <iframe class="nexser_nextframe" style="height: 100%; width: 100%;"
                                src="https://moti5768.github.io/nexser/nexser_pc_beta/nexser.html" frameborder="0"
                                loading="lazy"></iframe>
                        </div>
                    </div>

                    <div class="child_windows mydocument_menu file_windows resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>my document</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;window&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="window_half_big">window half big</li>
                                        <li class="windowsize_reset">window size reset</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;view&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="allwindow_toolbar">allwindow toolbar</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;使い方&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li>他のウィンドウ内にあるファイルをドロップしてください。</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_tool">

                            <div class="windowtool_buttons">
                                <div class="windowtool_buttons_child">
                                </div>
                            </div>

                        </div>
                        <div class="window_contents border2" id="drop_zone">
                            <ul class="window_inline_list"></ul>
                        </div>
                    </div>

                    <div class="child_windows restriction_menu work_no back_silver active">
                        <div class="title">
                            <span class="title_icon"></span><span>restriction properties</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>

                        <div class="window_contents back_silver">
                            <p class=" border2">ゲームの制限</p>
                            <div style="display: inline-flex;" style="margin-top: 10px;">
                                <span class="button2 apply_button" onclick="game_true()">ON</span>
                                <span class="button2 apply_button" onclick="game_false()">OFF</span>
                            </div>
                            <div class="window_bottom">
                                <p class="border" style="margin-top: 10px; display: inline;">MODE:<span
                                        class="game_text">OFF</span></p>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows location_menu work_no active">
                        <div class="title">
                            <span class="title_icon"></span><span>location</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>

                        <div class="window_content back_silver">
                            <p id="location">位置情報は無効化されています。</p>
                            <button class="button2 borderinline_dotted"
                                onclick="poti_btn()">&emsp;位置情報の取得(WiFi必須)&emsp;</button>
                        </div>
                    </div>


                    <div class="child_windows systemresouce_menu active">
                        <div class="title">
                            <span class="title_icon"></span><span>system resouce</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>
                        <div class="window_content back_silver">
                            <h2>描画リソース負荷</h2>
                            <div id="resultArea" style="width: 700px; height: 100px;"></div>
                        </div>
                    </div>


                    <div class="child_windows trash_menu file_windows resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>trash</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;window&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="window_half_big">window half big</li>
                                        <li class="windowsize_reset">window size reset</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;view&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="allwindow_toolbar">allwindow toolbar</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;使い方&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li>デスクトップにあるファイルをゴミ箱へドロップしてください。</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_tool">

                            <div class="windowtool_buttons">
                                <div class="windowtool_buttons_child">
                                </div>
                            </div>

                        </div>
                        <div class="window_contents border2" id="trash_drop_zone">
                            <ul class="window_inline_list trash_list"></ul>
                        </div>
                    </div>

                    <div class="child_windows editor_menu resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>editor</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;window&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="window_half_big">window half big</li>
                                        <li class="windowsize_reset">window size reset</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_tool_2 editor_tool">
                            <span class="winchild_border"></span>
                            <button class="button2" onclick="saveContent()">Save</button>
                            <button class="button2" onclick="execCmd('selectAll')">Select All</button>
                            <button class="button2" onclick="editorContent_load()">Load Data</button>
                            <button class="button2 large" onclick="execCmd('undo')">&nbsp;&#8634;&nbsp;</button>
                            <button class="button2 large" onclick="execCmd('redo')">&nbsp;&#8635;&nbsp;</button>
                            <button class="button2" onclick="execCmd('cut')">Cut</button>
                            <button class="button2 bold" onclick="execCmd('bold')">&nbsp;B&nbsp;</button>
                            <button class="button2" style="font-style: italic;"
                                onclick="execCmd('italic')">&nbsp;A&nbsp;</button>
                            <button class="button2" onclick="execCmd('underline')">&nbsp;<span
                                    class="underline">U</span>&nbsp;</button>
                            <button class="button2" onclick="toggleDecoration()">&nbsp;<span
                                    style="border: solid 2px black;">&nbsp;A&nbsp;</span>&nbsp;</button>
                            <button class="button2" onclick="toggleShadows()"
                                style="text-shadow: 3px 3px 0px dimgray;">&emsp;A&emsp;</button>
                            <button class="button2" onclick="toggleBoxShadow()">&emsp;<span
                                    style="border: solid 1px black; box-shadow: 3px 3px dimgray;">&nbsp;&nbsp;&nbsp;</span>&emsp;</button>
                            <button class="button2 large" onclick="execCmd('justifyLeft')">&#8801;&nbsp;&nbsp;</button>
                            <button class="button2 large"
                                onclick="execCmd('justifyCenter')">&nbsp;&#8801;&nbsp;</button>
                            <button class="button2 large" onclick="execCmd('justifyRight')">&nbsp;&nbsp;&#8801;</button>
                            <select class="border2" id="fontSizeSelect" onchange="changeFontSize(this.value)">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5" selected>5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                            </select>
                            <input class="button2" style="width: 25px;" type="color"
                                onchange="execCmd('foreColor', this.value)" onclick="execCmd('foreColor', this.value)"
                                id="editor_textColor" title="Text Color"><span style="color: red;">A</span>
                            <input class="button2" style="width: 25px;" type="color"
                                onclick="execCmd('hiliteColor', this.value)" id="editor_bgColor"
                                title="Background Color"><span style="background: red; color: white;">A</span>
                            <button class="button2 medium" style="rotate: 90deg;"
                                id="colorPickerButton">&nbsp;&#9999;&nbsp;</button>
                            <button class="button2" id="colorPanelContainer" style="width: 20px; height: 20px;">
                            </button>
                            <button class="button2"
                                onclick="execCmd('createLink', prompt('Enter URL:', 'http://'))">Link</button>
                            <button class="button2"
                                onclick="execCmd('insertImage', prompt('Enter image URL:', 'http://'))">Image</button>
                            <button class="button2" onclick="printDiv('editor_2')">Print</button>
                            <button class="button2" onclick="exportToHTML()">Export HTML</button>

                            <div class="color_panel_parent border" style="background-color: #C3C7CB;">
                                <p class="cpc2">最近使用した色</p>
                                <div class="color_panel_child">
                                    <div class="recent-colors-section">
                                        <span class="label small">文字色</span>
                                        <div class="recent-colors" id="recentTextColors"></div>
                                    </div>
                                    <div class="recent-colors-section">
                                        <span class="label small">背景色</span>
                                        <div class="recent-colors" id="recentBgColors"></div>
                                    </div>
                                </div>
                                <div class="button2" style="position: absolute; left: 105px; top: -1.5px;">
                                    <p style="transform: rotate(90deg);">&nbsp;&#x25BC;&nbsp;</p>
                                </div>
                            </div>
                        </div>
                        <div class="window_content border2"
                            style="background-color: white; height: 100%; width: 100%; overflow: hidden;">
                            <div id="editor_2" contenteditable="true"
                                style="height: calc(100% - 85px); width: calc(100% - 5px);"></div>
                        </div>
                    </div>

                    <div class="child_windows add_program_menu back_silver resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>add programs</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>

                        <div class="window_contents back_silver">
                            <div>
                                <label>
                                    <span class="button2 apply_button"
                                        style="width: max-content;">&emsp;プログラムの追加&emsp;</span>
                                    <input type="file" id="file-input"
                                        onchange="restoreFromNex(document.getElementById('file-input'))">
                                </label>
                                <button class="button2 borderinline_dotted medium addbtn_program pointer_none"
                                    onclick="addprogram_window()">&emsp;実行&emsp;</button>
                            </div>
                            <p class="large">読み込まれたファイル:</p>
                            <p class="large bold">名前:&nbsp;<span id="filename"></span></p>
                            <p class="large bold">容量:&nbsp;<span id="restored-output"></span></p>
                        </div>
                    </div>

                    <div class="child_windows nexser_guidebook_menu resize active">
                        <div class="title">
                            <span class="title_icon"></span><span>nexser guidebook</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span>
                            <span class="bigminbtn button2"></span>
                            <span class="minimization_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;window&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="window_half_big">window half big</li>
                                        <li class="windowsize_reset">window size reset</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_contents border2">
                            <p class="underline red_text xx-large" style="font-style: italic;">Welcome
                                Nexser
                                Guidebook
                            </p>
                            <p class="large bold">Nexser Guidebookへようこそ!</p>
                            <p>Nexser Guidebookはウィンドウ・ファイル・スタートメニュー・<br>タスクバーの使い方をサポートします。</p>

                            <div class="mini_window">
                                <p class="bold">目次(以下をクリックしてください)</p>
                                <ul style="color: purple;">
                                    <li class="hover_blue guidebook_window" style="cursor: pointer;">
                                        1.ウィンドウ
                                    </li>
                                    <li class="hover_blue guidebook_file" style="cursor: pointer;">
                                        2.ファイル
                                    </li>
                                    <li class="hover_blue guidebook_taskbar" style="cursor: pointer;">
                                        3.タスクバー</li>
                                </ul>
                            </div>
                        </div>
                    </div>


                    <div class="child_windows guidebook_window_menu guide_window active">
                        <div class="title">
                            <span class="title_icon"></span><span>guidebook window</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_contents border2">
                            <div class="mini_window_left_screen" style="pointer-events: none;">

                                <div class="mini_windows_sample">
                                    <div class="title" style="background-color: navy;">
                                        <span class="title_icon"></span><span>test</span>
                                    </div>

                                    <div class="title_buttons">
                                        <span class="close_button button2"></span>
                                        <span class="bigminbtn button2"></span>
                                        <span class="minimization_button button2"></span><br>
                                    </div>

                                    <div class="title2">
                                        <div class="parent_list">
                                            <ul>
                                                <li>&emsp;icon&emsp;</li>
                                            </ul>
                                        </div>
                                        <div class="parent_list">
                                            <ul>
                                                <li>&emsp;window&emsp;</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="border2 window_contents" style="height: 250px;">
                                        <p>test window</p>
                                    </div>

                                </div>

                            </div>
                            <div class="mini_window_left_content">
                                <p class="x-large bold underline">window</p>
                                <p>画面左下の [スタートボタン] をクリックして、スタートメニューを表示します。</p>
                                <p class="x-large bold underline">title buttons</p>
                                <ul style="pointer-events: none;">
                                    <li><span class="close_button button2"
                                            style="position: absolute; left: 5px; top: 125px; width: 19px; height: 19px;"></span>&emsp;&emsp;ボタンでウィンドウを閉じることができます。
                                    </li>
                                    <li style="margin-top: 10px;"><span class="bigminbtn button2"
                                            style="position: absolute; left: 5px; top: 160px; width: 19px; height: 19px;"></span>&emsp;&emsp;ボタンでウィンドウの最大化をすることができます。
                                    </li>
                                    <li style="margin-top: 10px;"><span class="minbtn button2"
                                            style="display: block; position: absolute; left: 5px; top: 220px; width: 19px; height: 19px;"></span>&emsp;&emsp;ボタンでウィンドウの縮小化をすることができます。
                                    </li>
                                    <li style="margin-top: 10px;"><span class="minimization_button button2"
                                            style="position: absolute; left: 5px; top: 275px; width: 19px; height: 19px;"></span>&emsp;&emsp;ボタンでウィンドウの最小化をすることができます。
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows guidebook_file_menu guide_window active">
                        <div class="title">
                            <span class="title_icon"></span><span>guidebook file</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_contents border2">
                            <div class="mini_window_left_screen">
                                <ul style="padding-top: 15px; pointer-events: none;">
                                    <div class="desktop_files test_button parentss">
                                        <li class="desktop_files_text">main</li>
                                        <span class="dli-folder"></span>
                                    </div>
                                    <div class="desktop_files test_button parentss">
                                        <li class="desktop_files_text">my_computer</li>
                                        <span class="dli-folder"></span>
                                    </div>
                                    <div class="desktop_files test_button parentss">
                                        <li class="desktop_files_text">control_panel</li>
                                        <span class="dli-folder"></span>
                                    </div>
                                    <div class="desktop_files test_button parentss">
                                        <li class="desktop_files_text">accessory</li>
                                        <span class="dli-folder"></span>
                                    </div>
                                </ul>
                            </div>
                            <div class="mini_window_left_content">
                                <p class="x-large bold underline">file</p>
                                <p>デスクトップに表示されている[ファイル]から指定のウィンドウを開くことができます。
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="child_windows guidebook_taskbar_menu guide_window active">
                        <div class="title">
                            <span class="title_icon"></span><span>guidebook taskbar</span>
                        </div>
                        <div class="title_buttons">
                            <span class="drag_button">&nbsp;</span>
                            <span class="close_button button2"></span><br>
                        </div>
                        <div class="title2">
                            <div class="parent_list">
                                <ul>
                                    <li>&emsp;icon&emsp;</li>
                                </ul>
                                <div class="child_list">
                                    <ul>
                                        <li class="logoff">Logoff</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="window_contents border2">
                            <div class="mini_window_left_screen">
                                <div class="mini_window_taskbar">
                                    <span class="button border bold"
                                        style="position: absolute; bottom: 2px; left: 2px; pointer-events: none;">&nbsp;Start&nbsp;</span>

                                    <div class="mini_window_startmenu">
                                        <ul>
                                            <li
                                                style="font-size: 20px; background-color:dimgray; color:silver; font-weight: bold; writing-mode: vertical-rl; transform: rotate(180deg); height: 100%; width: 25px; position: absolute;">
                                                &nbsp;nexser&nbsp;<span style="color: white;">1.9</span></li>
                                            <div style="position: absolute; left: 30px; width: 100%;">
                                                <p class="small"
                                                    style="display:block; width: 125px; position: absolute; left: -5px; background: rgb(177, 39, 26); color: white;">
                                                    guidebook</p><br>
                                                <p>my document</p>
                                                <p>programs</p>
                                                <p>main</p>
                                                <p>games</p>
                                                <p>entertainment</p>
                                                <p>setting</p>
                                                <p>test</p><br>
                                                <p>start options</p>
                                                <p>Logoff</p>
                                            </div>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="mini_window_left_content">
                                <p class="x-large bold underline">taskbar</p>
                                <p>画面左下の [スタートボタン] をクリックして、スタートメニューを表示します。</p>
                                <p class="x-large bold underline">start menu</p>
                                <p>マイコンピュータ・コントロールパネル・設定やサウンド・背景色など様々な自分好みにカスタマイズができます。</p>
                            </div>
                        </div>
                    </div>

                </div>

                <div id="taskbar_group">
                    <div id="taskbar">
                        <div id="task_resizer"></div>
                        <div id="task_resizer2"></div>
                        <span id="startbtn" class="start_button bold">&nbsp;Start&nbsp;</span>
                        <div class="first_taskbar_buttons">
                            <span class="button2 test_button33">Brs</span>
                            <span class="button2 test_button35">Tsk</span>
                        </div>

                        <div class="taskbar_buttons">
                            <div class="task_icons" id="task_buttons2">
                            </div>
                        </div>
                        <div class="taskbar_rightgroup">
                            <div class="screen_light_range">
                                <span class="button lit_button" onclick="lightchild()">&nbsp;LIT&nbsp;</span>
                                <div class="screen_light_range_child border">
                                    <input type="range" id="opacitySlider" min="0" max="100" value="100">
                                    <span id="valueDisplay"
                                        style="position: absolute; right: 0px; margin-top: 2.5px; margin-right: 4px;">100</span>
                                </div>
                            </div>
                            <div class="inport_icon">
                                <span>&nbsp;N&nbsp;</span>
                            </div>
                            <div>
                                <li class="task_battery"><span class="battery_child button">
                                        <p>BATTERY:<span class="taskbattery"></span>%</p>
                                    </span>
                                </li>
                                <div class="battery_menu" style="font-size:large;">
                                    <span class="battery_time border">none</span>
                                </div>
                            </div>

                            <div class="time">
                                <li><span class="test_button7 button2 date_clock">CLOCK</span></li>
                            </div>
                        </div>
                    </div>

                    <div class="start_menu border" id="start_menu">
                        <p
                            style="font-size: 20px; background-color: dimgray; color: silver; font-weight: bold; writing-mode: vertical-rl; transform: rotate(180deg); height: 100%; width: 25px; position: absolute;">
                            &nbsp;nexser&nbsp;<span style="color: white;">1.9</span></p>
                        <ul style="margin-left: 25px;">
                            <li class="nexser_guidebook">guidebook</li>
                            <li class="document_button">my document</li>

                            <li>programs
                                <ul class="submenu">
                                    <li>accessory
                                        <ul class="submenu">

                                            <li>games
                                                <ul class="submenu">
                                                    <li class="test_button34">main sweeper</li>
                                                    <li class="test_button29">tetris</li>
                                                    <li class="test_button41">othello</li>
                                                    <li class="test_button44">memory game</li>
                                                </ul>
                                            </li>

                                            <li class="test_button7">clock</li>
                                            <li class="test_button16">calc</li>
                                            <li class="test_button12">notepad</li>
                                            <li class="test_button13">text drop</li>
                                            <li class="test_button18">camera</li>
                                            <li class="test_button19">htmlviewer edit</li>
                                            <li class="test_button48">url droplist</li>
                                            <li class="test_button25">file download</li>
                                        </ul>
                                    </li>
                                    <li class="test_button24">debug</li>
                                    <li class="test_button5">system properties</li>
                                </ul>
                            </li>

                            <li>main
                                <ul class="submenu">
                                    <li class="test_button6">nexser prompt</li>
                                    <li class="test_button3">control panel</li>
                                </ul>
                            </li>

                            <li>multimedia
                                <ul class="submenu">
                                    <li>sounds
                                        <ul class="submenu">
                                            <li class="test_button8">sound</li>
                                            <li class="test_button17">nexser sound</li>
                                        </ul>
                                    </li>

                                    <li>display
                                        <ul class="submenu">
                                            <li class="test_button4">color property</li>
                                            <li class="test_button11">screen text</li>
                                        </ul>
                                    </li>

                                </ul>
                            </li>

                            <li>others
                                <ul class="submenu">
                                    <li class="test_button9">driver</li>
                                    <li class="test_button10">mouse</li>
                                    <li class="test_button22">font</li>
                                    <li class="nexser_search">nexser search</li>
                                </ul>
                            </li>

                            <li>system
                                <ul class="submenu">
                                    <li class="test_button37">device</li>
                                </ul>
                            </li>

                            <li>user
                                <ul class="submenu">
                                    <li>setting
                                        <ul class="submenu">
                                            <li class="test_button23">file setting</li>
                                            <li class="test_button35">taskbar properties</li>
                                        </ul>
                                    </li>
                                    <li>security
                                        <ul class="submenu">
                                            <li class="passmenu_button">password set</li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>

                            <li>entertainment
                                <ul class="submenu">
                                    <li onclick="welcome()">welcome nexser</li>
                                </ul>
                            </li><br>

                            <li>start options
                                <ul class="submenu">
                                    <li class="restart">nexser restart</li>
                                    <li class="deskprompt" onclick="nexser_program_open()">nexser program</li>
                                    <li onclick="nexser_signout()">signout</li>
                                </ul>
                            </li>

                            <li class="logoff">Logoff<span class="power_supply"
                                    style="position: absolute; bottom: 8px; right: 10px;"></span></li>
                        </ul>
                    </div>


                </div>

                <div id="toolbar">
                    <div style="margin-top: 2px; margin-left: 1px;">
                        <div>
                            <span class="drag_button2 border2" style="cursor: all-scroll;">&emsp;&nbsp;</span>
                            <span class="button2 nexser_search">&nbsp;<span class="magnifying_glass"></span>
                            </span>
                            <span class="button2 test_button26">&nbsp;D&nbsp;</span>
                            <span class="button2">&nbsp;T&nbsp;</span>
                            <span class="button2">&nbsp;T&nbsp;</span>
                            <span class="button2">&nbsp;T&nbsp;</span>
                        </div>
                    </div>
                </div>

                <div id="screen_saver_group">

                    <div class="screen_saver1">
                        <p style="font-size: 30px; position: absolute; bottom: 0; right: 10px;">nexser screensaver
                        </p>
                    </div>

                    <div class="screen_saver2">
                        <p style="font-size: 30px; position: absolute; bottom: 0; right: 10px;">nexser screensaver
                        </p>
                    </div>

                    <div class="screen_saver3">
                        <p class="saver_text x-large"
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            nexser
                            screensaver</p>
                    </div>
                </div>

            </div>

        </div>

    </div>

</body>

<script src="nexser_scripts/nexser.js" defer></script>
<script src="nexser_scripts/nexser_sounds.js" defer></script>
<script src="nexser_scripts/tetris.js"></script>
<script src="nexser_scripts/bom.js"></script>

</html>
